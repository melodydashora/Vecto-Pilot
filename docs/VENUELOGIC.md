# VENUELOGIC.md

> **Created:** 2026-01-10
> **Purpose:** Complete audit of venue_catalog field population sources

## Overview

This document traces EVERY field in `venue_catalog` back to the code that populates it. Created after discovering incomplete/inaccurate field source information.

---

## Sample Venue Record (address_resolver source)

```json
{
  "venue_id": "17ac3769-c240-4862-843a-d093921568a3",
  "place_id": "ChIJ19gMil47TIYRXw2rIwrofWI",
  "venue_name": "The Westin Dallas Stonebriar Golf Resort & Spa",
  "address": "1549 Legacy Dr, Frisco, TX 75034, USA",
  "lat": 33.091722,
  "lng": -96.841493,
  "category": "venue",
  "staging_notes": null,
  "city": "Frisco",
  "metro": null,
  "ai_estimated_hours": null,
  "business_hours": null,
  "discovery_source": "address_resolver",
  "dayparts": null,
  "district": null,
  "district_slug": null,
  "expense_rank": null,
  "hours_full_week": null,
  "crowd_level": null,
  "rideshare_potential": null,
  "hours_source": null,
  "capacity_estimate": null,
  "source_model": null,
  "market_slug": null,
  "venue_types": [],
  "coord_key": "33.091980_-96.824880",
  "normalized_name": "westin stonebriar golf resort and spa",
  "source": "google_places_new",
  "access_count": 3
}
```

---

## Complete Field Source Audit

### Fields Populated by `venue-address-resolver.js`

| Field | Source Code | Line # |
|-------|-------------|--------|
| `venue_id` | Auto-generated by DB | - |
| `place_id` | `placeResult.placeId` from `searchPlaceWithTextSearch()` | 93, 214, 329 |
| `venue_name` | `placeResult.displayName` or caller's venueName | 92, 318 |
| `address` | `venue.formatted_address` | 319 |
| `lat` / `lng` | From caller or `placeResult.lat/lng` | 320-321 |
| `category` | **HARDCODED** as `'venue'` | 332 |
| `city` | `parseAddressComponents()` | 322 |
| `state` | `parseAddressComponents()` | 323 |
| `zip` | `parseAddressComponents()` | 324 |
| `country` | `parseAddressComponents()` or default `'US'` | 326 |
| `formatted_address` | `placeResult.formattedAddress` | 327 |
| `address_1` | `parseAddressComponents()` | 328 |
| `coord_key` | `generateCoordKey(lat, lng)` from venue-utils.js | 330 |
| `normalized_name` | `normalizeVenueName()` from venue-utils.js | 331 |
| `source` | **HARDCODED** as `'google_places_new'` or `'geocoding'` | 100, 115, 134 |
| `discovery_source` | **HARDCODED** as `'address_resolver'` | 334 |
| `access_count` | Set to 1 on insert, incremented on access | 335, 310 |
| `last_accessed_at` | `new Date()` | 336 |
| `updated_at` | `new Date()` | 337 |

**NOT SET by venue-address-resolver.js:**
- venue_types (empty array by default)
- All bar-specific fields
- All enrichment fields

---

### Fields Populated by `venue-intelligence.js` (Bar Tab Discovery)

| Field | Source Code | Line # |
|-------|-------------|--------|
| `expense_rank` | `price.rank` from Google Places priceLevel | 328 |
| `crowd_level` | Calculated from `place.rating` | 338 |
| `rideshare_potential` | Calculated from `price.rank` | 339 |
| `venue_types` | Set to venueType array (e.g., `['bar']`) | 620, 649 |
| `district` | `extractDistrictFromVenueName()` | 605, 622, 654 |
| `district_slug` | `normalizeDistrictSlug()` | 606 |

**Logic for crowd_level (line 338):**
```javascript
crowd_level: place.rating >= 4.5 ? 'high' : place.rating >= 4 ? 'medium' : 'low'
```

**Logic for rideshare_potential (line 339):**
```javascript
rideshare_potential: price.rank >= 3 ? 'high' : price.rank >= 2 ? 'medium' : 'low'
```

---

### Fields Populated by `venue-cache.js` (insertVenue / upsertVenue)

| Field | Source Code | Line # |
|-------|-------------|--------|
| `venue_name` | `venue.venueName` | 181 |
| `normalized_name` | `normalizeVenueName(venue.venueName)` | 169 |
| `address` | `venue.address` or `venue.formattedAddress` | 183 |
| `city` / `state` / `zip` | From venue object | 184-186 |
| `country` | `venue.country` or `'US'` | 188 |
| `lat` / `lng` | From venue object | 189-190 |
| `coord_key` | `generateCoordKey(venue.lat, venue.lng)` | 170, 191 |
| `formatted_address` | `venue.formattedAddress` | 192 |
| `place_id` | `venue.placeId` | 193 |
| `business_hours` | `venue.hours` | 194 |
| `hours_full_week` | `venue.hoursFullWeek` | 195 |
| `hours_source` | `venue.hoursSource` | 196 |
| `venue_types` | `venue.venueTypes` or `[venue.venueType]` or `['venue']` | 173-174, 197 |
| `category` | `venue.category` or `venue.venueType` or `'venue'` | 198 |
| `capacity_estimate` | `venue.capacityEstimate` | 199 |
| `source` | `venue.source` | 200 |
| `source_model` | `venue.sourceModel` | 201 |
| `expense_rank` | `venue.expenseRank` | 202 |
| `discovery_source` | `venue.source` | 203 |
| `district` | `venue.district` or `extractDistrictFromVenueName()` | 177, 204 |
| `district_slug` | `normalizeDistrictSlug(district)` | 178, 205 |

---

### Fields Populated by `coach-dal.js` (AI Coach Writes)

| Field | Source Code | Line # |
|-------|-------------|--------|
| `staging_notes` | AI Coach venue intel contributions | 1886, 1916, 1939, 1973 |
| `dayparts` | AI Coach venue intel contributions | 1885, 1938 |
| `ai_estimated_hours` | AI Coach venue intel contributions | 1890, 1917, 1944 |
| `market_slug` | AI Coach market context | 1833, 2028 |

**AI Coach staging_notes merge logic (line 1973):**
```javascript
staging_notes: sql`COALESCE(${venue_catalog.staging_notes}, '{}')::jsonb || ${JSON.stringify(stagingNotes)}::jsonb`
```

---

### Fields Populated by `seed-dfw-venues.js` (Manual Seed Data)

| Field | Example Value | Line # |
|-------|---------------|--------|
| `staging_notes` | `{ optimal_spot: "...", gps_notes: "..." }` | 12, 27, 42... |
| `metro` | `"Dallas-Fort Worth"` | 18, 33, 48... |
| `ai_estimated_hours` | `"24/7"` or `"Mon-Sun: 10am-10pm"` | 19, 34, 49... |

**Example staging_notes structure:**
```javascript
staging_notes: {
  optimal_spot: "Cell phone lot or Terminal B departures",
  gps_notes: "Strong signal throughout",
  pickup_tips: "Use Terminal B for short waits"
}
```

---

### Fields Populated by `enhanced-smart-blocks.js` (SmartBlocks Enrichment)

| Field | Source Code | Line # |
|-------|-------------|--------|
| `business_hours` | `enriched.businessHours` from Google Places | 208 |

---

### Fields Populated by `district-detection.js`

| Field | Source Code | Line # |
|-------|-------------|--------|
| `district` | `updateVenueDistrict()` | 201, 207 |
| `district_slug` | `normalizeDistrictSlug(district)` | 206 |
| `district_centroid_lat` | `centroid.lat` | 210 |
| `district_centroid_lng` | `centroid.lng` | 211 |

---

### Fields Populated by Migration Scripts

| Field | Script | Purpose |
|-------|--------|---------|
| `hours_full_week` | `migrate-venue-hours.js` | Parse `business_hours` text → JSON |
| `market_slug` | `migrate-venues-to-catalog.ARCHIVED.js` | Link venues to markets |
| `venue_types` | `migrate-venues-to-catalog.ARCHIVED.js` | Migrate from old tables |
| `expense_rank` | `migrate-venues-to-catalog.ARCHIVED.js` | From nearby_venues |
| `crowd_level` | `migrate-venues-to-catalog.ARCHIVED.js` | From nearby_venues |
| `rideshare_potential` | `migrate-venues-to-catalog.ARCHIVED.js` | From nearby_venues |
| `hours_source` | `migrate-venues-to-catalog.ARCHIVED.js` | From venue_cache |
| `capacity_estimate` | `migrate-venues-to-catalog.ARCHIVED.js` | From venue_cache |
| `source_model` | `migrate-venues-to-catalog.ARCHIVED.js` | From venue_cache |

---

## Venue Creation Paths Summary

| Code Path | File | Sets venue_types? | Sets bar fields? | Sets district? |
|-----------|------|-------------------|------------------|----------------|
| Address Resolver | `venue-address-resolver.js` | ❌ NO (empty array) | ❌ NO | ❌ NO |
| Bar Tab Discovery | `venue-intelligence.js` | ✅ `['bar']` etc | ✅ YES | ✅ YES |
| findOrCreateVenue | `venue-cache.js` | ✅ `['event_host']` | ❌ NO | ✅ YES |
| insertVenue | `venue-cache.js` | ✅ From caller | Depends on caller | ✅ YES |
| SmartBlocks | `enhanced-smart-blocks.js` | ❌ NO | ❌ NO | ❌ NO |
| Manual Seed | `seed-dfw-venues.js` | ❌ NO | ❌ NO | ❌ NO |
| AI Coach | `coach-dal.js` | ❌ NO | ❌ NO | ❌ NO |

---

## The Problem

**There is no single source of truth for venue type tagging.**

When a venue is created via `venue-address-resolver.js` (which happens during geocoding), it gets:
- `venue_types: []` (empty)
- `category: 'venue'` (hardcoded generic)
- No bar-specific fields
- No event-venue flag

**This causes UI confusion:**
- A venue tagged as `nightlife` via events could land in Events UI
- But it should appear in Bars UI
- No way to distinguish source (Bar Tab vs Events vs Planner)

---

## Proposed Solution (Pending Melody's Architecture Decision)

Add explicit boolean flags to track discovery source:
- `is_bar` - TRUE if discovered via Bar Tab
- `is_event_venue` - TRUE if discovered via Events pipeline

These flags would be set at the point of discovery, not inferred later.

---

## Files That Write to venue_catalog

| File | Primary Purpose |
|------|-----------------|
| `server/lib/venue/venue-address-resolver.js` | Geocoding coordinates to addresses |
| `server/lib/venue/venue-cache.js` | CRUD operations for venue catalog |
| `server/lib/venue/venue-intelligence.js` | Bar Tab discovery (premium bars) |
| `server/lib/venue/enhanced-smart-blocks.js` | SmartBlocks venue enrichment |
| `server/lib/venue/district-detection.js` | District tagging |
| `server/lib/ai/coach-dal.js` | AI Coach venue contributions |
| `server/scripts/seed-dfw-venues.js` | Manual DFW venue seeding |
| `server/scripts/migrate-venue-hours.js` | Hours migration |
| `server/scripts/migrate-venues-to-catalog.ARCHIVED.js` | Old table migration |

---

## Next Steps

**Waiting for Melody's architecture decision on:**
1. What fields to add (`is_bar`, `is_event_venue`?)
2. How these flags should be set
3. Which UI each venue type should appear in
