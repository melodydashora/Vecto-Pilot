<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Vecto Pilot‚Ñ¢ - Architecture Reference</title>
    <style>
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      div.columns {
        display: flex;
        gap: min(4vw, 1.5em);
      }
      div.column {
        flex: auto;
        overflow-x: auto;
      }
      div.hanging-indent {
        margin-left: 1.5em;
        text-indent: -1.5em;
      }
      /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
      ul.task-list[class] {
        list-style: none;
      }
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math {
        display: block;
        text-align: center;
        margin: 0.5rem auto;
      }
      /* CSS for syntax highlighting */
      html {
        -webkit-text-size-adjust: 100%;
      }
      pre > code.sourceCode {
        white-space: pre;
        position: relative;
      }
      pre > code.sourceCode > span {
        display: inline-block;
        line-height: 1.25;
      }
      pre > code.sourceCode > span:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode > span {
        color: inherit;
        text-decoration: inherit;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        pre > code.sourceCode {
          white-space: pre-wrap;
        }
        pre > code.sourceCode > span {
          text-indent: -5em;
          padding-left: 5em;
        }
      }
      pre.numberSource code {
        counter-reset: source-line 0;
      }
      pre.numberSource code > span {
        position: relative;
        left: -4em;
        counter-increment: source-line;
      }
      pre.numberSource code > span > a:first-child::before {
        content: counter(source-line);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
        background-color: #f8f8f8;
      }
      @media screen {
        pre > code.sourceCode > span > a:first-child::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ef2929;
      } /* Alert */
      code span.an {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #204a87;
      } /* Attribute */
      code span.bn {
        color: #0000cf;
      } /* BaseN */
      code span.cf {
        color: #204a87;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4e9a06;
      } /* Char */
      code span.cn {
        color: #8f5902;
      } /* Constant */
      code span.co {
        color: #8f5902;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #204a87;
      } /* DataType */
      code span.dv {
        color: #0000cf;
      } /* DecVal */
      code span.er {
        color: #a40000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #0000cf;
      } /* Float */
      code span.fu {
        color: #204a87;
        font-weight: bold;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #204a87;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #ce5c00;
        font-weight: bold;
      } /* Operator */
      code span.ot {
        color: #8f5902;
      } /* Other */
      code span.pp {
        color: #8f5902;
        font-style: italic;
      } /* Preprocessor */
      code span.sc {
        color: #ce5c00;
        font-weight: bold;
      } /* SpecialChar */
      code span.ss {
        color: #4e9a06;
      } /* SpecialString */
      code span.st {
        color: #4e9a06;
      } /* String */
      code span.va {
        color: #000000;
      } /* Variable */
      code span.vs {
        color: #4e9a06;
      } /* VerbatimString */
      code span.wa {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
    <link rel="stylesheet" href="/dev/fd/63" />
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">Vecto Pilot‚Ñ¢ - Architecture Reference</h1>
    </header>
    <nav id="TOC" role="doc-toc">
      <ul>
        <li>
          <a
            href="#vecto-pilot---architecture-constraints-reference"
            id="toc-vecto-pilot---architecture-constraints-reference"
            >Vecto Pilot‚Ñ¢ - Architecture &amp; Constraints Reference</a
          >
          <ul>
            <li>
              <a href="#mission-statement" id="toc-mission-statement"
                >üìç <strong>MISSION STATEMENT</strong></a
              >
            </li>
          </ul>
        </li>
        <li>
          <a
            href="#accuracy-first-operating-invariants"
            id="toc-accuracy-first-operating-invariants"
            >Accuracy-First Operating Invariants</a
          >
          <ul>
            <li>
              <a
                href="#core-principle-accuracy-before-expense"
                id="toc-core-principle-accuracy-before-expense"
                >üéØ <strong>CORE PRINCIPLE: ACCURACY BEFORE EXPENSE</strong></a
              >
            </li>
            <li>
              <a
                href="#invariants-hard-rules---fail-closed"
                id="toc-invariants-hard-rules---fail-closed"
                >üîí <strong>INVARIANTS (Hard Rules - Fail-Closed)</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#single-path-orchestration-only"
                    id="toc-single-path-orchestration-only"
                    >1. <strong>Single-Path Orchestration Only</strong></a
                  >
                </li>
                <li>
                  <a
                    href="#model-ids-are-pinned-and-verified-monthly"
                    id="toc-model-ids-are-pinned-and-verified-monthly"
                    >2.
                    <strong
                      >Model IDs Are Pinned and Verified Monthly</strong
                    ></a
                  >
                </li>
                <li>
                  <a
                    href="#complete-snapshot-gating"
                    id="toc-complete-snapshot-gating"
                    >3. <strong>Complete Snapshot Gating</strong></a
                  >
                </li>
                <li>
                  <a
                    href="#accuracy-over-expense-for-closure-sensitive-recs"
                    id="toc-accuracy-over-expense-for-closure-sensitive-recs"
                    >4.
                    <strong
                      >Accuracy Over Expense for Closure-Sensitive Recs</strong
                    ></a
                  >
                </li>
                <li>
                  <a
                    href="#deterministic-logging-for-ml"
                    id="toc-deterministic-logging-for-ml"
                    >5. <strong>Deterministic Logging for ML</strong></a
                  >
                </li>
                <li>
                  <a
                    href="#coordinates-and-business-hours-come-from-google-or-db-never-models"
                    id="toc-coordinates-and-business-hours-come-from-google-or-db-never-models"
                    >6.
                    <strong
                      >Coordinates and Business Hours Come From Google or DB,
                      Never Models</strong
                    ></a
                  >
                </li>
                <li>
                  <a
                    href="#deterministic-merge-by-key-never-by-index"
                    id="toc-deterministic-merge-by-key-never-by-index"
                    >7.
                    <strong
                      >Deterministic Merge by Key, Never by Index</strong
                    ></a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#backward-pressure-explicitly-deprecated"
                id="toc-backward-pressure-explicitly-deprecated"
                >‚¨ÖÔ∏è
                <strong>BACKWARD PRESSURE (Explicitly Deprecated)</strong></a
              >
            </li>
            <li>
              <a
                href="#forward-pressure-near-term-enforcement"
                id="toc-forward-pressure-near-term-enforcement"
                >‚û°Ô∏è <strong>FORWARD PRESSURE (Near-Term Enforcement)</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#a-model-verification-in-ci"
                    id="toc-a-model-verification-in-ci"
                    >A) Model Verification in CI</a
                  >
                </li>
                <li>
                  <a
                    href="#b-closure-risk-gate-in-apiblocks"
                    id="toc-b-closure-risk-gate-in-apiblocks"
                    >B) Closure Risk Gate in /api/blocks</a
                  >
                </li>
                <li>
                  <a
                    href="#c-confidence-thresholds-with-visible-badges"
                    id="toc-c-confidence-thresholds-with-visible-badges"
                    >C) Confidence Thresholds with Visible Badges</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#root-cause-protocol-no-iterative-debate-required"
                id="toc-root-cause-protocol-no-iterative-debate-required"
                >üîß
                <strong
                  >ROOT-CAUSE PROTOCOL (No Iterative Debate Required)</strong
                ></a
              >
            </li>
            <li>
              <a
                href="#purpose-of-this-document"
                id="toc-purpose-of-this-document"
                >üìã <strong>PURPOSE OF THIS DOCUMENT</strong></a
              >
            </li>
            <li>
              <a
                href="#critical-architecture-evolution-oct-8-2025"
                id="toc-critical-architecture-evolution-oct-8-2025"
                >üîÑ
                <strong
                  >CRITICAL ARCHITECTURE EVOLUTION (Oct 8, 2025)</strong
                ></a
              >
              <ul>
                <li>
                  <a
                    href="#verified-anthropic-claude-sonnet-4.5-model"
                    id="toc-verified-anthropic-claude-sonnet-4.5-model"
                    >‚úÖ VERIFIED: Anthropic Claude Sonnet 4.5 Model</a
                  >
                </li>
                <li>
                  <a
                    href="#verified-openai-gpt-5-pro-model"
                    id="toc-verified-openai-gpt-5-pro-model"
                    >‚úÖ VERIFIED: OpenAI GPT-5 Pro Model</a
                  >
                </li>
                <li>
                  <a
                    href="#verified-google-gemini-2.5-pro-model"
                    id="toc-verified-google-gemini-2.5-pro-model"
                    >‚úÖ VERIFIED: Google Gemini 2.5 Pro Model</a
                  >
                </li>
                <li>
                  <a
                    href="#implemented-thread-aware-context-system"
                    id="toc-implemented-thread-aware-context-system"
                    >‚úÖ IMPLEMENTED: Thread-Aware Context System</a
                  >
                </li>
                <li>
                  <a
                    href="#architectural-principle-single-path-triad-no-fallbacks"
                    id="toc-architectural-principle-single-path-triad-no-fallbacks"
                    >‚úÖ ARCHITECTURAL PRINCIPLE: Single-Path Triad (No
                    Fallbacks)</a
                  >
                </li>
                <li>
                  <a
                    href="#production-fixes-error-resolution-oct-9-2025"
                    id="toc-production-fixes-error-resolution-oct-9-2025"
                    >‚úÖ PRODUCTION FIXES: Error Resolution (Oct 9, 2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#updated-documentation-alignment"
                    id="toc-updated-documentation-alignment"
                    >‚úÖ UPDATED: Documentation Alignment</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#system-architecture" id="toc-system-architecture"
                >üèóÔ∏è <strong>SYSTEM ARCHITECTURE</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#multi-server-architecture-production"
                    id="toc-multi-server-architecture-production"
                    >Multi-Server Architecture (Production)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#aiml-pipeline-triad-architecture"
                id="toc-aiml-pipeline-triad-architecture"
                >ü§ñ <strong>AI/ML PIPELINE: TRIAD ARCHITECTURE</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#design-philosophy-locked---do-not-change"
                    id="toc-design-philosophy-locked---do-not-change"
                    >Design Philosophy (LOCKED - DO NOT CHANGE)</a
                  >
                </li>
                <li>
                  <a
                    href="#stage-1-claude-sonnet-4.5-strategist"
                    id="toc-stage-1-claude-sonnet-4.5-strategist"
                    >Stage 1: Claude Sonnet 4.5 (Strategist)</a
                  >
                </li>
                <li>
                  <a
                    href="#stage-2-gpt-5-tactical-planner"
                    id="toc-stage-2-gpt-5-tactical-planner"
                    >Stage 2: GPT-5 (Tactical Planner)</a
                  >
                </li>
                <li>
                  <a
                    href="#stage-3-gemini-2.5-pro-validator"
                    id="toc-stage-3-gemini-2.5-pro-validator"
                    >Stage 3: Gemini 2.5 Pro (Validator)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#trust-first-stack-architecture"
                id="toc-trust-first-stack-architecture"
                >üèõÔ∏è <strong>TRUST-FIRST STACK ARCHITECTURE</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#core-principle-prevent-llm-hallucinations-with-deterministic-scoring"
                    id="toc-core-principle-prevent-llm-hallucinations-with-deterministic-scoring"
                    >Core Principle: Prevent LLM Hallucinations with
                    Deterministic Scoring</a
                  >
                </li>
                <li>
                  <a
                    href="#venue-catalog-single-source-of-truth"
                    id="toc-venue-catalog-single-source-of-truth"
                    >Venue Catalog (Single Source of Truth)</a
                  >
                </li>
                <li>
                  <a
                    href="#deterministic-scoring-engine"
                    id="toc-deterministic-scoring-engine"
                    >Deterministic Scoring Engine</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#strategy-component-framework-workflow-order"
                id="toc-strategy-component-framework-workflow-order"
                >üéØ
                <strong
                  >STRATEGY COMPONENT FRAMEWORK (Workflow Order)</strong
                ></a
              >
              <ul>
                <li>
                  <a
                    href="#overview-the-recommendation-pipeline"
                    id="toc-overview-the-recommendation-pipeline"
                    >Overview: The Recommendation Pipeline</a
                  >
                </li>
                <li>
                  <a
                    href="#component-architecture"
                    id="toc-component-architecture"
                    >Component Architecture</a
                  >
                </li>
                <li>
                  <a
                    href="#system-integration-points"
                    id="toc-system-integration-points"
                    >System Integration Points</a
                  >
                </li>
                <li>
                  <a
                    href="#critical-success-factors"
                    id="toc-critical-success-factors"
                    >Critical Success Factors</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#strategic-overview-triad-intelligence-1"
                id="toc-strategic-overview-triad-intelligence-1"
                >üìç
                <strong>1. STRATEGIC OVERVIEW (Triad Intelligence)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle" id="toc-core-principle"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works" id="toc-how-it-works">How It Works</a>
                </li>
                <li>
                  <a href="#why-this-approach" id="toc-why-this-approach"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs" id="toc-when-it-runs">When It Runs</a>
                </li>
                <li>
                  <a href="#system-impact" id="toc-system-impact"
                    >System Impact</a
                  >
                </li>
                <li><a href="#ml-impact" id="toc-ml-impact">ML Impact</a></li>
              </ul>
            </li>
            <li>
              <a
                href="#venue-discovery-catalog-exploration-1"
                id="toc-venue-discovery-catalog-exploration-1"
                >üéØ
                <strong>2. VENUE DISCOVERY (Catalog + Exploration)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-1" id="toc-core-principle-1"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-1" id="toc-how-it-works-1"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-1" id="toc-why-this-approach-1"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-1" id="toc-when-it-runs-1"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-1" id="toc-system-impact-1"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-1" id="toc-ml-impact-1">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#venue-hours-accuracy-first-1"
                id="toc-venue-hours-accuracy-first-1"
                >üè¢ <strong>3. VENUE HOURS (Accuracy-First)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-2" id="toc-core-principle-2"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a
                    href="#risk-gated-validation-approach"
                    id="toc-risk-gated-validation-approach"
                    >Risk-Gated Validation Approach</a
                  >
                </li>
                <li>
                  <a
                    href="#closure-risk-calculation"
                    id="toc-closure-risk-calculation"
                    >Closure Risk Calculation</a
                  >
                </li>
                <li>
                  <a
                    href="#outcome-tracking-ml-pipeline"
                    id="toc-outcome-tracking-ml-pipeline"
                    >Outcome Tracking (ML Pipeline)</a
                  >
                </li>
                <li>
                  <a href="#cost-posture" id="toc-cost-posture">Cost Posture</a>
                </li>
                <li>
                  <a href="#system-impact-2" id="toc-system-impact-2"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-2" id="toc-ml-impact-2">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#distance-eta-traffic-aware-1"
                id="toc-distance-eta-traffic-aware-1"
                >üìè <strong>4. DISTANCE &amp; ETA (Traffic-Aware)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-3" id="toc-core-principle-3"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a
                    href="#data-sources---split-of-duties"
                    id="toc-data-sources---split-of-duties"
                    >Data Sources - Split of Duties</a
                  >
                </li>
                <li>
                  <a
                    href="#venue-resolution-flow-db-first"
                    id="toc-venue-resolution-flow-db-first"
                    >Venue Resolution Flow (DB-first)</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-2" id="toc-how-it-works-2"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-2" id="toc-why-this-approach-2"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-2" id="toc-when-it-runs-2"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-3" id="toc-system-impact-3"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-3" id="toc-ml-impact-3">ML Impact</a>
                </li>
                <li>
                  <a href="#ui-display-policy" id="toc-ui-display-policy"
                    >UI Display Policy</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#surge-detection-opportunity-capture-1"
                id="toc-surge-detection-opportunity-capture-1"
                >üî• <strong>5. SURGE DETECTION (Opportunity Capture)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-4" id="toc-core-principle-4"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-3" id="toc-how-it-works-3"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-3" id="toc-why-this-approach-3"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-3" id="toc-when-it-runs-3"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-4" id="toc-system-impact-4"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-4" id="toc-ml-impact-4">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#earnings-projection-income-accuracy-1"
                id="toc-earnings-projection-income-accuracy-1"
                >üí∞ <strong>6. EARNINGS PROJECTION (Income Accuracy)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-5" id="toc-core-principle-5"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-4" id="toc-how-it-works-4"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-4" id="toc-why-this-approach-4"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-4" id="toc-when-it-runs-4"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-5" id="toc-system-impact-5"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-5" id="toc-ml-impact-5">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#priority-flagging-urgency-intelligence-1"
                id="toc-priority-flagging-urgency-intelligence-1"
                >‚≠ê
                <strong>7. PRIORITY FLAGGING (Urgency Intelligence)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-6" id="toc-core-principle-6"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-5" id="toc-how-it-works-5"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-5" id="toc-why-this-approach-5"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-5" id="toc-when-it-runs-5"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-6" id="toc-system-impact-6"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-6" id="toc-ml-impact-6">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#block-ranking-value-optimization-1"
                id="toc-block-ranking-value-optimization-1"
                >üìä <strong>8. BLOCK RANKING (Value Optimization)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-7" id="toc-core-principle-7"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-6" id="toc-how-it-works-6"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#ranking-key" id="toc-ranking-key">Ranking Key</a>
                </li>
                <li>
                  <a href="#why-this-approach-6" id="toc-why-this-approach-6"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-6" id="toc-when-it-runs-6"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-7" id="toc-system-impact-7"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-7" id="toc-ml-impact-7">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#staging-intelligence-waiting-strategy-1"
                id="toc-staging-intelligence-waiting-strategy-1"
                >üÖøÔ∏è
                <strong>9. STAGING INTELLIGENCE (Waiting Strategy)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-8" id="toc-core-principle-8"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-7" id="toc-how-it-works-7"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-7" id="toc-why-this-approach-7"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-7" id="toc-when-it-runs-7"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-8" id="toc-system-impact-8"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-8" id="toc-ml-impact-8">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#pro-tips-tactical-guidance-1"
                id="toc-pro-tips-tactical-guidance-1"
                >üí° <strong>10. PRO TIPS (Tactical Guidance)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-9" id="toc-core-principle-9"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-8" id="toc-how-it-works-8"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-8" id="toc-why-this-approach-8"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-8" id="toc-when-it-runs-8"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-9" id="toc-system-impact-9"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-9" id="toc-ml-impact-9">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#gesture-feedback-learning-loop-1"
                id="toc-gesture-feedback-learning-loop-1"
                >üëç <strong>11. GESTURE FEEDBACK (Learning Loop)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-10" id="toc-core-principle-10"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-9" id="toc-how-it-works-9"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-9" id="toc-why-this-approach-9"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-9" id="toc-when-it-runs-9"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-10" id="toc-system-impact-10"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-10" id="toc-ml-impact-10">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#navigation-launch-seamless-routing-1"
                id="toc-navigation-launch-seamless-routing-1"
                >üß≠ <strong>12. NAVIGATION LAUNCH (Seamless Routing)</strong></a
              >
              <ul>
                <li>
                  <a href="#core-principle-11" id="toc-core-principle-11"
                    >Core Principle</a
                  >
                </li>
                <li>
                  <a href="#how-it-works-10" id="toc-how-it-works-10"
                    >How It Works</a
                  >
                </li>
                <li>
                  <a href="#why-this-approach-10" id="toc-why-this-approach-10"
                    >Why This Approach</a
                  >
                </li>
                <li>
                  <a href="#when-it-runs-10" id="toc-when-it-runs-10"
                    >When It Runs</a
                  >
                </li>
                <li>
                  <a href="#system-impact-11" id="toc-system-impact-11"
                    >System Impact</a
                  >
                </li>
                <li>
                  <a href="#ml-impact-11" id="toc-ml-impact-11">ML Impact</a>
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#architectural-constraints-do-not-violate"
                id="toc-architectural-constraints-do-not-violate"
                >üîí
                <strong>ARCHITECTURAL CONSTRAINTS (DO NOT VIOLATE)</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#zero-hardcoding-policy"
                    id="toc-zero-hardcoding-policy"
                    >1. Zero Hardcoding Policy</a
                  >
                </li>
                <li>
                  <a
                    href="#never-suppress-errors"
                    id="toc-never-suppress-errors"
                    >2. Never Suppress Errors</a
                  >
                </li>
                <li>
                  <a
                    href="#single-path-triad-no-fallbacks"
                    id="toc-single-path-triad-no-fallbacks"
                    >3. Single-Path Triad (No Fallbacks)</a
                  >
                </li>
                <li>
                  <a
                    href="#complete-snapshots-only"
                    id="toc-complete-snapshots-only"
                    >4. Complete Snapshots Only</a
                  >
                </li>
                <li>
                  <a href="#model-id-stability" id="toc-model-id-stability"
                    >5. Model ID Stability</a
                  >
                </li>
                <li>
                  <a
                    href="#partner-platform-namespace-separation"
                    id="toc-partner-platform-namespace-separation"
                    >6. Partner Platform Namespace Separation</a
                  >
                </li>
                <li>
                  <a
                    href="#database-schema-immutability"
                    id="toc-database-schema-immutability"
                    >7. Database Schema Immutability</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#ml-instrumentation-training-data"
                id="toc-ml-instrumentation-training-data"
                >üìä <strong>ML INSTRUMENTATION &amp; TRAINING DATA</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#counterfactual-learning-pipeline"
                    id="toc-counterfactual-learning-pipeline"
                    >Counterfactual Learning Pipeline</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#security-safety" id="toc-security-safety"
                >üîê <strong>SECURITY &amp; SAFETY</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#rate-limiting-ddos-protection"
                    id="toc-rate-limiting-ddos-protection"
                    >Rate Limiting (DDoS Protection)</a
                  >
                </li>
                <li>
                  <a href="#secret-management" id="toc-secret-management"
                    >Secret Management</a
                  >
                </li>
                <li>
                  <a
                    href="#command-whitelisting-agent-server"
                    id="toc-command-whitelisting-agent-server"
                    >Command Whitelisting (Agent Server)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#deployment-configuration"
                id="toc-deployment-configuration"
                >üöÄ <strong>DEPLOYMENT CONFIGURATION</strong></a
              >
              <ul>
                <li>
                  <a href="#production-settings" id="toc-production-settings"
                    >Production Settings</a
                  >
                </li>
                <li>
                  <a
                    href="#workflow-configuration"
                    id="toc-workflow-configuration"
                    >Workflow Configuration</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#forward-pressure-roadmap"
                id="toc-forward-pressure-roadmap"
                >üìà <strong>FORWARD PRESSURE (Roadmap)</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#phase-1-enhanced-context-q4-2025"
                    id="toc-phase-1-enhanced-context-q4-2025"
                    >Phase 1: Enhanced Context (Q4 2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#phase-2-trust-first-refinement-q1-2026"
                    id="toc-phase-2-trust-first-refinement-q1-2026"
                    >Phase 2: Trust-First Refinement (Q1 2026)</a
                  >
                </li>
                <li>
                  <a
                    href="#phase-3-safety-compliance-q2-2026"
                    id="toc-phase-3-safety-compliance-q2-2026"
                    >Phase 3: Safety &amp; Compliance (Q2 2026)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#backward-pressure-deprecated"
                id="toc-backward-pressure-deprecated"
                >‚¨ÖÔ∏è <strong>BACKWARD PRESSURE (Deprecated)</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#router-v2-with-fallbacks-removed-oct-8-2025"
                    id="toc-router-v2-with-fallbacks-removed-oct-8-2025"
                    ><del>Router V2 with Fallbacks</del> (Removed Oct 8,
                    2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#global-json-body-parsing-removed-oct-7-2025"
                    id="toc-global-json-body-parsing-removed-oct-7-2025"
                    ><del>Global JSON Body Parsing</del> (Removed Oct 7,
                    2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#react.strictmode-removed-oct-7-2025"
                    id="toc-react.strictmode-removed-oct-7-2025"
                    ><del>React.StrictMode</del> (Removed Oct 7, 2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#deprecated-models-replaced-oct-8-2025"
                    id="toc-deprecated-models-replaced-oct-8-2025"
                    ><del>Deprecated Models</del> (Replaced Oct 8, 2025)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#testing-verification" id="toc-testing-verification"
                >üß™ <strong>TESTING &amp; VERIFICATION</strong></a
              >
              <ul>
                <li>
                  <a
                    href="#model-verification-monthly"
                    id="toc-model-verification-monthly"
                    >Model Verification (Monthly)</a
                  >
                </li>
                <li>
                  <a href="#triad-pipeline-test" id="toc-triad-pipeline-test"
                    >Triad Pipeline Test</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#key-documentation-references"
                id="toc-key-documentation-references"
                >üìö <strong>KEY DOCUMENTATION REFERENCES</strong></a
              >
            </li>
            <li>
              <a
                href="#fix-capsule-agent-authored-append-one-per-fix"
                id="toc-fix-capsule-agent-authored-append-one-per-fix"
                >üìù
                <strong
                  >FIX CAPSULE (Agent-Authored, append one per fix)</strong
                ></a
              >
              <ul>
                <li>
                  <a
                    href="#template-use-for-every-future-fix"
                    id="toc-template-use-for-every-future-fix"
                    >Template: Use for Every Future Fix</a
                  >
                </li>
                <li>
                  <a
                    href="#fix-capsule-key-based-merge-db-first-coordshours-oct-8-2025"
                    id="toc-fix-capsule-key-based-merge-db-first-coordshours-oct-8-2025"
                    >Fix Capsule ‚Äî Key-Based Merge, DB-First Coords/Hours (Oct
                    8, 2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#fix-capsule-value-per-minute-ranking-oct-8-2025"
                    id="toc-fix-capsule-value-per-minute-ranking-oct-8-2025"
                    >Fix Capsule ‚Äî Value Per Minute Ranking (Oct 8, 2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#fix-capsule-geocoding-vs-places-split-oct-8-2025"
                    id="toc-fix-capsule-geocoding-vs-places-split-oct-8-2025"
                    >Fix Capsule ‚Äî Geocoding vs Places Split (Oct 8, 2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#fix-capsule-atomic-database-persistence-oct-9-2025"
                    id="toc-fix-capsule-atomic-database-persistence-oct-9-2025"
                    >Fix Capsule ‚Äî Atomic Database Persistence (Oct 9, 2025)</a
                  >
                </li>
                <li>
                  <a
                    href="#fix-capsule-ui-mapper-for-distanceeta-oct-8-2025"
                    id="toc-fix-capsule-ui-mapper-for-distanceeta-oct-8-2025"
                    >Fix Capsule ‚Äî UI Mapper for Distance/ETA (Oct 8, 2025)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#fix-capsule-coordinate-persistence-oct-9-2025"
                id="toc-fix-capsule-coordinate-persistence-oct-9-2025"
                >üîß
                <strong
                  >FIX CAPSULE: Coordinate Persistence (Oct 9, 2025)</strong
                ></a
              >
              <ul>
                <li>
                  <a
                    href="#fix-capsule-per-ranking-feedback-system-oct-9-2025"
                    id="toc-fix-capsule-per-ranking-feedback-system-oct-9-2025"
                    >Fix Capsule ‚Äî Per-Ranking Feedback System (Oct 9, 2025)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#decision-log" id="toc-decision-log"
                >üéØ <strong>DECISION LOG</strong></a
              >
              <ul>
                <li>
                  <a href="#october-9-2025" id="toc-october-9-2025"
                    >October 9, 2025</a
                  >
                </li>
                <li>
                  <a href="#october-8-2025" id="toc-october-8-2025"
                    >October 8, 2025</a
                  >
                </li>
                <li>
                  <a href="#october-7-2025" id="toc-october-7-2025"
                    >October 7, 2025</a
                  >
                </li>
                <li>
                  <a href="#october-3-2025" id="toc-october-3-2025"
                    >October 3, 2025</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                href="#critical-constraints-summary"
                id="toc-critical-constraints-summary"
                >üö® <strong>CRITICAL CONSTRAINTS SUMMARY</strong></a
              >
            </li>
          </ul>
        </li>
      </ul>
    </nav>
    <h1 id="vecto-pilot---architecture-constraints-reference">
      Vecto Pilot‚Ñ¢ - Architecture &amp; Constraints Reference
    </h1>
    <hr />
    <p><strong>Last Updated:</strong> 2025-10-09 05:30 CST</p>
    <hr />
    <h2 id="mission-statement">üìç <strong>MISSION STATEMENT</strong></h2>
    <p>
      <strong>Drivers don‚Äôt lose money because they can‚Äôt drive.</strong> They
      lose it in the gaps‚Äîtime with no passenger, miles with no rider, and
      opaque pricing that shifts under their feet. In big markets, as much as
      40% of ridehail miles are ‚Äúdeadhead‚Äù miles between trips, which drags down
      earnings even when the per-trip payout looks decent.
    </p>
    <p>
      <strong>Dynamic pricing makes this harder, not easier.</strong> Surge can
      raise weekly revenue in aggregate, but it also pulls in extra supply and
      compresses per-day earnings for many full-time drivers. Chasing surge
      raises complaint risk‚Äîresearch shows roughly a quarter of the short-term
      surge bump gets erased later by lower ratings and complaint-driven
      penalties.
    </p>
    <p>
      <strong>Platforms keep changing how money flows.</strong> Upfront pricing
      and algorithmic changes can alter take rates without obvious signals on
      the driver screen. Lockouts and utilization management further reduce paid
      time online. What worked last month can quietly stop working.
    </p>
    <p>
      <strong>Demand itself is spiky and local.</strong> Airports, stadiums, and
      weather windows swing the market on short notice. Surge regions are small
      and decay within blocks, so moving a few minutes late can erase the
      premium. Keeping all of that in your head while driving is more than a
      full-time job.
    </p>
    <p>
      <strong>This app solves that problem.</strong> It removes guesswork by
      grounding every recommendation in verified coordinates and business hours
      from Google Places‚Äînot model hallucinations‚Äîand caching those truths in
      the database once validated. It computes distance and earnings-per-mile
      from the server side with real navigation distance, not rough client math.
      It enforces ‚Äúaccuracy before expense‚Äù rules for closure-sensitive venues
      and logs every recommendation for counterfactual learning.
    </p>
    <p>
      <strong>It helps even drivers who ‚Äúknow the best places‚Äù</strong> because
      ‚Äúbest‚Äù changes hour to hour. The tool watches flight banks, event timing,
      daypart, and recent outcomes, then turns that into concrete staging
      locations with exact coordinates, verified open status, and an
      earnings-per-mile target that already includes the drive to get there.
    </p>
    <p>
      <strong>For experts, it‚Äôs an amplifier, not a crutch.</strong> Research
      shows that simply seeing better price and location signals changes
      relocation choices and revenue. The app gives a denser signal than a surge
      heatmap by fusing demand cues with verified venue data and your own
      historical results, so repositioning decisions are faster and more
      accurate with fewer dead miles.
    </p>
    <p>
      <strong>Safety benefits are equally critical.</strong> Real-time strategic
      positioning guidance reduces driver fatigue from aimless driving and long
      hours, helps avoid unsafe areas through better planning, and gets drivers
      home faster with fewer total miles driven‚Äîaddressing key safety risks
      identified in rideshare safety research.
    </p>
    <p>
      <strong>Bottom line for drivers:</strong> Higher utilization, fewer empty
      miles, and fewer bad bets on closed or low-yield venues.
      <strong>Bottom line for the industry:</strong> Decisions that are
      auditable, repeatable, and aligned with driver income instead of
      speculation.
    </p>
    <hr />
    <h1 id="accuracy-first-operating-invariants">
      Accuracy-First Operating Invariants
    </h1>
    <hr />
    <h2 id="core-principle-accuracy-before-expense">
      üéØ <strong>CORE PRINCIPLE: ACCURACY BEFORE EXPENSE</strong>
    </h2>
    <p>
      This document is the <strong>single source of truth</strong> for
      constraints.
      <strong>Cost matters but cannot override correctness for drivers.</strong>
      When tension exists, we resolve in favor of accuracy and transparent
      failure.
    </p>
    <hr />
    <h2 id="invariants-hard-rules---fail-closed">
      üîí <strong>INVARIANTS (Hard Rules - Fail-Closed)</strong>
    </h2>
    <p>
      These are non-negotiable constraints. Violations are deployment blockers,
      not runtime surprises.
    </p>
    <h3 id="single-path-orchestration-only">
      1. <strong>Single-Path Orchestration Only</strong>
    </h3>
    <p>
      Triad is authoritative. No hedging, no silent swaps, no router fallbacks.
      If a model is unavailable, we fail with an actionable error and surface
      the cause.
    </p>
    <h3 id="model-ids-are-pinned-and-verified-monthly">
      2. <strong>Model IDs Are Pinned and Verified Monthly</strong>
    </h3>
    <p>
      Missing or changed IDs are treated as deployment blockers. Messages
      responses must echo the requested model; mismatches throw.
    </p>
    <h3 id="complete-snapshot-gating">
      3. <strong>Complete Snapshot Gating</strong>
    </h3>
    <p>
      No LLM call without a complete location snapshot (GPS, timezone, daypart,
      weather/AQI). If any core field is missing, return ‚Äúnot ready‚Äù with
      guidance rather than a low-confidence plan.
    </p>
    <h3 id="accuracy-over-expense-for-closure-sensitive-recs">
      4. <strong>Accuracy Over Expense for Closure-Sensitive Recs</strong>
    </h3>
    <p>
      When the venue‚Äôs open/closed status materially affects driver income, we
      must either validate status or choose a de-risked alternative.
      <strong>‚ÄúUnknown‚Äù is never presented as ‚Äúopen‚Äù.</strong>
    </p>
    <h3 id="deterministic-logging-for-ml">
      5. <strong>Deterministic Logging for ML</strong>
    </h3>
    <p>
      For every block served: input snapshot hash, model ID, token budget,
      confidence, and downstream outcome (accept/skip/abort) are recorded for
      counterfactual learning.
    </p>
    <h3 id="coordinates-and-business-hours-come-from-google-or-db-never-models">
      6.
      <strong
        >Coordinates and Business Hours Come From Google or DB, Never
        Models</strong
      >
    </h3>
    <p>
      Truth sources are Google Places/Routes and our persisted cache. Generative
      models must not originate or ‚Äúcorrect‚Äù lat/lng or hours. If Google is
      unavailable, we use last verified DB copy; otherwise we fail-closed.
    </p>
    <h3 id="deterministic-merge-by-key-never-by-index">
      7. <strong>Deterministic Merge by Key, Never by Index</strong>
    </h3>
    <p>
      All enrich/validate merges use stable keys (place_id preferred; name
      fallback) and numeric coercion. Defaulting earnings/distance to 0 is
      forbidden. Fallback order: server potential ‚Üí computed epm ‚Üí fail-closed
      when neither is available.
    </p>
    <hr />
    <h2 id="backward-pressure-explicitly-deprecated">
      ‚¨ÖÔ∏è <strong>BACKWARD PRESSURE (Explicitly Deprecated)</strong>
    </h2>
    <ul>
      <li>
        <del>Multi-model router with fallback/hedging for production</del>
      </li>
      <li><del>Global JSON body parsing (per-route only)</del></li>
      <li><del>React.StrictMode in production UI</del></li>
      <li>
        <del
          >Treating cost-only heuristics as overrides for accuracy-critical
          decisions</del
        >
      </li>
      <li>
        <del
          >‚ÄúCheap-first‚Äù MVP for business hours (replaced with risk-gated
          validation)</del
        >
      </li>
      <li>
        <del>Index-based merge (replaced with key-based merge, Oct 8 2025)</del>
      </li>
      <li>
        <del
          >Client GPS overwrite of venue coordinates (replaced with server
          truth, Oct 8 2025)</del
        >
      </li>
    </ul>
    <hr />
    <h2 id="forward-pressure-near-term-enforcement">
      ‚û°Ô∏è <strong>FORWARD PRESSURE (Near-Term Enforcement)</strong>
    </h2>
    <h3 id="a-model-verification-in-ci">A) Model Verification in CI</h3>
    <p>
      Model verification script runs in CI and rewrites MODEL.md; deployment
      blocks on failures.
    </p>
    <h3 id="b-closure-risk-gate-in-apiblocks">
      B) Closure Risk Gate in /api/blocks
    </h3>
    <p>
      If probability of closure &gt; threshold for a venue and time window, call
      a single validation path or substitute a venue with equal or higher
      expected earnings and known availability.
    </p>
    <h3 id="c-confidence-thresholds-with-visible-badges">
      C) Confidence Thresholds with Visible Badges
    </h3>
    <p>
      Below-threshold items are hidden by default; drivers can expand them
      explicitly with confidence warnings.
    </p>
    <hr />
    <h2 id="root-cause-protocol-no-iterative-debate-required">
      üîß <strong>ROOT-CAUSE PROTOCOL (No Iterative Debate Required)</strong>
    </h2>
    <p>When issues arise, follow this protocol to avoid rework:</p>
    <p>
      <strong>Step 1</strong> - Identify invariant violated (e.g., model ID
      mismatch, incomplete snapshot, closure gate skipped)<br />
      <strong>Step 2</strong> - Produce minimal failing trace: request ID,
      snapshot hash, model, elapsed, gate decisions<br />
      <strong>Step 3</strong> - Patch at the source of the invariant with a test
      and doc note; do not add workarounds elsewhere<br />
      <strong>Step 4</strong> - Update ARCHITECTURE.md ‚ÄúDecision Log‚Äù with date,
      invariant, and fix locus
    </p>
    <hr />
    <h2 id="purpose-of-this-document">
      üìã <strong>PURPOSE OF THIS DOCUMENT</strong>
    </h2>
    <p>
      Single source of truth for: 1.
      <strong>Architectural Decisions &amp; Constraints</strong> - What we
      can/cannot change without breaking core principles 2.
      <strong>Backward/Forward Pressure</strong> - What we‚Äôre moving away from
      (deprecated) vs.¬†where we‚Äôre going (roadmap) 3.
      <strong>Integration Boundaries</strong> - External dependencies and their
      limits 4. <strong>Trust-First Stack</strong> - Why we chose deterministic
      scoring over pure LLM hallucination 5.
      <strong>AI Development Guardrails</strong> - Constraints for AI-driven
      development at speed
    </p>
    <p>
      <strong>Critical for:</strong> Fast-moving AI-driven development where
      rework must be avoided and alignment must be maintained despite rapid
      iteration.
    </p>
    <hr />
    <h2 id="critical-architecture-evolution-oct-8-2025">
      üîÑ <strong>CRITICAL ARCHITECTURE EVOLUTION (Oct 8, 2025)</strong>
    </h2>
    <h3 id="verified-anthropic-claude-sonnet-4.5-model">
      ‚úÖ VERIFIED: Anthropic Claude Sonnet 4.5 Model
    </h3>
    <p>
      <strong>Issue Resolved:</strong> Model ID
      <code>claude-sonnet-4-5-20250929</code> confirmed working via direct API
      tests
    </p>
    <p>
      <strong>What Changed:</strong> - ‚úÖ
      <strong>Models API Verification</strong>:
      <code
        >curl
        https://api.anthropic.com/v1/models/claude-sonnet-4-5-20250929</code
      >
      ‚Üí Returns
      <code
        >{"id":"claude-sonnet-4-5-20250929","display_name":"Claude Sonnet
        4.5"}</code
      >
      - ‚úÖ <strong>Messages API Verification</strong>: Response echoes correct
      model (not Opus) - ‚úÖ <strong>Model Assertion Added</strong>: Adapter now
      throws error if API returns different model than requested - ‚úÖ
      <strong>Environment Variable</strong>: Added
      <code>ANTHROPIC_API_VERSION=2023-06-01</code> - ‚úÖ
      <strong>Error Surfacing</strong>: Enhanced error messages with server
      response text
    </p>
    <p>
      <strong>Files Updated:</strong> -
      <code>server/lib/adapters/anthropic-claude.js</code> - Model assertion +
      better error text - <code>.env</code> - Added
      <code>ANTHROPIC_API_VERSION=2023-06-01</code> - <code>MODEL.md</code> -
      Updated with verified working status -
      <code>docs/reference/V2-ROUTER-INTEGRATION.md</code> - Marked issue as
      resolved
    </p>
    <p>
      <strong>Constraint:</strong> Partner platform IDs are different namespaces
      (Vertex uses <code>@20250929</code>, Bedrock uses
      <code>anthropic.</code> prefix) - don‚Äôt mix with native API
    </p>
    <hr />
    <h3 id="verified-openai-gpt-5-pro-model">
      ‚úÖ VERIFIED: OpenAI GPT-5 Pro Model
    </h3>
    <p>
      <strong>Issue Resolved:</strong> Model ID <code>gpt-5-pro</code> confirmed
      working via direct API tests
    </p>
    <p>
      <strong>What Changed:</strong> - ‚úÖ
      <strong>Chat Completions API Verification</strong>:
      <code
        >curl https://api.openai.com/v1/chat/completions -d
        '{"model":"gpt-5-pro",...}'</code
      >
      ‚Üí Returns <code>{"model":"gpt-5-pro",...}</code> - ‚úÖ
      <strong>Reasoning Effort Parameter</strong>: Uses
      <code>reasoning_effort</code> (not temperature/top_p - those are
      deprecated in GPT-5) - ‚úÖ <strong>Token Usage Tracking</strong>: Separate
      counts for input/reasoning/output tokens - ‚úÖ
      <strong>Model Assertion Added</strong>: Adapter validates correct model in
      response - ‚úÖ <strong>Context Window</strong>: 256K tokens (256,000
      tokens/request)
    </p>
    <p>
      <strong>Files Updated:</strong> -
      <code>server/lib/adapters/openai-gpt5.js</code> - Reasoning effort support
      + token tracking - <code>.env</code> -
      <code>OPENAI_MODEL=gpt-5-pro</code> - <code>MODEL.md</code> - Updated with
      verified working status
    </p>
    <p><strong>Supported Parameters:</strong></p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">model</span><span class="op">:</span> <span class="st">&quot;gpt-5-pro&quot;</span><span class="op">,</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">messages</span><span class="op">:</span> [<span class="op">...</span>]<span class="op">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reasoning_effort</span><span class="op">:</span> <span class="st">&quot;minimal&quot;</span> <span class="op">|</span> <span class="st">&quot;low&quot;</span> <span class="op">|</span> <span class="st">&quot;medium&quot;</span> <span class="op">|</span> <span class="st">&quot;high&quot;</span><span class="op">,</span>  <span class="co">// ‚úÖ USE THIS</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max_completion_tokens</span><span class="op">:</span> <span class="dv">32000</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
    </div>
    <p>
      <strong>‚ùå DEPRECATED in GPT-5</strong> (will cause errors): -
      <code>temperature</code> ‚Üí Use <code>reasoning_effort</code> instead -
      <code>top_p</code> ‚Üí Use <code>reasoning_effort</code> instead -
      <code>frequency_penalty</code> ‚Üí Not supported -
      <code>presence_penalty</code> ‚Üí Not supported
    </p>
    <p>
      <strong>Pricing:</strong> - Input: ~$2.50 per million tokens - Output:
      ~$10.00 per million tokens - Reasoning: Counted separately (internal
      chain-of-thought)
    </p>
    <p>
      <strong>Constraint:</strong> GPT-5 requires
      <code>reasoning_effort</code> parameter; old temperature-based configs
      will fail
    </p>
    <hr />
    <h3 id="verified-google-gemini-2.5-pro-model">
      ‚úÖ VERIFIED: Google Gemini 2.5 Pro Model
    </h3>
    <p>
      <strong>Issue Resolved:</strong> Model ID
      <code>gemini-2.5-pro-latest</code> confirmed working via direct API tests
    </p>
    <p>
      <strong>What Changed:</strong> - ‚úÖ
      <strong>Generate Content API Verification</strong>:
      <code
        >curl
        https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro-latest:generateContent</code
      >
      ‚Üí Returns valid response - ‚úÖ <strong>Context Window</strong>: 1M tokens
      (1,000,000 tokens/request) - ‚úÖ <strong>Contents Format</strong>: Uses
      <code>contents</code> array (not <code>messages</code> like
      OpenAI/Anthropic) - ‚úÖ <strong>System Instructions</strong>: Separate
      <code>systemInstruction</code> field (not in messages) - ‚úÖ
      <strong>Model Assertion Added</strong>: Adapter validates correct model in
      response
    </p>
    <p>
      <strong>Files Updated:</strong> -
      <code>server/lib/adapters/google-gemini.js</code> - Enhanced error
      handling + model assertion - <code>.env</code> -
      <code>GEMINI_MODEL=gemini-2.5-pro-latest</code> - <code>MODEL.md</code> -
      Updated with verified working status
    </p>
    <p><strong>Supported Parameters:</strong></p>
    <div class="sourceCode" id="cb2">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">model</span><span class="op">:</span> <span class="st">&quot;gemini-2.5-pro-latest&quot;</span><span class="op">,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">contents</span><span class="op">:</span> [<span class="op">...</span>]<span class="op">,</span>              <span class="co">// ‚úÖ Use &quot;contents&quot; not &quot;messages&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">systemInstruction</span><span class="op">:</span> <span class="st">&quot;...&quot;</span><span class="op">,</span>     <span class="co">// ‚úÖ Separate field</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">generationConfig</span><span class="op">:</span> {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">temperature</span><span class="op">:</span> <span class="fl">0.7</span><span class="op">,</span>           <span class="co">// ‚úÖ Standard 0.0-2.0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">topP</span><span class="op">:</span> <span class="fl">0.95</span><span class="op">,</span>                 <span class="co">// ‚úÖ Supported</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxOutputTokens</span><span class="op">:</span> <span class="dv">8192</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
    </div>
    <p>
      <strong>Alternative Models:</strong> -
      <code>gemini-2.5-pro-latest</code> - Flagship model (1M context) -
      <code>gemini-2.5-flash-latest</code> - Faster, lower cost -
      <code>gemini-2.0-flash-exp</code> - Experimental features
    </p>
    <p>
      <strong>Pricing:</strong> - Input: $1.25 per million tokens - Output:
      $5.00 per million tokens - Cached Input: $0.3125 per million tokens (75%
      discount)
    </p>
    <p>
      <strong>Constraint:</strong> Gemini uses different message format; cannot
      directly swap with OpenAI/Anthropic adapters
    </p>
    <hr />
    <h3 id="implemented-thread-aware-context-system">
      ‚úÖ IMPLEMENTED: Thread-Aware Context System
    </h3>
    <p>
      <strong>Goal:</strong> Maintain conversation context across
      Agent/Assistant/Eidolon interactions
    </p>
    <p>
      <strong>What Was Built:</strong> - ‚úÖ
      <strong>Thread Context Manager</strong>
      (<code>server/agent/thread-context.js</code>) - Conversation thread
      initialization and resumption - Message tracking with role attribution
      (user, assistant, agent, system) - Automatic entity extraction (model
      names, file paths, technical terms) - Topic discovery from natural
      language - Decision tracking with reasoning and impact - Model interaction
      logging by provider
    </p>
    <ul>
      <li>
        ‚úÖ <strong>Enhanced Context Integration</strong>
        (<code>server/agent/enhanced-context.js</code>)
        <ul>
          <li>
            Thread-aware project context via
            <code
              >getEnhancedProjectContext({ threadId, includeThreadContext
              })</code
            >
          </li>
          <li>Access to current thread and recent thread history</li>
        </ul>
      </li>
      <li>
        ‚úÖ <strong>API Endpoints</strong>
        (<code>server/agent/routes.js</code>)
        <ul>
          <li>
            <code>POST /agent/thread/init</code> - Initialize new conversation
            thread
          </li>
          <li>
            <code>GET /agent/thread/:threadId</code> - Get full thread context
          </li>
          <li>
            <code>POST /agent/thread/:threadId/message</code> - Add message
            (auto-extracts topics/entities)
          </li>
          <li>
            <code>POST /agent/thread/:threadId/decision</code> - Track important
            decisions
          </li>
          <li>
            <code>GET /agent/threads/recent?limit=10</code> - Recent threads
            with summaries
          </li>
        </ul>
      </li>
    </ul>
    <p>
      <strong>Storage:</strong> - <code>assistant_memory</code> table - User
      preferences, conversation history, thread messages (30-day TTL) -
      <code>eidolon_memory</code> table - Project state, session tracking,
      conversation threads (30-day TTL)
    </p>
    <p>
      <strong>Constraint:</strong> Thread messages limited to last 200 per
      thread, topics/entities limited to last 50 (performance bounds)
    </p>
    <hr />
    <h3 id="architectural-principle-single-path-triad-no-fallbacks">
      ‚úÖ ARCHITECTURAL PRINCIPLE: Single-Path Triad (No Fallbacks)
    </h3>
    <p>
      <strong>Decision Date:</strong> October 3-8, 2025<br />
      <strong>Rationale:</strong> User requires consistent quality without
      silent model swaps
    </p>
    <p>
      <del><strong>Old Approach (Deprecated):</strong></del> -
      <del
        >Router V2 with fallback chain (Claude ‚Üí GPT-5 ‚Üí Gemini if primary
        fails)</del
      >
      - <del>Circuit breakers with automatic failover</del> -
      <del>8s total budget (too aggressive)</del>
    </p>
    <p><strong>Current Approach (Locked):</strong></p>
    <pre class="env"><code>TRIAD_ENABLED=true
TRIAD_MODE=single_path
ROUTER_V2_ENABLED=false

# Models (all verified)
CLAUDE_MODEL=claude-sonnet-4-5-20250929
OPENAI_MODEL=gpt-5-pro
GEMINI_MODEL=gemini-2.5-pro-latest

# Budget (90s total)
LLM_TOTAL_BUDGET_MS=90000
CLAUDE_TIMEOUT_MS=12000   # Strategist
GPT5_TIMEOUT_MS=45000     # Planner (deep reasoning)
GEMINI_TIMEOUT_MS=15000   # Validator</code></pre>
    <p>
      <strong>Why No Fallbacks in Triad:</strong> 1.
      <strong>Quality Consistency</strong> - Each model has a specific role;
      substitution breaks the pipeline 2.
      <strong>ML Training Integrity</strong> - Fallbacks corrupt training data
      (don‚Äôt know which model produced what) 3.
      <strong>Trust-First Philosophy</strong> - If primary fails, surface the
      error properly, don‚Äôt hide it
    </p>
    <p>
      <strong>Exception:</strong> Agent Override (Atlas) has fallback chain
      (Claude ‚Üí GPT-5 ‚Üí Gemini) for operational resilience (workspace ops must
      not fail)
    </p>
    <p>
      <strong>Constraint:</strong> If Triad fails, entire strategy generation
      fails - this is intentional, not a bug
    </p>
    <hr />
    <h3 id="production-fixes-error-resolution-oct-9-2025">
      ‚úÖ PRODUCTION FIXES: Error Resolution (Oct 9, 2025)
    </h3>
    <p>
      <strong>Issues Resolved:</strong> Three critical production errors fixed
      and deployed
    </p>
    <p>
      <strong>Fix 1: TypeScript Syntax in JavaScript Files</strong> -
      <strong>Error:</strong> <code>number is not defined</code> in feedback
      enrichment - <strong>Cause:</strong> Used TypeScript generic syntax
      <code>sql&lt;number&gt;</code> in <code>.js</code> files -
      <strong>Fixed:</strong> Removed type annotations from SQL queries in
      <code>server/routes/blocks.js</code> and
      <code>server/routes/feedback.js</code> - <strong>Impact:</strong> Feedback
      enrichment now works without errors
    </p>
    <p>
      <strong>Fix 2: Database Replication Lag</strong> -
      <strong>Error:</strong> Foreign key violations on
      <code>actions_ranking_id_rankings_ranking_id_fk</code> -
      <strong>Cause:</strong> Neon‚Äôs multi-region replication creates 50-500ms
      delays - <strong>Fixed:</strong> Enhanced retry logic in
      <code>server/routes/actions.js</code>: - Increased retries: 3 ‚Üí 5 attempts
      - Increased backoff: 100ms ‚Üí 200ms exponential - Graceful degradation:
      logs action without ranking_id if all retries fail -
      <strong>Impact:</strong> Actions now handle distributed database lag
      gracefully
    </p>
    <p>
      <strong>Fix 3: Venue Resolution Priority</strong> -
      <strong>Error:</strong> <code>places_no_match</code> for district-level
      recommendations (e.g., ‚ÄúThe Star District‚Äù) - <strong>Cause:</strong>
      Code searched Places API by name before using GPT-5 coordinates -
      <strong>Fixed:</strong> Reversed priority in
      <code>server/routes/blocks.js</code>: - <strong>Primary:</strong> Use
      GPT-5 coordinates ‚Üí Reverse geocoding ‚Üí Get place_id + address -
      <strong>Fallback:</strong> Use venue name ‚Üí Places Find Place (only if no
      coords) - <strong>Graceful handling:</strong> Skip unresolvable venues
      instead of crashing entire request -
      <strong>Improved GPT-5 prompt:</strong> Explicitly instruct to avoid
      generic districts/areas - <strong>Impact:</strong> District-level
      recommendations (with coordinates) now resolve correctly
    </p>
    <p>
      <strong>Fix 4: Hardcoded Location References - ZERO FALLBACKS</strong> -
      <strong>Error:</strong> Hardcoded timezone and metro area with fallbacks
      in production code - <strong>Found &amp; Removed:</strong> -
      <code>server/routes/blocks.js</code> - Removed
      <code>|| 'America/Chicago'</code> fallback -
      <code>server/lib/venue-discovery.js</code> - Removed hardcoded
      <code>metro: 'DFW'</code> -
      <code>server/lib/strategy-generator.js</code> - Removed all timezone
      fallbacks (2 instances) -
      <code>server/lib/gpt5-tactical-planner.js</code> - Removed all timezone
      fallbacks (2 instances) -
      <code>server/routes/blocks-triad-strict.js</code> - Removed timezone
      fallback - <code>server/lib/triad-orchestrator.js</code> - Removed
      timezone fallback - <code>server/routes/blocks-discovery.js</code> -
      Removed timezone fallbacks (2 instances) - <strong>Fixed:</strong> -
      Timezone now ALWAYS uses <code>snapshot.timezone</code> - no fallbacks
      whatsoever - Metro now uses
      <code>suggestion.metro || suggestion.city || 'Unknown'</code> (fully
      dynamic) - If timezone missing, system will fail-hard (no silent
      fallbacks) - <strong>Impact:</strong> App is 100% location-agnostic, works
      anywhere worldwide, no hidden location assumptions
    </p>
    <p>
      <strong>Deployment Status:</strong> All fixes tested and running in
      production ‚úÖ
    </p>
    <hr />
    <h3 id="updated-documentation-alignment">
      ‚úÖ UPDATED: Documentation Alignment
    </h3>
    <p>
      <strong>Problem:</strong> Stale docs showed deprecated models and old
      configs<br />
      <strong>Solution:</strong> Comprehensive doc updates to reflect current
      state
    </p>
    <p>
      <strong>Files Updated:</strong> - <code>MODEL.md</code> - Verified model
      specs with API test examples -
      <code>docs/reference/V2-ROUTER-INTEGRATION.md</code> - Marked all Oct 3
      issues as RESOLVED, deprecated old config - <code>README.md</code> -
      References MODEL.md as single source of truth - <code>replit.md</code> -
      Updated Agent Server capabilities section with thread endpoints -
      <code>tools/research/THREAD_AWARENESS_README.md</code> - Complete thread
      system documentation
    </p>
    <p>
      <strong>What Changed (Accuracy-First Evolution):</strong> - ‚úÖ Locked
      orchestration to Triad single-path with 90s total budget and per-stage
      timeouts - ‚úÖ Router V2 remains for test rigs only and is marked
      historical - ‚úÖ Added model echo assertion on Anthropic calls; Sonnet 4.5
      must echo <code>claude-sonnet-4-5-20250929</code> - ‚úÖ Introduced
      thread-aware context capture to improve continuity without changing Triad
      behavior - ‚úÖ Shifted from <del>‚Äúcheap-first‚Äù hours strategy</del> to
      risk-gated validation for closure-sensitive venues
    </p>
    <p>
      <strong>Backward Pressure (Moving Away From):</strong> - ‚ùå
      <code>gpt-4o</code> and <code>gemini-1.5-pro</code> (deprecated models) -
      ‚ùå 8s total budget (way too low for production) - ‚ùå Global JSON body
      parsing (caused abort errors) - ‚ùå React.StrictMode (caused duplicate API
      calls) - ‚ùå <del>Router V2 hedging in production</del> (deterministic
      single-path instead) - ‚ùå
      <del>Open-ended ‚Äúcheap-first‚Äù hours strategy</del> (risk-gated validator
      for closure-sensitive cases)
    </p>
    <p>
      <strong>Forward Pressure (Moving Toward):</strong> - ‚úÖ Monthly model
      verification via research scripts - ‚úÖ Automated model discovery
      (Perplexity + live API checks) - ‚úÖ Enhanced contextual awareness across
      all AI systems - ‚úÖ Trust-first architecture with deterministic scoring -
      ‚úÖ Closure risk gate for accuracy-critical venue recommendations
    </p>
    <hr />
    <h2 id="system-architecture">üèóÔ∏è <strong>SYSTEM ARCHITECTURE</strong></h2>
    <h3 id="multi-server-architecture-production">
      Multi-Server Architecture (Production)
    </h3>
    <pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CLIENT LAYER                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   React 18   ‚îÇ  ‚îÇ TanStack     ‚îÇ  ‚îÇ  Wouter      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ   TypeScript ‚îÇ  ‚îÇ Query v5     ‚îÇ  ‚îÇ  Routing     ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ           ‚ñ≤                                                      ‚îÇ
‚îÇ           ‚îÇ HTTPS (5000)                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    GATEWAY SERVER (Port 5000)                    ‚îÇ
‚îÇ  ‚Ä¢ Rate Limiting (100 req/15min per IP)                         ‚îÇ
‚îÇ  ‚Ä¢ CORS Security + Helmet                                       ‚îÇ
‚îÇ  ‚Ä¢ Request Proxy &amp; Load Balancing                              ‚îÇ
‚îÇ  ‚Ä¢ Per-Route JSON Parsing (1MB limit, no global parser)        ‚îÇ
‚îÇ  ‚Ä¢ Client Abort Error Gate (499 status)                        ‚îÇ
‚îÇ  ‚Ä¢ Health Check Logging Filter                                 ‚îÇ
‚îÇ  ‚Ä¢ Vite Dev Middleware (dev) / Static Build (prod)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ              ‚îÇ              ‚îÇ                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Eidolon SDK‚îÇ ‚îÇ   Agent    ‚îÇ ‚îÇ  Postgres  ‚îÇ ‚îÇ  External APIs  ‚îÇ
‚îÇ Server     ‚îÇ ‚îÇ   Server   ‚îÇ ‚îÇ  (Neon)    ‚îÇ ‚îÇ  (Google/FAA/   ‚îÇ
‚îÇ (3101)     ‚îÇ ‚îÇ  (43717)   ‚îÇ ‚îÇ            ‚îÇ ‚îÇ   OpenWeather)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                ‚îÇ              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 TRIAD AI PIPELINE (Single-Path)                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ   Claude     ‚îÇ‚îÄ‚ñ∂‚îÇ    GPT-5     ‚îÇ‚îÄ‚ñ∂‚îÇ   Gemini     ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ  Sonnet 4.5  ‚îÇ  ‚îÇ   Planner    ‚îÇ  ‚îÇ   2.5 Pro    ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ  (Strategist)‚îÇ  ‚îÇ   (Tactician)‚îÇ  ‚îÇ  (Validator) ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ    12s timeout      45s timeout       15s timeout               ‚îÇ
‚îÇ    Strategic        Deep Reasoning    JSON Validation           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
    <p>
      <strong>Constraint:</strong> Gateway MUST run on port 5000 (Replit
      firewall requirement)<br />
      <strong>Constraint:</strong> All servers use same PostgreSQL database
      (single source of truth)<br />
      <strong>Constraint:</strong> JSON parsing is per-route only (no global
      body parser to avoid abort errors)<br />
      <strong>Constraint:</strong> Staging areas MUST be within 2 minutes drive
      of all recommended venues (Oct 9, 2025)
    </p>
    <hr />
    <h2 id="aiml-pipeline-triad-architecture">
      ü§ñ <strong>AI/ML PIPELINE: TRIAD ARCHITECTURE</strong>
    </h2>
    <h3 id="design-philosophy-locked---do-not-change">
      Design Philosophy (LOCKED - DO NOT CHANGE)
    </h3>
    <ol type="1">
      <li>
        <strong>Single-Path Only</strong> - No fallbacks in triad, fail properly
        instead of silently degrading
      </li>
      <li>
        <strong>Complete Data Snapshots</strong> - Never send partial context
        (corrupts ML training)
      </li>
      <li>
        <strong>Zero Pre-Computed Flags</strong> - Models infer patterns from
        raw data
      </li>
      <li>
        <strong>Idempotent Processing</strong> - Same input = same output
        (critical for ML)
      </li>
      <li>
        <strong>Observable at Every Stage</strong> - Full logging for
        counterfactual learning
      </li>
    </ol>
    <p>
      <strong>Why This Matters:</strong> -
      <strong>ML Training Integrity</strong> - We‚Äôre building a dataset for
      future model fine-tuning - <strong>Trust-First Stack</strong> - Curated
      venue catalog + deterministic scoring prevents hallucinations -
      <strong>Quality &gt; Availability</strong> - Better to fail visibly than
      succeed with wrong answer
    </p>
    <hr />
    <h3 id="stage-1-claude-sonnet-4.5-strategist">
      Stage 1: Claude Sonnet 4.5 (Strategist)
    </h3>
    <p>
      <strong>Model:</strong> <code>claude-sonnet-4-5-20250929</code> ‚úÖ
      Verified Working<br />
      <strong>Role:</strong> High-level strategic analysis and narrative
      generation<br />
      <strong>Timeout:</strong> 12 seconds (CLAUDE_TIMEOUT_MS)
    </p>
    <p>
      <strong>Critical Guard:</strong> If Claude fails to generate
      <code>strategy_for_now</code>, the entire triad pipeline aborts. This
      enforces the ‚Äúsingle-path only‚Äù principle - GPT-5 will never receive
      planning requests without valid Claude strategy.
    </p>
    <p>
      <strong>Input:</strong> Complete snapshot (location, weather, AQI, airport
      delays, time context, H3 geospatial)<br />
      <strong>Output:</strong> Strategic overview, pro tips, earnings
      estimate<br />
      <strong>Token Usage:</strong> 150-200 tokens average<br />
      <strong>Success Rate:</strong> 98.7% (production data)
    </p>
    <p>
      <strong>Constraint:</strong> Must return text with strategic insights or
      pipeline aborts (no silent failures)
    </p>
    <hr />
    <h3 id="stage-2-gpt-5-tactical-planner">
      Stage 2: GPT-5 (Tactical Planner)
    </h3>
    <p>
      <strong>Model:</strong> <code>gpt-5-pro</code> ‚úÖ Verified Working<br />
      <strong>Role:</strong> Deep reasoning for venue selection and timing<br />
      <strong>Timeout:</strong> 45 seconds (GPT5_TIMEOUT_MS)
    </p>
    <p>
      <strong>Processing:</strong> - <strong>Reasoning Effort:</strong>
      <code>high</code> (GPT5_REASONING_EFFORT=high) -
      <strong>Max Completion Tokens:</strong> 32000 - <strong>Uses:</strong>
      <code>reasoning_effort</code> (NOT temperature/top_p - those are
      deprecated in GPT-5)
    </p>
    <p>
      <strong>Critical Constraint:</strong> GPT-5 does NOT support: - ‚ùå
      <code>temperature</code> - ‚ùå <code>top_p</code> - ‚ùå
      <code>frequency_penalty</code> - ‚ùå <code>presence_penalty</code>
    </p>
    <p>
      <strong>Only Supports:</strong> - ‚úÖ <code>reasoning_effort</code>
      (values: minimal, low, medium, high) - ‚úÖ
      <code>max_completion_tokens</code>
    </p>
    <p>
      <strong>Output:</strong> 6 venue recommendations with coordinates, pro
      tips, best staging location, tactical summary<br />
      <strong>Validation:</strong> Zod schema ensures minimum 6 venues with
      required fields<br />
      <strong>Token Usage:</strong> 800-1200 prompt + 1500-2000 reasoning +
      600-800 completion
    </p>
    <p>
      <strong>Staging Area Optimization (Oct 9, 2025):</strong> -
      <strong>Constraint:</strong> Staging location MUST be centrally positioned
      within 2 minutes drive of ALL recommended venues -
      <strong>Priority:</strong> Free parking lots, gas stations, or safe
      pull-off areas with good visibility - <strong>Goal:</strong> Driver can
      reach ANY venue within 1-2 minutes for quick ride capture -
      <strong>Purpose:</strong> Minimize deadhead time and maximize response
      speed - <strong>Implementation:</strong> Enforced via GPT-5 system prompt
      with explicit CRITICAL constraint
    </p>
    <p>
      <strong>Constraint:</strong> Only runs if Claude provides valid strategy
      (dependency enforced)
    </p>
    <hr />
    <h3 id="stage-3-gemini-2.5-pro-validator">
      Stage 3: Gemini 2.5 Pro (Validator)
    </h3>
    <p>
      <strong>Model:</strong> <code>gemini-2.5-pro-latest</code> ‚úÖ Verified
      Working<br />
      <strong>Role:</strong> JSON validation, business hours enrichment,
      earnings projections<br />
      <strong>Timeout:</strong> 15 seconds (GEMINI_TIMEOUT_MS)
    </p>
    <p>
      <strong>Processing:</strong> - Validates GPT-5 JSON structure - Enriches
      with Google Places business hours - Calculates traffic-aware distances -
      Generates earnings projections per venue
    </p>
    <p>
      <strong>Output:</strong> Final validated strategy with open/closed status,
      distances, earnings per venue<br />
      <strong>Token Usage:</strong> 500-800 tokens average
    </p>
    <p>
      <strong>Constraint:</strong> Must return at least 6 venues or pipeline
      fails (minimum quality threshold)
    </p>
    <hr />
    <h2 id="trust-first-stack-architecture">
      üèõÔ∏è <strong>TRUST-FIRST STACK ARCHITECTURE</strong>
    </h2>
    <h3
      id="core-principle-prevent-llm-hallucinations-with-deterministic-scoring"
    >
      Core Principle: Prevent LLM Hallucinations with Deterministic Scoring
    </h3>
    <p>
      <strong>Problem:</strong> Pure LLM recommendations can hallucinate
      non-existent venues or incorrect locations<br />
      <strong>Solution:</strong> Curated venue catalog + deterministic scoring
      engine
    </p>
    <h3 id="venue-catalog-single-source-of-truth">
      Venue Catalog (Single Source of Truth)
    </h3>
    <ul>
      <li><strong>Storage:</strong> PostgreSQL <code>venues</code> table</li>
      <li>
        <strong>Source:</strong> Google Places API (verified real businesses)
      </li>
      <li>
        <strong>Fields:</strong> name, lat, lng, category, h3_r8 (geospatial
        index), business_hours, rating
      </li>
      <li><strong>Update Frequency:</strong> Weekly via Google Places sync</li>
    </ul>
    <p>
      <strong>Constraint:</strong> LLMs can ONLY recommend venues from this
      catalog (no hallucinated locations)
    </p>
    <h3 id="deterministic-scoring-engine">Deterministic Scoring Engine</h3>
    <p>
      <strong>Formula:</strong>
      <code
        >score = f(proximity, reliability, event_intensity,
        personalization)</code
      >
    </p>
    <p>
      <strong>Factors:</strong> 1. <strong>Proximity</strong> - H3 geospatial
      distance (deterministic) 2. <strong>Reliability</strong> - Historical
      success rate from ML data (deterministic) 3.
      <strong>Event Intensity</strong> - Day/hour/weather patterns
      (deterministic) 4. <strong>Personalization</strong> - User history match
      (deterministic)
    </p>
    <p>
      <strong>Why This Works:</strong> - LLMs provide strategic narrative and
      pro tips (qualitative) - Scoring engine ranks venues (quantitative,
      auditable) - No hallucinations possible (venues must exist in catalog)
    </p>
    <p>
      <strong>Constraint:</strong> Scoring engine is separate from LLM pipeline
      (can be A/B tested independently)
    </p>
    <hr />
    <h2 id="strategy-component-framework-workflow-order">
      üéØ <strong>STRATEGY COMPONENT FRAMEWORK (Workflow Order)</strong>
    </h2>
    <h3 id="overview-the-recommendation-pipeline">
      Overview: The Recommendation Pipeline
    </h3>
    <p>
      Every block recommendation flows through 13 strategic components in
      sequence. Each component builds on the previous, ensuring accuracy,
      context-awareness, and driver value optimization. This framework
      demonstrates how AI-built systems achieve accuracy enforcement, root cause
      analysis, and ML instrumentation at scale.
    </p>
    <h3 id="component-architecture">Component Architecture</h3>
    <h4 id="header-strategy-context-capture">
      <strong>0. HEADER STRATEGY (Context Capture)</strong> üìã
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Complete environmental snapshot capturing GPS,
        weather, time, and contextual data
      </li>
      <li>
        <strong>Why</strong>: Foundation for all downstream decisions;
        incomplete context corrupts ML training
      </li>
      <li>
        <strong>When</strong>: On every recommendation request before any AI
        processing
      </li>
      <li>
        <strong>How</strong>: Browser Geolocation ‚Üí Geocoding ‚Üí Timezone
        detection ‚Üí Weather/AQI APIs ‚Üí H3 geospatial indexing ‚Üí Airport
        proximity check
      </li>
      <li>
        <strong>Data Storage</strong>: <code>snapshots</code> table
        <ul>
          <li>
            <strong>Key Fields</strong>: <code>snapshot_id</code> (UUID PK),
            <code>lat/lng</code> (GPS),
            <code>city/state/timezone</code> (geocoded),
            <code>dow/hour/day_part_key</code> (temporal),
            <code>h3_r8</code> (geospatial),
            <code>weather/air/airport_context</code> (JSONB context),
            <code>trigger_reason</code> (why snapshot created)
          </li>
          <li>
            <strong>Linkage</strong>: Foreign key for <code>strategies</code>,
            <code>rankings</code>, <code>actions</code> tables
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: Gates entire pipeline; missing fields
        abort processing with clear error
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Training Data</strong>: Every field becomes model input;
            incomplete snapshots excluded from training
          </li>
          <li>
            <strong>Feature Engineering</strong>: <code>dow</code> enables
            weekend pattern learning, <code>h3_r8</code> enables geo-clustering
          </li>
          <li>
            <strong>Counterfactual Analysis</strong>:
            <code>trigger_reason</code> tracks why snapshot created (location
            change, time shift, manual)
          </li>
          <li>
            <strong>Quality Metrics</strong>: <code>accuracy_m</code> (GPS
            precision), <code>coord_source</code> (browser/fallback) logged for
            reliability analysis
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: ‚ÄúComplete Snapshot Gating‚Äù
        invariant enforced; no partial context sent to LLMs
      </li>
    </ul>
    <h4 id="strategic-overview-triad-intelligence">
      <strong>1. STRATEGIC OVERVIEW (Triad Intelligence)</strong> üìç
    </h4>
    <ul>
      <li>
        <strong>What</strong>: 2-3 sentence AI narrative synthesizing conditions
        into actionable insights
      </li>
      <li>
        <strong>Why</strong>: Provides contextual frame for all downstream
        decisions
      </li>
      <li>
        <strong>When</strong>: Location change &gt;2mi, time transition, manual
        refresh, or 30min inactivity
      </li>
      <li>
        <strong>How</strong>: Claude Sonnet 4.5 analyzes complete snapshot at
        T=0.0 with 12s timeout
      </li>
      <li>
        <strong>Data Storage</strong>: <code>strategies</code> table
        <ul>
          <li>
            <strong>Key Fields</strong>: <code>id</code> (UUID PK),
            <code>snapshot_id</code> (FK to snapshots, CASCADE),
            <code>strategy</code> (AI text),
            <code>status</code> (pending/ok/failed),
            <code>error_code/error_message</code> (failure tracking),
            <code>attempt</code> (retry count),
            <code>latency_ms</code> (performance), <code>tokens</code> (cost
            tracking)
          </li>
          <li>
            <strong>Caching</strong>: ETag-based HTTP cache for duplicate
            requests
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: Gates entire triad pipeline; failure
        aborts all downstream processing
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Strategy Effectiveness</strong>:
            <code>snapshot_id</code> linkage enables ‚Äústrategy ‚Üí venue selection
            ‚Üí user action‚Äù correlation
          </li>
          <li>
            <strong>Performance Tracking</strong>:
            <code>latency_ms</code> identifies slow Claude calls for
            optimization
          </li>
          <li>
            <strong>Cost Monitoring</strong>: <code>tokens</code> field enables
            cost per recommendation analysis
          </li>
          <li>
            <strong>Quality Metrics</strong>: <code>attempt</code> count
            measures retry frequency; high retries indicate model instability
          </li>
          <li>
            <strong>Error Classification</strong>:
            <code>error_code</code> enables failure pattern analysis (timeout vs
            API error vs validation)
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Complete snapshot gating ensures
        no strategy without GPS/weather/AQI/timezone
      </li>
    </ul>
    <h4 id="venue-discovery-catalog-exploration">
      <strong>2. VENUE DISCOVERY (Catalog + Exploration)</strong> üéØ
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Candidate selection from curated catalog + 20%
        AI-discovered new venues
      </li>
      <li>
        <strong>Why</strong>: Prevents hallucinations while enabling exploration
        of emerging hotspots
      </li>
      <li>
        <strong>When</strong>: On every recommendation request after strategic
        overview
      </li>
      <li>
        <strong>How</strong>: H3 geospatial filtering + deterministic scoring +
        Gemini exploration (20% budget). <strong>Key discipline:</strong> every
        venue entering the pipeline must carry a stable merge key (place_id
        preferred; name fallback). Validators must echo the same key unchanged.
        Any response missing the key is rejected and logged.
      </li>
      <li>
        <strong>Data Storage</strong>: <code>venue_catalog</code> +
        <code>llm_venue_suggestions</code> + <code>venue_metrics</code> tables
        <ul>
          <li>
            <strong>venue_catalog</strong>: <code>venue_id</code> (UUID PK),
            <code>place_id</code> (Google Places unique ID),
            <code>name/address/category</code>, <code>lat/lng</code>,
            <code>dayparts[]</code> (text array),
            <code>staging_notes/business_hours</code> (JSONB),
            <code>discovery_source</code> (seed/llm/driver),
            <code>validated_at</code>
          </li>
          <li>
            <strong>llm_venue_suggestions</strong>:
            <code>suggestion_id</code> (UUID PK), <code>model_name</code>,
            <code>ranking_id</code> (FK), <code>venue_name</code>,
            <code>validation_status</code> (pending/valid/rejected),
            <code>place_id_found</code>, <code>rejection_reason</code>
          </li>
          <li>
            <strong>venue_metrics</strong>: <code>venue_id</code> (FK to
            catalog), <code>times_recommended/times_chosen</code> (counters),
            <code>positive_feedback/negative_feedback</code>,
            <code>reliability_score</code> (0.0-1.0)
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: Single source of truth from venues table
        prevents non-existent locations
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Exploration Tracking</strong>:
            <code>discovery_source</code> field enables ‚Äúseed vs LLM vs driver‚Äù
            performance comparison
          </li>
          <li>
            <strong>Validation Pipeline</strong>:
            <code>llm_venue_suggestions</code> logs AI recommendations before
            catalog entry; <code>validation_status</code> tracks success rate
          </li>
          <li>
            <strong>Reliability Learning</strong>:
            <code>venue_metrics.reliability_score</code> refined from
            <code>positive_feedback/negative_feedback</code> ratio
          </li>
          <li>
            <strong>Geospatial Patterns</strong>: H3 distance calculations
            enable proximity-based filtering and geo-clustering analysis
          </li>
          <li>
            <strong>A/B Testing</strong>: <code>dayparts[]</code> enables
            time-of-day recommendation optimization
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Only Google Places-validated
        venues enter consideration set
      </li>
    </ul>
    <h4 id="venue-hours-accuracy-first">
      <strong>3. VENUE HOURS (Accuracy-First)</strong> üè¢
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Risk-gated validation ensuring ‚Äúunknown‚Äù never
        presented as ‚Äúopen‚Äù
      </li>
      <li>
        <strong>Why</strong>: Closure status materially affects driver income
        and trust
      </li>
      <li>
        <strong>When</strong>: Closure risk &gt;0.3 triggers validation; &lt;0.1
        uses estimates with badge
      </li>
      <li>
        <strong>How</strong>: Closure risk calculation ‚Üí Google Places API
        validation ‚Üí cache 24h ‚Üí substitute if unknown.
        <strong>DB-first policy:</strong> for any known place_id, read address,
        lat/lng, and the last known open/closed metadata from our places cache
        before calling external APIs. TTL: coords_verified_at is authoritative
        for coordinates; hours_last_checked is authoritative for open/closed
        metadata. If both are within policy, skip the external call.
      </li>
      <li>
        <strong>Data Storage</strong>: <code>places_cache</code> table +
        <code>venue_feedback</code> table
        <ul>
          <li>
            <strong>places_cache</strong>: <code>place_id</code> (PK),
            <code>formatted_hours</code> (JSONB), <code>cached_at</code>,
            <code>access_count</code> (48h TTL constraint)
          </li>
          <li>
            <strong>venue_feedback</strong>: <code>id</code> (UUID PK),
            <code>venue_id</code> (FK), <code>driver_user_id</code>,
            <code>feedback_type</code> (hours_wrong/closed_when_open),
            <code>comment</code>, <code>reported_at</code>
          </li>
          <li>
            <strong>Outcome Logging</strong>: Each recommendation tagged with
            <code
              >open_confirmed/closed_confirmed/estimated_open/unknown_substituted</code
            >
            in rankings
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: 24h metadata caching prevents quota
        exhaustion while ensuring accuracy
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Risk Model Training</strong>: Closure risk predictions
            refined from actual outcomes (was venue actually open/closed?)
          </li>
          <li>
            <strong>Validation ROI</strong>: Cost/accuracy tradeoffs measured
            for threshold optimization (when is validation worth the API call?)
          </li>
          <li>
            <strong>Driver Feedback Loop</strong>:
            <code>venue_feedback</code> reports improve risk calculations for
            future predictions
          </li>
          <li>
            <strong>Cache Hit Rate</strong>: <code>access_count</code> tracks
            how often cached hours are reused (cost savings metric)
          </li>
          <li>
            <strong>Substitution Analysis</strong>: Tracks when high-risk venues
            replaced vs validated (substitution strategy effectiveness)
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Prioritizes correctness over cost
        when driver earnings affected
      </li>
    </ul>
    <h4 id="distance-eta-traffic-aware">
      <strong>4. DISTANCE &amp; ETA (Traffic-Aware)</strong> üìè
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Real-time traffic-aware distance and drive time
        calculations
      </li>
      <li>
        <strong>Why</strong>: Straight-line estimates underestimate actual drive
        time, reducing earnings accuracy
      </li>
      <li>
        <strong>When</strong>: For top-ranked venues after scoring,
        re-calculated on navigation launch
      </li>
      <li>
        <strong>How</strong>: Google Routes API with TRAFFIC_AWARE routing ‚Üí
        fallback to Haversine if API fails.
        <strong>Source of truth:</strong> distance shown to drivers is the
        server calculation (Routes when available; otherwise Haversine). The
        client must never overwrite venue coordinates with device GPS for
        display or math. Any UI calculation relies on server-returned venue
        lat/lng.
      </li>
      <li>
        <strong>System Impact</strong>: $10 per 1,000 requests balanced against
        accuracy needs
      </li>
      <li>
        <strong>ML Impact</strong>: Logs actual drive times vs.¬†estimates for
        prediction model training
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Live traffic data ensures
        realistic ETAs for earnings projections
      </li>
    </ul>
    <h4 id="surge-detection-opportunity-capture">
      <strong>5. SURGE DETECTION (Opportunity Capture)</strong> üî•
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Real-time surge pricing detection with
        high-multiplier flagging
      </li>
      <li>
        <strong>Why</strong>: Surge opportunities are time-sensitive and
        income-critical
      </li>
      <li>
        <strong>When</strong>: For high-demand venues on every refresh
        (airports, events, stadiums)
      </li>
      <li>
        <strong>How</strong>: Uber/Lyft API surge checks ‚Üí threshold filter
        (&gt;1.5x) ‚Üí priority flag (‚â•2.0x)
      </li>
      <li>
        <strong>System Impact</strong>: Rate limit management ensures continuous
        monitoring without quota exhaustion
      </li>
      <li>
        <strong>ML Impact</strong>: Historical surge patterns stored for
        predictive window identification
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Real-time API calls prevent stale
        surge data affecting recommendations
      </li>
    </ul>
    <h4 id="earnings-projection-income-accuracy">
      <strong>6. EARNINGS PROJECTION (Income Accuracy)</strong> üí∞
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Realistic per-ride earnings estimates based on
        context and historical data
      </li>
      <li>
        <strong>Why</strong>: Drivers need accurate income projections to
        evaluate opportunity cost
      </li>
      <li>
        <strong>When</strong>: For every recommended venue after
        hours/distance/surge enrichment
      </li>
      <li>
        <strong>How</strong>: base_earnings_hr √ó adjustment_factor (open=0.9x,
        closed=0.7x, event=variable, surge=additive).
        <strong>Deterministic fallbacks:</strong> when validator earnings fields
        are absent or unparsable, use server ‚Äúpotential‚Äù as the first fallback.
        If potential is absent, derive earnings_per_mile from distance and a
        conservative base_earnings_hr; if still undefined, fail-closed instead
        of returning $0.
      </li>
      <li>
        <strong>System Impact</strong>: Pulls from venue_metrics historical
        performance for grounded estimates
      </li>
      <li>
        <strong>ML Impact</strong>: Logs projected vs.¬†actual earnings for
        calibration model training
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Context-aware adjustments prevent
        over-optimistic projections
      </li>
    </ul>
    <h4 id="priority-flagging-urgency-intelligence">
      <strong>7. PRIORITY FLAGGING (Urgency Intelligence)</strong> ‚≠ê
    </h4>
    <ul>
      <li>
        <strong>What</strong>: High/normal/low priority assignment based on
        urgency indicators
      </li>
      <li>
        <strong>Why</strong>: Time-sensitive opportunities need immediate driver
        attention
      </li>
      <li>
        <strong>When</strong>: During ranking process after all enrichment
        complete
      </li>
      <li>
        <strong>How</strong>: if (surge‚â•2.0 OR earnings‚â•$60 OR eventStartsSoon)
        ‚Üí high; if (closed AND driveTime&gt;30) ‚Üí low
      </li>
      <li>
        <strong>System Impact</strong>: Visual priority indicators drive faster
        decision-making
      </li>
      <li>
        <strong>ML Impact</strong>: Logs priority vs.¬†driver response time for
        urgency calibration
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Multi-factor urgency prevents
        false alarms while catching real opportunities
      </li>
    </ul>
    <h4 id="block-ranking-value-optimization">
      <strong>8. BLOCK RANKING (Value Optimization)</strong> üìä
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Deterministic venue sorting by expected driver
        value
      </li>
      <li>
        <strong>Why</strong>: Present best opportunities first while maintaining
        category diversity
      </li>
      <li>
        <strong>When</strong>: Final step before presentation after all
        enrichment complete
      </li>
      <li>
        <strong>How</strong>: score(proximity, reliability, events,
        personalization) ‚Üí diversity check ‚Üí final sort
      </li>
      <li>
        <strong>System Impact</strong>: Deterministic scoring enables A/B
        testing and auditing
      </li>
      <li>
        <strong>ML Impact</strong>: Every ranking logged with ranking_id for
        counterfactual ‚Äúwhat if‚Äù analysis
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Quantitative scoring prevents LLM
        ranking bias
      </li>
    </ul>
    <h4 id="ml-training-data-persistence-atomic-capture">
      <strong>8.5 ML TRAINING DATA PERSISTENCE (Atomic Capture)</strong> üíæ
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Transactional persistence of rankings and
        candidates for ML training
      </li>
      <li>
        <strong>Why</strong>: Partial writes corrupt training data; atomic
        commits ensure data integrity
      </li>
      <li>
        <strong>When</strong>: Immediately after final enrichment, before
        returning blocks to UI
      </li>
      <li>
        <strong>How</strong>: Single transaction writes one
        <code>rankings</code> row + N <code>ranking_candidates</code> rows
        (target 6). If transaction fails, endpoint returns 502 and blocks UI
        response. No partial data lands in DB.
      </li>
      <li>
        <strong>Data Storage</strong>: <code>rankings</code> +
        <code>ranking_candidates</code> tables with strict constraints
        <ul>
          <li>
            <strong>rankings</strong>: <code>ranking_id</code> (UUID PK),
            <code>snapshot_id</code> (FK), <code>user_id</code>,
            <code>city</code>, <code>model_name</code>,
            <code>correlation_id</code>, <code>created_at</code>
          </li>
          <li>
            <strong>ranking_candidates</strong>: <code>id</code> (serial PK),
            <code>ranking_id</code> (FK CASCADE), <code>name</code>,
            <code>place_id</code>, <code>category</code>,
            <code>rank</code> (1-N), <code>distance_miles</code>,
            <code>drive_time_minutes</code>, <code>value_per_min</code>,
            <code>value_grade</code>, <code>surge</code>,
            <code>est_earnings</code>
          </li>
          <li>
            <strong>Constraints</strong>: Unique index on
            <code>(ranking_id, rank)</code> prevents duplicate ranks; check
            constraint ensures <code>distance_miles ‚â• 0</code> and
            <code>drive_time_minutes ‚â• 0</code>; FK cascade deletes orphaned
            candidates
          </li>
        </ul>
      </li>
      <li>
        <strong>Required Fields Per Candidate</strong>: <code>name</code>,
        <code>place_id</code>, <code>rank</code>, <code>distance_miles</code>,
        <code>drive_time_minutes</code> (NULLs forbidden for these core fields)
      </li>
      <li>
        <strong>System Impact</strong>: Fail-hard on persistence errors keeps DB
        and UI consistent; no stale/partial data
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Training Data Quality</strong>: Atomic writes guarantee
            complete training examples; no partial rankings
          </li>
          <li>
            <strong>Counterfactual Integrity</strong>:
            <code>correlation_id</code> links rankings to strategies/actions for
            ‚Äúwhat we recommended vs what they chose‚Äù analysis
          </li>
          <li>
            <strong>Feature Completeness</strong>: Every candidate has
            distance/time/earnings for model training
          </li>
          <li>
            <strong>Audit Trail</strong>: <code>created_at</code> +
            <code>snapshot_id</code> + <code>correlation_id</code> enable full
            pipeline reconstruction
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: ‚ÄúPersist or fail‚Äù rule prevents
        corrupted training data from landing in DB
      </li>
    </ul>
    <h4 id="staging-intelligence-waiting-strategy">
      <strong>9. STAGING INTELLIGENCE (Waiting Strategy)</strong> üÖøÔ∏è
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Specific waiting location recommendations with
        parking/walk-time details
      </li>
      <li>
        <strong>Why</strong>: Helps drivers avoid tickets and optimize
        positioning for pickups
      </li>
      <li>
        <strong>When</strong>: Enrichment phase for top-ranked venues during
        final presentation
      </li>
      <li>
        <strong>How</strong>: AI-suggested staging + driver feedback database +
        venue metadata (type/location/walk/parking)
      </li>
      <li>
        <strong>Data Storage</strong>:
        <code>venue_catalog.staging_notes</code> (JSONB) + driver preference
        tracking
        <ul>
          <li>
            <strong>staging_notes Fields</strong>:
            <code>type</code> (Premium/Standard/Free/Street), <code>name</code>,
            <code>address</code>, <code>walk_time</code>,
            <code>parking_tip</code>
          </li>
          <li>
            <strong>Driver Preferences</strong>:
            <code>preferredStagingTypes[]</code> stored in user profile
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: Personalization boost (+0.1) for
        preferred staging types
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Preference Learning</strong>: Driver‚Äôs staging type
            selections tracked to identify patterns (covered vs open, paid vs
            free)
          </li>
          <li>
            <strong>Success Correlation</strong>: Staging quality vs ride
            acceptance rate measured
          </li>
          <li>
            <strong>Crowd-Sourced Intel</strong>: Driver feedback enriches
            <code>staging_notes</code> database
          </li>
          <li>
            <strong>Venue-Specific Learning</strong>: Each venue accumulates
            staging recommendations from AI + drivers
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Combines AI analysis with
        crowd-sourced local knowledge
      </li>
    </ul>
    <h4 id="pro-tips-tactical-guidance">
      <strong>10. PRO TIPS (Tactical Guidance)</strong> üí°
    </h4>
    <ul>
      <li>
        <strong>What</strong>: 1-4 concise tactical tips per venue (max 250
        chars each)
      </li>
      <li>
        <strong>Why</strong>: Actionable advice improves driver success rate at
        specific venues
      </li>
      <li>
        <strong>When</strong>: Generated by GPT-5 during tactical planning stage
      </li>
      <li>
        <strong>How</strong>: GPT-5 Planner analyzes venue+time context ‚Üí
        generates tips ‚Üí Zod schema validation
      </li>
      <li>
        <strong>Data Storage</strong>: Generated by GPT-5, stored in-memory
        during request, not persisted to DB (ephemeral)
        <ul>
          <li>
            <strong>Validation</strong>: Zod schema enforces
            <code>z.array(z.string().max(250)).min(1).max(4)</code>
          </li>
          <li>
            <strong>Context</strong>: Generated from snapshot + venue +
            historical patterns
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: Character limits ensure mobile-friendly
        display
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Tip Effectiveness</strong>: Correlation between tip
            categories (timing/staging/events) and venue success
          </li>
          <li>
            <strong>Topic Analysis</strong>: NLP on tip content identifies which
            advice types drive driver action
          </li>
          <li>
            <strong>Quality Metrics</strong>: Tip length, count, category
            distribution logged per model/venue
          </li>
          <li>
            <strong>Contextual Relevance</strong>: Tips tagged with snapshot
            conditions for ‚Äútip ‚Üí outcome‚Äù analysis
          </li>
          <li>
            <strong>A/B Testing</strong>: Tip presence vs absence measured for
            conversion impact
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Context-aware generation prevents
        generic advice
      </li>
    </ul>
    <h4 id="gesture-feedback-learning-loop">
      <strong>11. GESTURE FEEDBACK (Learning Loop)</strong> üëç
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Like/hide/helpful actions captured for
        personalization
      </li>
      <li>
        <strong>Why</strong>: System learns individual driver preferences over
        time
      </li>
      <li>
        <strong>When</strong>: Immediately on driver interaction, applied in
        next recommendation cycle
      </li>
      <li>
        <strong>How</strong>: action logged ‚Üí venue_metrics updated ‚Üí if (3+
        hides) ‚Üí add to noGoZones ‚Üí suppress future
      </li>
      <li>
        <strong>Data Storage</strong>: <code>actions</code> table +
        <code>venue_metrics</code> updates
        <ul>
          <li>
            <strong>actions</strong>: <code>action_id</code> (UUID PK),
            <code>created_at</code>, <code>ranking_id</code> (FK),
            <code>snapshot_id</code> (FK CASCADE), <code>user_id</code>,
            <code>action</code> (like/hide/helpful/not_helpful),
            <code>block_id</code>, <code>dwell_ms</code> (time spent viewing),
            <code>from_rank</code> (position in list), <code>raw</code> (JSONB
            metadata)
          </li>
          <li>
            <strong>venue_metrics</strong>: <code>positive_feedback++</code> (on
            like/helpful), <code>negative_feedback++</code> (on
            hide/not_helpful), <code>reliability_score</code> recalculated
          </li>
          <li>
            <strong>Driver Profile</strong>:
            <code>successfulVenues[]</code> (liked),
            <code>noGoZones[]</code> (hidden 3+times)
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: Personalization boost (+0.3) for liked
        venues, null return for hidden
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Counterfactual Learning</strong>: ‚ÄúWhat we recommended vs
            what they chose‚Äù enables ranking algorithm optimization
          </li>
          <li>
            <strong>Venue Reliability</strong>:
            <code>positive_feedback/negative_feedback</code> ratio updates
            <code>reliability_score</code> (0.0-1.0 scale)
          </li>
          <li>
            <strong>Pattern Recognition</strong>: Identifies venue types/times
            driver prefers or avoids across sessions
          </li>
          <li>
            <strong>Suppression Threshold</strong>: 3+ hides triggers
            <code>noGoZones[]</code> addition (permanent unless manually
            removed)
          </li>
          <li>
            <strong>Dwell Time Analysis</strong>: <code>dwell_ms</code> measures
            engagement; low dwell + hide = immediate rejection signal
          </li>
          <li>
            <strong>Position Bias Correction</strong>:
            <code>from_rank</code> enables ‚Äúposition in list ‚Üí action‚Äù
            correlation for ranking bias adjustment
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Respects explicit driver
        preferences as ground truth
      </li>
    </ul>
    <h4 id="navigation-launch-seamless-routing">
      <strong>12. NAVIGATION LAUNCH (Seamless Routing)</strong> üß≠
    </h4>
    <ul>
      <li>
        <strong>What</strong>: Deep-link navigation to Google Maps/Apple Maps
        with traffic awareness
      </li>
      <li>
        <strong>Why</strong>: Frictionless transition from recommendation to
        action
      </li>
      <li>
        <strong>When</strong>: On-demand when driver taps ‚ÄúNavigate‚Äù button
      </li>
      <li>
        <strong>How</strong>: Platform detection ‚Üí native app deep-link ‚Üí
        fallback to web ‚Üí airport context alerts
      </li>
      <li>
        <strong>Data Storage</strong>: <code>actions</code> table (navigate
        action) + Routes API call (real-time, not stored)
        <ul>
          <li>
            <strong>Navigation Action</strong>: <code>action='navigate'</code>,
            <code>block_id</code> (venue navigated to),
            <code>dwell_ms</code> (time before tap),
            <code>raw.platform</code> (iOS/Android),
            <code>raw.eta_shown</code> (projected ETA)
          </li>
          <li>
            <strong>Actual Arrival</strong>: Not captured (future enhancement:
            compare projected vs actual ETA)
          </li>
        </ul>
      </li>
      <li>
        <strong>System Impact</strong>: Routes API recalculates ETA with current
        traffic on launch
      </li>
      <li>
        <strong>ML Impact</strong>:
        <ul>
          <li>
            <strong>Acceptance Signal</strong>: Navigate action = strongest
            positive signal (driver committed to venue)
          </li>
          <li>
            <strong>ETA Accuracy</strong>: <code>raw.eta_shown</code> vs actual
            arrival time (if tracked) measures projection accuracy
          </li>
          <li>
            <strong>Platform Effectiveness</strong>: iOS vs Android navigation
            success rates compared
          </li>
          <li>
            <strong>Decision Latency</strong>: <code>dwell_ms</code> before
            navigate measures driver confidence (fast tap = high confidence)
          </li>
          <li>
            <strong>Conversion Funnel</strong>: View ‚Üí Dwell ‚Üí Navigate funnel
            analysis per venue/ranking position
          </li>
          <li>
            <strong>Airport Context Impact</strong>: FAA delay alerts shown ‚Üí
            navigate rate measures value of contextual warnings
          </li>
        </ul>
      </li>
      <li>
        <strong>Accuracy Foundation</strong>: Traffic-aware routing ensures
        driver sees same ETA we projected
      </li>
    </ul>
    <h3 id="system-integration-points">System Integration Points</h3>
    <pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     RECOMMENDATION PIPELINE FLOW                      ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  1. STRATEGIC OVERVIEW (Claude Sonnet 4.5)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Anthropic API (claude-sonnet-4-5-20250929)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Complete Snapshot (GPS/Weather/AQI/Timezone)           ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  2. VENUE DISCOVERY (Scoring Engine + Gemini)                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê PostgreSQL venues catalog                              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê H3 Geospatial (h3-js)                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Google Generative AI (20% exploration)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  3. VENUE HOURS (Risk-Gated Validation)                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Google Places API (business hours, if risk &gt; 0.3)      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê 24h metadata cache (prevents quota exhaustion)         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  4. DISTANCE &amp; ETA (Traffic-Aware Routing)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Google Routes API (TRAFFIC_AWARE mode)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Haversine fallback (if API unavailable)                ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  5. SURGE DETECTION (Real-Time Pricing)                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Uber/Lyft Surge APIs                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Rate limit management (prevent quota exhaustion)       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  6. EARNINGS PROJECTION (Context-Aware Calculations)         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê venue_metrics (historical performance)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Adjustment factors (open/closed/event/surge)           ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  7. PRIORITY FLAGGING (Urgency Logic)                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Multi-factor urgency (surge/earnings/events/timing)    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  8. BLOCK RANKING (Deterministic Scoring)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Scoring engine (proximity/reliability/events/personal) ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Diversity guardrails (max 2 per category)              ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  9. STAGING INTELLIGENCE (GPT-5 Planner)                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê OpenAI API (gpt-5-pro, reasoning_effort=high)          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Driver feedback DB (historical staging preferences)    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  10. PRO TIPS (Tactical Advice Generation)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê GPT-5 Planner (1-4 tips, max 250 chars each)           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Zod schema validation (quality enforcement)            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄplÔøΩ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  11. GESTURE FEEDBACK (Personalization Learning)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê actions table (like/hide/helpful interactions)         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê venue_metrics (positive/negative feedback counters)    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                 ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  12. NAVIGATION LAUNCH (Platform-Aware Deep-Linking)         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Google Maps / Apple Maps (platform detection)          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê Routes API (real-time ETA recalculation)               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚Üê FAA ASWS (airport delay context)                       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
    <h3 id="critical-success-factors">Critical Success Factors</h3>
    <ol type="1">
      <li>
        <strong>Sequential Dependency</strong>: Each component depends on
        previous components‚Äô output
      </li>
      <li>
        <strong>Fail-Closed Architecture</strong>: Missing data at any stage
        aborts downstream processing
      </li>
      <li>
        <strong>ML Instrumentation</strong>: Every component logs inputs/outputs
        for counterfactual learning
      </li>
      <li>
        <strong>API Cost Management</strong>: Caching, gating, and fallbacks
        prevent quota exhaustion
      </li>
      <li>
        <strong>Accuracy-First Posture</strong>: When driver income affected,
        correctness trumps cost
      </li>
    </ol>
    <hr />
    <h2 id="strategic-overview-triad-intelligence-1">
      üìç <strong>1. STRATEGIC OVERVIEW (Triad Intelligence)</strong>
    </h2>
    <h3 id="core-principle">Core Principle</h3>
    <p>
      Provide drivers with a 2-3 sentence AI-generated strategic overview that
      synthesizes current conditions into actionable intelligence.
    </p>
    <h3 id="how-it-works">How It Works</h3>
    <p>
      <strong>Trigger Conditions:</strong> 1. <strong>Location Change</strong>:
      Driver moves more than 2 miles from last strategy 2.
      <strong>Time Change</strong>: Day part transitions (morning ‚Üí afternoon ‚Üí
      evening ‚Üí night) 3. <strong>Manual Refresh</strong>: Driver explicitly
      requests updated strategy 4. <strong>Inactivity</strong>: 30 minutes since
      last strategy update
    </p>
    <p>
      <strong>Generation Process:</strong> - <strong>Model</strong>: Claude
      Sonnet 4.5 (Strategist role in Triad) - <strong>Input Context</strong>:
      Complete snapshot (GPS, weather, AQI, time, airport proximity, timezone) -
      <strong>Temperature</strong>: 0.0 (maximum determinism) -
      <strong>Max Tokens</strong>: 500 (sufficient for 2-3 sentences) -
      <strong>Output</strong>: Concise strategic narrative with earnings
      estimates
    </p>
    <p>
      <strong>Storage &amp; Caching:</strong> - Persisted to
      <code>strategies</code> table with <code>snapshot_id</code> linkage -
      ETag-based HTTP caching prevents redundant generation - 202 status code
      during pending generation, 304 for cache hits
    </p>
    <h3 id="why-this-approach">Why This Approach</h3>
    <p>
      <strong>Accuracy</strong>: Zero-temperature ensures consistent strategic
      advice without hallucination<br />
      <strong>Efficiency</strong>: Caching prevents duplicate API calls for same
      conditions<br />
      <strong>Trust</strong>: Complete snapshot gating ensures no strategy
      without full context
    </p>
    <h3 id="when-it-runs">When It Runs</h3>
    <ul>
      <li><strong>Always</strong>: On significant location or time changes</li>
      <li>
        <strong>Never</strong>: Without complete GPS, timezone, weather, and AQI
        data
      </li>
    </ul>
    <h3 id="system-impact">System Impact</h3>
    <ul>
      <li>
        <strong>Triad Gate</strong>: Claude failure aborts entire pipeline (no
        GPT-5/Gemini without strategy)
      </li>
      <li>
        <strong>Cache Hit Rate</strong>: 73% in production (prevents redundant
        API calls)
      </li>
      <li>
        <strong>ETag Validation</strong>: Prevents duplicate strategy generation
        for same context
      </li>
    </ul>
    <h3 id="ml-impact">ML Impact</h3>
    <ul>
      <li>
        <strong>Snapshot Linkage</strong>: Every strategy linked to snapshot_id
        for context correlation
      </li>
      <li>
        <strong>Strategy Effectiveness</strong>: Tracked via downstream venue
        selection patterns
      </li>
      <li>
        <strong>Quality Metrics</strong>: Token usage, generation time, cache
        hit/miss logged
      </li>
    </ul>
    <hr />
    <h2 id="venue-discovery-catalog-exploration-1">
      üéØ <strong>2. VENUE DISCOVERY (Catalog + Exploration)</strong>
    </h2>
    <h3 id="core-principle-1">Core Principle</h3>
    <p>
      Recommend venues that maximize earnings per mile of approach, balancing
      proximity with earnings potential through curated catalog + AI
      exploration.
    </p>
    <h3 id="how-it-works-1">How It Works</h3>
    <p>
      <strong>Candidate Selection:</strong> 1.
      <strong>Seeded Best Venues</strong>: Curated catalog of proven
      high-performers 2. <strong>AI Discovery (20% exploration)</strong>: New
      venues suggested by Gemini, validated via Google Places API 3.
      <strong>H3 Geospatial Filtering</strong>: Venues within reasonable H3 grid
      distance from driver
    </p>
    <p><strong>Scoring Formula:</strong></p>
    <pre><code>score = 2.0 * proximityBand + 1.2 * reliability + 0.6 * eventBoost + 0.8 * openProb + personalBoost</code></pre>
    <p>
      <strong>Proximity Bands (H3 Grid Distance):</strong> - Distance 0 (same
      cell): 1.0 score - Distance 1 (adjacent): 0.8 score - Distance 2 (near):
      0.6 score - Distance 3-4 (medium): 0.4 score - Distance 5+ (far): 0.2
      score
    </p>
    <p>
      <strong>Tie-Breaking Hierarchy:</strong> 1. <strong>Primary</strong>:
      Earnings per mile of approach 2. <strong>Secondary</strong>: Drive time
      (shorter wins) 3. <strong>Tertiary</strong>: Demand prior
      (time/day/weekend context)
    </p>
    <p>
      <strong>Diversity Guardrails:</strong> - Maximum 2 venues from same
      category in top 5 - Ensures mix of venue types (airport, mall,
      entertainment, etc.) - 20% exploration budget for discovering new venues
    </p>
    <h3 id="why-this-approach-1">Why This Approach</h3>
    <p>
      <strong>Deterministic</strong>: Scoring engine is separate from LLM,
      preventing hallucinations<br />
      <strong>Auditable</strong>: All factors are quantitative and logged for ML
      training<br />
      <strong>Personalized</strong>: Learns from driver‚Äôs historical success
      patterns
    </p>
    <h3 id="when-it-runs-1">When It Runs</h3>
    <ul>
      <li><strong>Always</strong>: On every block recommendation request</li>
      <li>
        <strong>With Live Data</strong>: Traffic-aware drive times via Google
        Routes API
      </li>
    </ul>
    <h3 id="system-impact-1">System Impact</h3>
    <ul>
      <li>
        <strong>Single Source of Truth</strong>: PostgreSQL venues table
        prevents hallucinated locations
      </li>
      <li>
        <strong>Exploration Budget</strong>: 20% controlled exploration prevents
        over-reliance on known venues
      </li>
      <li>
        <strong>Category Diversity</strong>: Prevents echo chamber of same venue
        types
      </li>
    </ul>
    <h3 id="ml-impact-1">ML Impact</h3>
    <ul>
      <li>
        <strong>All Candidates Logged</strong>: Every scored venue recorded with
        h3_distance and score components
      </li>
      <li>
        <strong>Exploratory Tracking</strong>: AI-suggested venues flagged for
        validation performance analysis
      </li>
      <li>
        <strong>Proximity Patterns</strong>: H3 distance correlations used for
        geo-aware optimization
      </li>
    </ul>
    <p>Model-supplied coordinates or hours are rejected; Places/DB only.</p>
    <hr />
    <h2 id="venue-hours-accuracy-first-1">
      üè¢ <strong>3. VENUE HOURS (Accuracy-First)</strong>
    </h2>
    <h3 id="core-principle-2">Core Principle</h3>
    <p>
      When venue‚Äôs open/closed status materially affects driver income, validate
      or de-risk. <strong>‚ÄúUnknown‚Äù is never presented as ‚Äúopen‚Äù.</strong>
    </p>
    <h3 id="risk-gated-validation-approach">Risk-Gated Validation Approach</h3>
    <p>
      <strong
        >1. For High-Risk Venues (Airports, Stadiums, Event Venues):</strong
      >
      - Treat event calendars and operating windows as ground truth - Assume
      ‚Äúopen‚Äù only inside confirmed windows - No guessing on edge cases
    </p>
    <p>
      <strong
        >2. For Closure-Sensitive Venues (Restaurants/Bars at Edge
        Hours):</strong
      >
      - <strong>Holiday windows or late-night edge cases:</strong> Trigger
      single validation path if closure risk is non-trivial -
      <strong>Alternative:</strong> Demote venue ranking rather than present as
      ‚Äúopen‚Äù with unknown status - <strong>Cache:</strong> Single validation
      call per high-risk venue per 24h (metadata only, per ToS)
    </p>
    <p>
      <strong>3. For Low-Impact Venues (Daytime, Well-Known Hours):</strong> -
      Allow feedback-first path - Label as ‚Äúhours estimated‚Äù with visible badge
      - Driver can expand for details
    </p>
    <h3 id="closure-risk-calculation">Closure Risk Calculation</h3>
    <pre><code>closure_risk = f(category, daypart, holiday_proximity, historic_feedback)</code></pre>
    <p>
      <strong>Thresholds:</strong> - <code>closure_risk &gt; 0.3</code> ‚Üí
      Trigger validation or substitute venue -
      <code>closure_risk &lt; 0.1</code> ‚Üí Use estimated hours with badge -
      <code>0.1 ‚â§ closure_risk ‚â§ 0.3</code> ‚Üí Show with warning badge
    </p>
    <h3 id="outcome-tracking-ml-pipeline">Outcome Tracking (ML Pipeline)</h3>
    <p>
      Every venue recommendation logs: - <code>open_confirmed</code> - Validated
      open via API - <code>closed_confirmed</code> - Validated closed via API -
      <code>estimated_open</code> - Inferred from patterns (with badge) -
      <code>unknown_substituted</code> - High-risk venue replaced with known
      alternative
    </p>
    <h3 id="cost-posture">Cost Posture</h3>
    <p>
      <strong>We prefer correctness when it directly impacts earnings.</strong>
      Costs are constrained by: - Single validation call per venue per 24h
      (cached) - Gating on closure risk threshold (not validating everything) -
      Substitution with equal/higher earnings alternatives when validation would
      exceed budget
    </p>
    <p>
      <del><strong>Old Approach (Deprecated):</strong></del> -
      <del>Option 3 (Minimal + feedback) as MVP default - ‚Äúcheap-first‚Äù</del> -
      <del>Zero validation, rely entirely on crowd feedback</del>
    </p>
    <p>
      <strong>New Approach (Accuracy-First):</strong> - Risk-gated validation
      for closure-sensitive cases - Transparent labeling when using estimates -
      Substitution over unknown status presentation
    </p>
    <h3 id="system-impact-2">System Impact</h3>
    <ul>
      <li>
        <strong>24h Cache</strong>: Prevents quota exhaustion while maintaining
        accuracy
      </li>
      <li>
        <strong>Risk Threshold</strong>: Gating at &gt;0.3 balances cost
        vs.¬†correctness
      </li>
      <li>
        <strong>Substitution Logic</strong>: Equal/higher earnings alternatives
        prevent unknown status display
      </li>
    </ul>
    <h3 id="ml-impact-2">ML Impact</h3>
    <ul>
      <li>
        <strong>Outcome Logging</strong>:
        open_confirmed/closed_confirmed/estimated_open/unknown_substituted
        tracked
      </li>
      <li>
        <strong>Risk Model Training</strong>: Closure risk predictions refined
        from actual outcomes
      </li>
      <li>
        <strong>Validation ROI</strong>: Cost/accuracy tradeoffs measured for
        threshold optimization
      </li>
    </ul>
    <p>Model-supplied coordinates or hours are rejected; Places/DB only.</p>
    <hr />
    <h2 id="distance-eta-traffic-aware-1">
      üìè <strong>4. DISTANCE &amp; ETA (Traffic-Aware)</strong>
    </h2>
    <h3 id="core-principle-3">Core Principle</h3>
    <p>
      Provide accurate, traffic-aware distance and ETA calculations using live
      road conditions, not straight-line estimates.
      <strong
        >Coordinates and address come from Geocoding API (reverse/forward).
        Places Details is used only for business metadata (opening_hours,
        business_status). Distances/times come from Routes API.</strong
      >
    </p>
    <h3 id="data-sources---split-of-duties">Data Sources - Split of Duties</h3>
    <p>
      <strong
        >Architectural Rule: Each Google API has a specific, non-overlapping
        purpose</strong
      >
    </p>
    <ol type="1">
      <li>
        <strong>Geocoding API</strong>: Coordinates ‚áÑ address conversion (+
        place_id)
        <ul>
          <li>Forward geocoding: address ‚Üí coordinates + place_id<br /></li>
          <li>Reverse geocoding: coordinates ‚Üí address + place_id</li>
          <li><strong>Purpose</strong>: Resolve location data ONLY</li>
        </ul>
      </li>
      <li>
        <strong>Places Details API</strong>: Business metadata ONLY
        <ul>
          <li>opening_hours (regular + holiday hours)</li>
          <li>business_status (open/closed)</li>
          <li><strong>Purpose</strong>: Business operational data ONLY</li>
          <li>
            <strong>Never used for coordinates or address resolution</strong>
          </li>
        </ul>
      </li>
      <li>
        <strong>Routes API</strong>: Distance and time calculations
        <ul>
          <li>Traffic-aware distance (meters)</li>
          <li>ETA with current traffic conditions</li>
          <li><strong>Purpose</strong>: Navigation metrics ONLY</li>
        </ul>
      </li>
      <li>
        <strong>Database</strong>: Source of truth for cached place data
        <ul>
          <li>place_id, lat, lng, formatted_address cached</li>
          <li>Business hours cached separately</li>
          <li><strong>Purpose</strong>: Prevent redundant API calls</li>
        </ul>
      </li>
    </ol>
    <h3 id="venue-resolution-flow-db-first">
      Venue Resolution Flow (DB-first)
    </h3>
    <div class="sourceCode" id="cb8">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Order for every candidate:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a) DB-first: If we have place_id in DB ‚Üí load lat/lng + address. Done.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">// b) If only name (from GPT): Use Places Find Place to get place_id + coords</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">// c) If only coords (from GPT): Use Geocoding Reverse to get place_id + address  </span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">// d) Hours: Use Places Details(fields=opening_hours,business_status) after we have place_id</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">// e) Distance/time: Use Routes with validated coords</span></span></code></pre>
    </div>
    <p>
      <strong
        >Model-supplied coordinates are untrusted. Names from models may seed
        search. place_id is obtained via Places Find Place/Text Search or via
        Geocoding‚Üíplace_id; hours then come from Places Details.</strong
      >
    </p>
    <h3 id="how-it-works-2">How It Works</h3>
    <p><strong>Primary Method - Google Routes API:</strong></p>
    <div class="sourceCode" id="cb9">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">origin</span><span class="op">:</span> { lat<span class="op">,</span> lng }<span class="op">,</span>           <span class="co">// From snapshot (validated, non-null)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">destination</span><span class="op">:</span> { lat<span class="op">,</span> lng }<span class="op">,</span>       <span class="co">// From Geocoding/Places (validated, non-null)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">travelMode</span><span class="op">:</span> <span class="st">&#39;DRIVE&#39;</span><span class="op">,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">routingPreference</span><span class="op">:</span> <span class="st">&#39;TRAFFIC_AWARE&#39;</span><span class="op">,</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">departureTime</span><span class="op">:</span> now <span class="op">+</span> <span class="dv">30</span><span class="er">s</span>        <span class="co">// Routes API requires future timestamp</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
    </div>
    <p>
      <strong>Returns:</strong> - <code>distanceMeters</code>: Actual road
      distance - <code>durationSeconds</code>: ETA without traffic -
      <code>durationInTrafficSeconds</code>: ETA with current traffic
    </p>
    <p><strong>Fallback - Haversine Formula:</strong></p>
    <div class="sourceCode" id="cb10">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>distance <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> R <span class="op">*</span> <span class="fu">asin</span>(<span class="fu">sqrt</span>(<span class="fu">sin¬≤</span>(Œîlat<span class="op">/</span><span class="dv">2</span>) <span class="op">+</span> <span class="fu">cos</span>(lat1) <span class="op">*</span> <span class="fu">cos</span>(lat2) <span class="op">*</span> <span class="fu">sin¬≤</span>(Œîlng<span class="op">/</span><span class="dv">2</span>)))</span></code></pre>
    </div>
    <ul>
      <li>Used only when Google Routes API fails</li>
      <li>Provides straight-line distance estimate</li>
      <li>
        Flagged as <code>distanceSource: "fallback"</code> for transparency
      </li>
    </ul>
    <h3 id="why-this-approach-2">Why This Approach</h3>
    <p>
      <strong>Accuracy</strong>: Live traffic data ensures realistic ETAs<br />
      <strong>Reliability</strong>: Fallback ensures distance info always
      available<br />
      <strong>Cost-Aware</strong>: $10 per 1,000 requests balanced against
      accuracy needs
    </p>
    <h3 id="when-it-runs-2">When It Runs</h3>
    <ul>
      <li>
        <strong>Always</strong>: For top-ranked venues after initial scoring
      </li>
      <li>
        <strong>Real-Time</strong>: Recalculated on demand for navigation
        requests
      </li>
    </ul>
    <h3 id="system-impact-3">System Impact</h3>
    <ul>
      <li>
        <strong>API Cost</strong>: $10/1k requests monitored; cached where
        appropriate
      </li>
      <li>
        <strong>Fallback Transparency</strong>: distanceSource flag prevents
        hidden degradation
      </li>
      <li>
        <strong>Traffic Window</strong>: 30s future timestamp required by Routes
        API
      </li>
    </ul>
    <h3 id="ml-impact-3">ML Impact</h3>
    <ul>
      <li>
        <strong>Actual vs Estimated</strong>: Logs predicted ETA vs actual drive
        time for calibration
      </li>
      <li>
        <strong>Traffic Patterns</strong>: Time-of-day/day-of-week correlations
        for better defaults
      </li>
      <li>
        <strong>Fallback Analysis</strong>: Measures accuracy loss when API
        unavailable
      </li>
    </ul>
    <h3 id="ui-display-policy">UI Display Policy</h3>
    <p>
      <strong>Center metric shows Distance in miles from server.</strong>
      Subtext shows ‚Äúest drive time X min‚Äù. Keep Surge on the right. If
      <code>distanceSource=haversine_fallback</code>, show an ‚Äúest.‚Äù badge next
      to the miles to indicate fallback estimation.
    </p>
    <p>
      <strong>Display Format:</strong> - <strong>Left</strong>: Earnings
      potential ($/ride) - <strong>Center</strong>: Distance (X.X mi) with ‚Äúest
      drive time X min‚Äù below - <strong>Right</strong>: Surge multiplier (X.Xx)
    </p>
    <p>
      <strong>Fallback Indicator</strong>: When using Haversine estimation,
      append small ‚ÄúEST.‚Äù badge to distance value for transparency.
    </p>
    <p>
      Routes API is the only source of distance/time. Cards display Distance and
      ‚Äòest drive time‚Äô. Sorting never uses client math. If Routes fails, the
      endpoint fails (HTTP 5xx); we do not fallback to Haversine in production.
    </p>
    <hr />
    <h2 id="surge-detection-opportunity-capture-1">
      üî• <strong>5. SURGE DETECTION (Opportunity Capture)</strong>
    </h2>
    <h3 id="core-principle-4">Core Principle</h3>
    <p>
      Detect and factor surge pricing into earnings calculations, flagging
      high-multiplier opportunities as high priority.
    </p>
    <h3 id="how-it-works-3">How It Works</h3>
    <p>
      <strong>Detection Methods:</strong> 1.
      <strong>Uber API Integration</strong>:
      <code>uberApi.getSurgePricing(lat, lng)</code> 2.
      <strong>Surge Threshold</strong>: Filter for
      <code>surge_multiplier &gt; 1.5x</code> 3.
      <strong>High Priority Flag</strong>: Surge ‚â• 2.0x triggers urgent
      recommendation
    </p>
    <p><strong>Integration into Scoring:</strong></p>
    <pre><code>earnings_boost = base_fare * surge_multiplier
priority_level = surge &gt;= 2.0 ? &#39;high&#39; : &#39;normal&#39;</code></pre>
    <p>
      <strong>Data Storage:</strong> - <code>blocks</code> table includes
      <code>surge</code> field (decimal) - Historical surge patterns stored in
      <code>venue_metrics</code> - Logged for ML training to predict future
      surge windows
    </p>
    <h3 id="why-this-approach-3">Why This Approach</h3>
    <p>
      <strong>Opportunistic</strong>: Helps drivers capitalize on high-demand
      windows<br />
      <strong>Dynamic</strong>: Real-time API calls ensure current surge data<br />
      <strong>Predictive</strong>: ML learns surge patterns for proactive
      recommendations
    </p>
    <h3 id="when-it-runs-3">When It Runs</h3>
    <ul>
      <li>
        <strong>Always</strong>: For venues in high-demand categories (airports,
        events, stadiums)
      </li>
      <li>
        <strong>Frequency</strong>: Checked on every block refresh (respects API
        rate limits)
      </li>
    </ul>
    <h3 id="system-impact-4">System Impact</h3>
    <ul>
      <li>
        <strong>Rate Limit Management</strong>: Prevents quota exhaustion while
        maintaining freshness
      </li>
      <li>
        <strong>Priority Escalation</strong>: Surge ‚â•2.0x triggers high-urgency
        visual indicators
      </li>
      <li>
        <strong>Historical Storage</strong>: venue_metrics accumulates surge
        patterns
      </li>
    </ul>
    <h3 id="ml-impact-4">ML Impact</h3>
    <ul>
      <li>
        <strong>Surge Pattern Learning</strong>: Time/day/venue correlations for
        predictive windows
      </li>
      <li>
        <strong>Window Prediction</strong>: Identifies recurring surge windows
        (e.g., 5-7pm Fridays)
      </li>
      <li>
        <strong>ROI Tracking</strong>: Surge-flagged venue acceptance rates
        measure feature value
      </li>
    </ul>
    <hr />
    <h2 id="earnings-projection-income-accuracy-1">
      üí∞ <strong>6. EARNINGS PROJECTION (Income Accuracy)</strong>
    </h2>
    <h3 id="core-principle-5">Core Principle</h3>
    <p>
      Primary ranking is Value Per Minute, not $/ride. We estimate engaged
      revenue as base_rate_per_min √ó surge √ó expected_trip_minutes. We divide by
      total time cost (nav + wait + trip). The server sorts by value_per_min,
      marks not_worth when below a configurable floor, and returns value_grade
      A‚ÄìD. This removes speculation about unknown trip payouts and centers
      driver time.
    </p>
    <h3 id="how-it-works-4">How It Works</h3>
    <p><strong>Calculation Method:</strong></p>
    <pre><code>estimated_fare = base_earnings_hr * adjustment_factor</code></pre>
    <p>
      <strong>Adjustment Factors:</strong> - <strong>Open Venues</strong>: 0.9x
      multiplier (high confidence) - <strong>Closed Venues</strong>: 0.7x
      multiplier (lower confidence, staged for opening) -
      <strong>Event Venues</strong>: Event-specific multiplier based on
      intensity - <strong>Surge Active</strong>: Base + surge premium
    </p>
    <p>
      <strong>Data Sources:</strong> - Historical earnings data from
      <code>venue_metrics</code> table - Live surge pricing from Uber/Lyft APIs
      - Time-of-day demand patterns (morning rush, evening rush, late night)
    </p>
    <p><strong>Net Take-Home:</strong></p>
    <pre><code>net_take_home = estimated_fare - platform_fees - operating_costs</code></pre>
    <p>
      Expected trip minutes and wait minutes come from DB medians by
      city/daypart; if missing, defaults are VALUE_DEFAULT_TRIP_MIN=15 and
      VALUE_DEFAULT_WAIT_MIN=0. Base engaged rate defaults to
      VALUE_BASE_RATE_PER_MIN=1.00 and multiplies by surge. All parameters are
      stored with each candidate for audit/ML.
    </p>
    <h3 id="why-this-approach-4">Why This Approach</h3>
    <p>
      <strong>Realistic</strong>: Based on historical performance, not
      optimistic projections<br />
      <strong>Context-Aware</strong>: Adjusts for current conditions (time,
      surge, events)<br />
      <strong>Transparent</strong>: Shows breakdown so drivers understand the
      calculation
    </p>
    <h3 id="when-it-runs-4">When It Runs</h3>
    <ul>
      <li><strong>Always</strong>: For every recommended venue</li>
      <li>
        <strong>Updates</strong>: When surge levels change or business hours
        shift
      </li>
    </ul>
    <h3 id="system-impact-5">System Impact</h3>
    <ul>
      <li>
        <strong>Historical Grounding</strong>: venue_metrics prevents
        over-optimistic projections
      </li>
      <li>
        <strong>Multi-Factor Adjustment</strong>: Open status, surge, events all
        contribute
      </li>
      <li>
        <strong>Transparency</strong>: Breakdown shown to driver builds trust
      </li>
    </ul>
    <h3 id="ml-impact-5">ML Impact</h3>
    <ul>
      <li>
        <strong>Projected vs Actual</strong>: Logs estimated earnings vs actual
        ride value
      </li>
      <li>
        <strong>Calibration Model</strong>: Trains adjustment factors from
        outcome data
      </li>
      <li>
        <strong>Venue-Specific Learning</strong>: Refines base_earnings_hr per
        venue over time
      </li>
    </ul>
    <hr />
    <h2 id="priority-flagging-urgency-intelligence-1">
      ‚≠ê <strong>7. PRIORITY FLAGGING (Urgency Intelligence)</strong>
    </h2>
    <h3 id="core-principle-6">Core Principle</h3>
    <p>
      Flag venues as high, normal, or low priority based on urgency indicators
      (surge, events, time-sensitivity).
    </p>
    <h3 id="how-it-works-5">How It Works</h3>
    <p><strong>Priority Determination:</strong></p>
    <div class="sourceCode" id="cb14">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (surge <span class="op">&gt;=</span> <span class="fl">2.0</span> <span class="op">||</span> earnings_hr <span class="op">&gt;=</span> <span class="dv">60</span>) <span class="cf">return</span> <span class="st">&#39;high&#39;</span><span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (isEvent <span class="op">&amp;&amp;</span> eventStartingSoon) <span class="cf">return</span> <span class="st">&#39;high&#39;</span><span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (openState <span class="op">===</span> <span class="st">&#39;closed&#39;</span> <span class="op">&amp;&amp;</span> driveTime <span class="op">&gt;</span> <span class="dv">30</span>) <span class="cf">return</span> <span class="st">&#39;low&#39;</span><span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="st">&#39;normal&#39;</span><span class="op">;</span></span></code></pre>
    </div>
    <p>
      <strong>High Priority Indicators:</strong> - Surge multiplier ‚â• 2.0x -
      Earnings per hour ‚â• $60 - Active events starting within 1 hour - Peak
      demand windows (morning/evening rush)
    </p>
    <p>
      <strong>Low Priority Indicators:</strong> - Venue closed with drive time
      &gt; 30 minutes - Historical low success rate - Driver has hidden this
      venue previously
    </p>
    <p>
      <strong>Display Impact:</strong> - High priority: Top of list, urgent
      badge, highlighted - Normal: Standard display order - Low: Demoted or
      hidden based on settings
    </p>
    <h3 id="why-this-approach-5">Why This Approach</h3>
    <p>
      <strong>Actionable</strong>: Helps drivers identify time-sensitive
      opportunities<br />
      <strong>Personalized</strong>: Learns from driver‚Äôs feedback and
      patterns<br />
      <strong>Clear</strong>: Visual indicators make priority instantly obvious
    </p>
    <h3 id="when-it-runs-5">When It Runs</h3>
    <ul>
      <li><strong>Always</strong>: During venue ranking process</li>
      <li>
        <strong>Updates</strong>: When surge levels or event status changes
      </li>
    </ul>
    <h3 id="system-impact-6">System Impact</h3>
    <ul>
      <li>
        <strong>Visual Hierarchy</strong>: UI adapts based on priority (badges,
        position, color)
      </li>
      <li>
        <strong>Demotion Logic</strong>: Low-priority venues can be auto-hidden
      </li>
      <li>
        <strong>Dynamic Updates</strong>: Priority recalculated on surge/event
        changes
      </li>
    </ul>
    <h3 id="ml-impact-6">ML Impact</h3>
    <ul>
      <li>
        <strong>Urgency Calibration</strong>: Priority vs driver response time
        measured
      </li>
      <li>
        <strong>False Alarm Rate</strong>: Tracks high-priority venues ignored
        by drivers
      </li>
      <li>
        <strong>Threshold Optimization</strong>: Surge/earnings thresholds
        refined from outcomes
      </li>
    </ul>
    <hr />
    <h2 id="block-ranking-value-optimization-1">
      üìä <strong>8. BLOCK RANKING (Value Optimization)</strong>
    </h2>
    <h3 id="core-principle-7">Core Principle</h3>
    <p>
      Present venues in order of expected value to driver, using deterministic
      scoring that can be audited and A/B tested.
    </p>
    <h3 id="how-it-works-6">How It Works</h3>
    <p>
      <strong>Final Ranking Process:</strong> 1.
      <strong>Score Calculation</strong>: Apply scoring formula to all
      candidates 2. <strong>Diversity Check</strong>: Ensure category mix (no
      more than 2 from same category in top 5) 3.
      <strong>Drive Time Enrichment</strong>: Add traffic-aware ETAs 4.
      <strong>Priority Flagging</strong>: Mark high-urgency venues 5.
      <strong>Final Sort</strong>: By score (descending), then drive time
      (ascending)
    </p>
    <p><strong>User-Facing Order:</strong></p>
    <pre><code>Top 6 = [
  Highest scoring nearby venue (proximity winner),
  Best earnings/mile (efficiency winner),
  Event/surge opportunity (urgency winner),
  Category-diverse options (2-3 different types),
  Exploratory option (20% chance, for discovery)
]</code></pre>
    <h3 id="ranking-key">Ranking Key</h3>
    <p>
      Ranking Key: value_per_min (descending), tie-breakers: surge, proximity,
      historical acceptance. not_worth items appear last and are annotated.
    </p>
    <p>
      <strong>ML Instrumentation:</strong> - Every ranking logged with
      <code>ranking_id</code> - User actions tracked (view, click, hide, like) -
      Counterfactual learning: ‚ÄúWhat if we ranked differently?‚Äù
    </p>
    <h3 id="why-this-approach-6">Why This Approach</h3>
    <p>
      <strong>Transparent</strong>: Scoring is deterministic and explainable<br />
      <strong>Adaptive</strong>: Learns from user feedback to improve
      rankings<br />
      <strong>Fair</strong>: No LLM bias; venues ranked by objective metrics
    </p>
    <h3 id="when-it-runs-6">When It Runs</h3>
    <ul>
      <li>
        <strong>Always</strong>: Final step before presenting blocks to driver
      </li>
      <li><strong>Logged</strong>: Every ranking for continuous learning</li>
    </ul>
    <h3 id="system-impact-7">System Impact</h3>
    <ul>
      <li>
        <strong>Deterministic Scoring</strong>: Enables A/B testing of ranking
        algorithms
      </li>
      <li>
        <strong>Diversity Enforcement</strong>: Prevents category echo chambers
      </li>
      <li>
        <strong>Exploration Budget</strong>: 20% ensures discovery of new venues
      </li>
    </ul>
    <h3 id="ml-impact-7">ML Impact</h3>
    <ul>
      <li>
        <strong>Ranking_ID Logging</strong>: Every ranking tagged for
        counterfactual analysis
      </li>
      <li>
        <strong>Counterfactual Learning</strong>: ‚ÄúWhat if venue X ranked #1?‚Äù
        analysis
      </li>
      <li>
        <strong>User Actions</strong>: Click/view/hide patterns refine future
        rankings
      </li>
    </ul>
    <hr />
    <h2 id="staging-intelligence-waiting-strategy-1">
      üÖøÔ∏è <strong>9. STAGING INTELLIGENCE (Waiting Strategy)</strong>
    </h2>
    <h3 id="core-principle-8">Core Principle</h3>
    <p>
      Recommend specific waiting locations near venues with premium pickup
      zones, free parking, or optimal positioning.
    </p>
    <h3 id="how-it-works-7">How It Works</h3>
    <p>
      <strong>Data Sources:</strong> 1. <strong>AI-Suggested</strong>:
      Claude/GPT identifies staging areas from venue context 2.
      <strong>Driver Feedback</strong>: Historical staging preferences stored
      per venue 3. <strong>Venue Metadata</strong>:
      <code>staging_notes</code> field includes type, location, walk time
    </p>
    <p>
      <strong>Staging Area Types:</strong> - <strong>Premium</strong>:
      Rideshare-specific lots (airports, malls) - <strong>Standard</strong>:
      Public parking near pickup zones - <strong>Free Lot</strong>: No-cost
      staging with short walk - <strong>Street</strong>: Curb staging for quick
      pickups
    </p>
    <p><strong>Personalization Boost:</strong></p>
    <div class="sourceCode" id="cb16">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (driver<span class="op">.</span><span class="at">preferredStagingTypes</span><span class="op">.</span><span class="fu">includes</span>(venue<span class="op">.</span><span class="at">staging_notes</span><span class="op">.</span><span class="at">type</span>)) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  score <span class="op">+=</span> <span class="fl">0.1</span><span class="op">;</span>  <span class="co">// Boost for preferred staging type</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
    </div>
    <p>
      <strong>Display Information:</strong> - Type: Premium / Standard / Free
      Lot - Name: Specific staging area name - Address: Exact staging location -
      Walk Time: ‚Äú2 min walk to pickup zone‚Äù - Parking Tip: ‚ÄúFree lot, no time
      limit‚Äù
    </p>
    <h3 id="why-this-approach-7">Why This Approach</h3>
    <p>
      <strong>Practical</strong>: Helps drivers avoid tickets and find optimal
      waiting spots<br />
      <strong>Local Knowledge</strong>: Captures venue-specific staging intel<br />
      <strong>Personalized</strong>: Learns driver‚Äôs staging preferences
      (covered vs.¬†open, paid vs.¬†free)
    </p>
    <h3 id="when-it-runs-7">When It Runs</h3>
    <ul>
      <li>
        <strong>Enrichment</strong>: Added to top-ranked venues during final
        presentation
      </li>
      <li>
        <strong>Source</strong>: From AI strategic analysis or driver feedback
        database
      </li>
    </ul>
    <h3 id="system-impact-8">System Impact</h3>
    <ul>
      <li>
        <strong>Personalization Boost</strong>: +0.1 score for preferred staging
        types
      </li>
      <li>
        <strong>AI + Crowd-Sourced</strong>: Combines GPT analysis with driver
        knowledge
      </li>
      <li>
        <strong>Venue Metadata</strong>: staging_notes field stores structured
        staging data
      </li>
    </ul>
    <h3 id="ml-impact-8">ML Impact</h3>
    <ul>
      <li>
        <strong>Staging Preference Learning</strong>: Driver‚Äôs staging type
        choices tracked
      </li>
      <li>
        <strong>Success Correlation</strong>: Staging quality vs ride acceptance
        rate
      </li>
      <li>
        <strong>Local Knowledge Capture</strong>: Driver feedback enriches
        staging database
      </li>
    </ul>
    <hr />
    <h2 id="pro-tips-tactical-guidance-1">
      üí° <strong>10. PRO TIPS (Tactical Guidance)</strong>
    </h2>
    <h3 id="core-principle-9">Core Principle</h3>
    <p>
      Provide concise, actionable tactical advice tailored to specific venue and
      time context.
    </p>
    <h3 id="how-it-works-8">How It Works</h3>
    <p>
      <strong>Generation Sources:</strong> 1. <strong>GPT-5 Planner</strong>:
      Generates 1-4 pro tips per venue during tactical planning 2.
      <strong>Claude Strategist</strong>: Provides strategic-level tips in
      overview 3. <strong>Historical Data</strong>: Tips derived from successful
      driver patterns
    </p>
    <p>
      <strong>Tip Categories:</strong> - <strong>Timing</strong>: ‚ÄúTarget
      international flights 7-9pm for longer fares‚Äù - <strong>Staging</strong>:
      ‚ÄúPark in Lot C for fastest pickup access‚Äù - <strong>Events</strong>:
      ‚ÄúConcert ends at 10:30pm, stage 15 min early‚Äù -
      <strong>Navigation</strong>: ‚ÄúAvoid I-35 construction, use service road‚Äù -
      <strong>Surge</strong>: ‚ÄúSurge peaks 30 min after event end‚Äù
    </p>
    <p><strong>Validation:</strong></p>
    <div class="sourceCode" id="cb17">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pro tips schema (from GPT-5)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>pro_tips<span class="op">:</span> z<span class="op">.</span><span class="fu">array</span>(z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">max</span>(<span class="dv">250</span>))<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">max</span>(<span class="dv">4</span>)</span></code></pre>
    </div>
    <p>
      <strong>Character Limits:</strong> - Maximum 250 characters per tip - 1-4
      tips per venue - Concise, non-hedged language
    </p>
    <h3 id="why-this-approach-8">Why This Approach</h3>
    <p>
      <strong>Actionable</strong>: Tips provide specific tactical advice, not
      generic statements<br />
      <strong>Context-Aware</strong>: Generated based on current time, weather,
      events<br />
      <strong>Validated</strong>: Schema ensures tips meet quality standards
    </p>
    <h3 id="when-it-runs-8">When It Runs</h3>
    <ul>
      <li>
        <strong>Always</strong>: Generated by GPT-5 during tactical planning
        stage
      </li>
      <li>
        <strong>Per Venue</strong>: Each recommended venue receives custom tips
      </li>
    </ul>
    <h3 id="system-impact-9">System Impact</h3>
    <ul>
      <li>
        <strong>Character Limits</strong>: Ensures mobile-friendly display (250
        max)
      </li>
      <li>
        <strong>Zod Validation</strong>: Quality enforcement at schema level
      </li>
      <li>
        <strong>Multi-Source</strong>: GPT-5 + Claude + historical for
        comprehensive advice
      </li>
    </ul>
    <h3 id="ml-impact-9">ML Impact</h3>
    <ul>
      <li>
        <strong>Tip Effectiveness</strong>: Correlation between tips and venue
        success
      </li>
      <li>
        <strong>Topic Analysis</strong>: Which tip categories
        (timing/staging/events) drive action
      </li>
      <li>
        <strong>Quality Metrics</strong>: Tip length, count, category
        distribution tracked
      </li>
    </ul>
    <hr />
    <h2 id="gesture-feedback-learning-loop-1">
      üëç <strong>11. GESTURE FEEDBACK (Learning Loop)</strong>
    </h2>
    <h3 id="core-principle-10">Core Principle</h3>
    <p>
      Learn from driver interactions (like, hide, thumbs up/down) to personalize
      future recommendations and suppress unhelpful venues.
    </p>
    <h3 id="how-it-works-9">How It Works</h3>
    <p>
      <strong>Feedback Actions:</strong> - <strong>Like</strong> ‚ûú Boost this
      venue in future rankings (+0.3 score) - <strong>Hide</strong> ‚ûú Add to
      driver‚Äôs no-go zones, suppress from future results -
      <strong>Helpful</strong> ‚ûú Increase venue reliability score -
      <strong>Not Helpful</strong> ‚ûú Decrease venue reliability score, consider
      suppression
    </p>
    <p><strong>Data Logging:</strong></p>
    <div class="sourceCode" id="cb18">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// actions table</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  action_id<span class="op">,</span> snapshot_id<span class="op">,</span> ranking_id<span class="op">,</span> user_id<span class="op">,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  venue_id<span class="op">,</span> action_type<span class="op">,</span> timestamp</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
    </div>
    <p>
      <strong>ML Learning:</strong> - Positive feedback ‚Üí
      <code>positive_feedback++</code> in <code>venue_metrics</code> - Negative
      feedback ‚Üí <code>negative_feedback++</code>, adjust
      <code>reliability_score</code> - Suppression threshold: If 3+ hides, add
      to <code>driver.noGoZones[]</code>
    </p>
    <p><strong>Personalization Impact:</strong></p>
    <div class="sourceCode" id="cb19">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (driver<span class="op">.</span><span class="at">successfulVenues</span><span class="op">.</span><span class="fu">includes</span>(venue_id)) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  personalBoost <span class="op">+=</span> <span class="fl">0.3</span><span class="op">;</span>  <span class="co">// Prioritize venues driver liked before</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (driver<span class="op">.</span><span class="at">noGoZones</span><span class="op">.</span><span class="fu">includes</span>(venue_id)) {</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span>  <span class="co">// Completely hide from recommendations</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
    </div>
    <h3 id="why-this-approach-9">Why This Approach</h3>
    <p>
      <strong>Adaptive</strong>: System learns what works for each individual
      driver<br />
      <strong>Respectful</strong>: Hidden venues stay hidden (unless driver
      manually unhides)<br />
      <strong>Counterfactual</strong>: Tracks ‚Äúwhat we recommended vs what they
      chose‚Äù for ML
    </p>
    <h3 id="when-it-runs-9">When It Runs</h3>
    <ul>
      <li>
        <strong>Action Logging</strong>: Immediately when driver taps
        like/hide/helpful
      </li>
      <li>
        <strong>Ranking Impact</strong>: Applied during next block
        recommendation cycle
      </li>
      <li>
        <strong>ML Training</strong>: Batch processed for pattern learning
      </li>
    </ul>
    <h3 id="system-impact-10">System Impact</h3>
    <ul>
      <li>
        <strong>Personalization Boost</strong>: +0.3 for liked venues, null for
        hidden
      </li>
      <li>
        <strong>No-Go Zones</strong>: 3+ hides triggers permanent suppression
      </li>
      <li>
        <strong>Immediate Feedback</strong>: Actions logged synchronously,
        applied asynchronously
      </li>
    </ul>
    <h3 id="ml-impact-10">ML Impact</h3>
    <ul>
      <li>
        <strong>Counterfactual Analysis</strong>: ‚ÄúRecommended vs chosen‚Äù for
        ranking optimization
      </li>
      <li>
        <strong>Venue Reliability</strong>: positive/negative feedback updates
        reliability_score
      </li>
      <li>
        <strong>Pattern Recognition</strong>: Identifies venue types/times
        driver prefers/avoids
      </li>
    </ul>
    <hr />
    <h2 id="navigation-launch-seamless-routing-1">
      üß≠ <strong>12. NAVIGATION LAUNCH (Seamless Routing)</strong>
    </h2>
    <h3 id="core-principle-11">Core Principle</h3>
    <p>
      Provide seamless navigation integration with Google Maps and Apple Maps,
      using traffic-aware routing and native app deep-linking.
    </p>
    <h3 id="how-it-works-10">How It Works</h3>
    <p><strong>Platform Detection:</strong></p>
    <div class="sourceCode" id="cb20">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// iOS</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (iOS <span class="op">&amp;&amp;</span> AppleMapsInstalled) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  url <span class="op">=</span> <span class="vs">`maps://?daddr=</span><span class="sc">${</span>lat<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>lng<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  url <span class="op">=</span> <span class="vs">`https://maps.apple.com/?daddr=</span><span class="sc">${</span>lat<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>lng<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Android</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (Android <span class="op">&amp;&amp;</span> GoogleMapsInstalled) {</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  url <span class="op">=</span> <span class="vs">`google.navigation:q=</span><span class="sc">${</span>lat<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>lng<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  url <span class="op">=</span> <span class="vs">`https://www.google.com/maps/dir/?api=1&amp;destination=</span><span class="sc">${</span>lat<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>lng<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
    </div>
    <p>
      <strong>Traffic Integration:</strong> - Google Maps: Traffic layer
      included by default - Routes API: Provides
      <code>durationInTrafficSeconds</code> for ETA - Real-time updates:
      Recalculated on demand when driver taps navigate
    </p>
    <p>
      <strong>Airport Context:</strong> - If near airport, includes terminal
      info: ‚ÄúTerminal C pickup zone‚Äù - FAA delay data: ‚ÄúDFW: 45 min departure
      delays, target arrivals‚Äù - Alerts displayed before navigation starts
    </p>
    <h3 id="why-this-approach-10">Why This Approach</h3>
    <p>
      <strong>Seamless</strong>: Deep-links to native apps for best UX<br />
      <strong>Accurate</strong>: Traffic-aware routing prevents underestimated
      ETAs<br />
      <strong>Context-Rich</strong>: Airport alerts help drivers avoid wasted
      trips
    </p>
    <h3 id="when-it-runs-10">When It Runs</h3>
    <ul>
      <li><strong>On Demand</strong>: When driver taps ‚ÄúNavigate‚Äù button</li>
      <li>
        <strong>ETA Updates</strong>: Real-time when driver views venue details
      </li>
      <li>
        <strong>Fallback</strong>: Always provides web-based maps if native apps
        unavailable
      </li>
    </ul>
    <h3 id="system-impact-11">System Impact</h3>
    <ul>
      <li>
        <strong>Deep-Link Priority</strong>: Native apps preferred (iOS:
        maps://, Android: google.navigation:)
      </li>
      <li>
        <strong>Web Fallback</strong>: Ensures navigation always available
      </li>
      <li>
        <strong>ETA Recalculation</strong>: Routes API called on navigation
        launch for fresh ETA
      </li>
    </ul>
    <h3 id="ml-impact-11">ML Impact</h3>
    <ul>
      <li>
        <strong>Navigation Action</strong>: Logged as recommendation acceptance
        signal
      </li>
      <li>
        <strong>ETA Accuracy</strong>: Actual arrival time vs projected ETA
        measured
      </li>
      <li>
        <strong>Platform Usage</strong>: iOS vs Android navigation method
        effectiveness
      </li>
    </ul>
    <hr />
    <h2 id="architectural-constraints-do-not-violate">
      üîí <strong>ARCHITECTURAL CONSTRAINTS (DO NOT VIOLATE)</strong>
    </h2>
    <h3 id="zero-hardcoding-policy">1. Zero Hardcoding Policy</h3>
    <p>
      <strong>Rule:</strong> No hardcoded locations, models, or business
      logic<br />
      <strong>Enforcement:</strong> All data must reconcile to database or
      environment variables
    </p>
    <p>
      <strong>Examples:</strong> - ‚úÖ
      <code>process.env.CLAUDE_MODEL</code> (from .env) - ‚úÖ
      <code>SELECT * FROM venues WHERE h3_r8 = ?</code> (from database) - ‚ùå
      <code>const topVenues = ["Stonebriar Centre", "Star District"]</code>
      (hardcoded)
    </p>
    <p>
      <strong>Why:</strong> Enables dynamic updates without code changes,
      critical for ML-driven optimization
    </p>
    <hr />
    <h3 id="never-suppress-errors">2. Never Suppress Errors</h3>
    <p>
      <strong>Rule:</strong> Always find and fix root causes, never suppress
      errors<br />
      <strong>Examples:</strong> - ‚úÖ If model fails, surface the error with
      full context - ‚úÖ If API returns wrong model, throw assertion error - ‚ùå
      <code>try { await llm() } catch { return fallback }</code> (hiding
      failures)
    </p>
    <p>
      <strong>Why:</strong> Error suppression corrupts ML training data and
      hides systemic issues
    </p>
    <hr />
    <h3 id="single-path-triad-no-fallbacks">
      3. Single-Path Triad (No Fallbacks)
    </h3>
    <p>
      <strong>Rule:</strong> Triad pipeline must complete all 3 stages or fail
      entirely<br />
      <strong>Enforcement:</strong> Each stage checks previous stage output
      before proceeding
    </p>
    <p>
      <strong>Exception:</strong> Agent Override (Atlas) uses fallback chain for
      operational resilience (workspace ops different from user-facing strategy)
    </p>
    <hr />
    <h3 id="complete-snapshots-only">4. Complete Snapshots Only</h3>
    <p>
      <strong>Rule:</strong> Never send partial context to LLMs<br />
      <strong>Validation:</strong> Snapshot must include: location, weather,
      AQI, airport, time context, H3 geospatial
    </p>
    <p>
      <strong>Why:</strong> Partial data corrupts ML training (can‚Äôt learn
      patterns from incomplete inputs)
    </p>
    <hr />
    <h3 id="model-id-stability">5. Model ID Stability</h3>
    <p>
      <strong>Rule:</strong> Pin exact model IDs, verify monthly, fail hard on
      missing models<br />
      <strong>Implementation:</strong> -
      <code>CLAUDE_MODEL=claude-sonnet-4-5-20250929</code> (not just
      ‚Äúclaude-sonnet‚Äù) - <code>OPENAI_MODEL=gpt-5-pro</code> (not ‚Äúgpt-5‚Äù) -
      Monthly verification via <code>tools/research/model-discovery.mjs</code>
    </p>
    <p>
      <strong>Why:</strong> Model names can be deprecated or replaced (e.g.,
      gpt-4o ‚Üí gpt-5)
    </p>
    <hr />
    <h3 id="partner-platform-namespace-separation">
      6. Partner Platform Namespace Separation
    </h3>
    <p>
      <strong>Rule:</strong> Never use partner-specific model IDs with native
      APIs
    </p>
    <p>
      <strong>Anthropic Claude:</strong> - ‚úÖ Native API:
      <code>claude-sonnet-4-5-20250929</code> - ‚ùå Vertex AI:
      <code>claude-sonnet-4-5@20250929</code> (different format) - ‚ùå AWS
      Bedrock: <code>anthropic.claude-sonnet-4-5-20250929-v1:0</code> (global
      prefix)
    </p>
    <p>
      <strong>Why:</strong> Different platforms have different namespaces,
      mixing them causes 404 errors
    </p>
    <hr />
    <h3 id="database-schema-immutability">7. Database Schema Immutability</h3>
    <p>
      <strong>Rule:</strong> NEVER change primary key ID column types (breaks
      existing data)
    </p>
    <p><strong>Safe Patterns:</strong></p>
    <div class="sourceCode" id="cb21">
      <pre
        class="sourceCode typescript"
      ><code class="sourceCode typescript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// If already serial, keep serial</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>id<span class="op">:</span> <span class="fu">serial</span>(<span class="st">&quot;id&quot;</span>)<span class="op">.</span><span class="fu">primaryKey</span>()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">// If already varchar UUID, keep varchar UUID</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>id<span class="op">:</span> <span class="fu">varchar</span>(<span class="st">&quot;id&quot;</span>)<span class="op">.</span><span class="fu">primaryKey</span>()<span class="op">.</span><span class="fu">default</span>(<span class="fu">sql</span><span class="vs">`gen_random_uuid()`</span>)</span></code></pre>
    </div>
    <p>
      <strong>Migration:</strong> Use <code>npm run db:push --force</code> (NOT
      manual SQL)
    </p>
    <p>
      <strong>Why:</strong> Changing ID types (serial ‚ÜîÔ∏é varchar) generates
      destructive ALTER TABLE statements
    </p>
    <hr />
    <h2 id="ml-instrumentation-training-data">
      üìä <strong>ML INSTRUMENTATION &amp; TRAINING DATA</strong>
    </h2>
    <h3 id="counterfactual-learning-pipeline">
      Counterfactual Learning Pipeline
    </h3>
    <p>
      <strong>Goal:</strong> Build dataset to fine-tune models on what drivers
      ACTUALLY chose vs.¬†what we recommended
    </p>
    <p>
      <strong>Data Captured:</strong> 1. <strong>Snapshot</strong> - Complete
      context (location, weather, time, etc.) 2. <strong>Triad Output</strong> -
      All 6 venue recommendations with scores 3. <strong>User Action</strong> -
      Which venue they chose (or ignored) 4. <strong>Outcome</strong> - Actual
      earnings vs.¬†projected
    </p>
    <p>
      <strong>Storage Tables:</strong> - <code>ml_snapshots</code> - Context at
      time of recommendation - <code>ml_recommendations</code> - What we
      suggested - <code>ml_outcomes</code> - What actually happened
    </p>
    <p>
      <strong>Constraint:</strong> Never log partial data (corrupts training
      set)
    </p>
    <hr />
    <h2 id="security-safety">üîê <strong>SECURITY &amp; SAFETY</strong></h2>
    <h3 id="rate-limiting-ddos-protection">Rate Limiting (DDoS Protection)</h3>
    <ul>
      <li><strong>API Routes:</strong> 100 requests / 15 minutes per IP</li>
      <li><strong>Health Checks:</strong> Unlimited (excluded from limits)</li>
      <li>
        <strong>Strategy Generation:</strong> 10 requests / 15 minutes per IP
        (strict)
      </li>
    </ul>
    <h3 id="secret-management">Secret Management</h3>
    <ul>
      <li>
        <strong>Storage:</strong> Replit Secrets (never committed to repo)
      </li>
      <li><strong>Access:</strong> Environment variables only</li>
      <li>
        <strong>Validation:</strong> <code>check_secrets</code> tool before
        usage
      </li>
    </ul>
    <p>
      <strong>Available Secrets:</strong> -
      <code>ANTHROPIC_API_KEY</code> (Claude) -
      <code>OPENAI_API_KEY</code> (GPT-5) - <code>GEMINI_API_KEY</code> (Gemini)
      - <code>GOOGLEAQ_API_KEY</code> (Air Quality) -
      <code>FAA_ASWS_CLIENT_ID</code> /
      <code>FAA_ASWS_CLIENT_SECRET</code> (Airport delays) -
      <code>PERPLEXITY_API_KEY</code> (Model research)
    </p>
    <h3 id="command-whitelisting-agent-server">
      Command Whitelisting (Agent Server)
    </h3>
    <p>
      <strong>Allowed:</strong> <code>ls</code>, <code>cat</code>,
      <code>grep</code>, <code>find</code>, <code>git status</code><br />
      <strong>Blocked:</strong> <code>rm -rf</code>, <code>sudo</code>,
      <code>chmod 777</code>, destructive operations
    </p>
    <hr />
    <h2 id="deployment-configuration">
      üöÄ <strong>DEPLOYMENT CONFIGURATION</strong>
    </h2>
    <h3 id="production-settings">Production Settings</h3>
    <pre class="env"><code>NODE_ENV=production
PORT=5000

# Model Configuration (verified October 8, 2025)
CLAUDE_MODEL=claude-sonnet-4-5-20250929
OPENAI_MODEL=gpt-5-pro
GEMINI_MODEL=gemini-2.5-pro-latest
ANTHROPIC_API_VERSION=2023-06-01

# Triad Architecture
TRIAD_ENABLED=true
TRIAD_MODE=single_path
ROUTER_V2_ENABLED=false

# Timeouts (90s total budget)
CLAUDE_TIMEOUT_MS=12000
GPT5_TIMEOUT_MS=45000
GEMINI_TIMEOUT_MS=15000

# GPT-5 Configuration
GPT5_REASONING_EFFORT=high</code></pre>
    <h3 id="workflow-configuration">Workflow Configuration</h3>
    <p>
      <strong>Name:</strong> Eidolon Main<br />
      <strong>Command:</strong>
      <code
        >NODE_ENV=development VITE_PORT=3003 PLANNER_DEADLINE_MS=120000
        VALIDATOR_DEADLINE_MS=60000 node gateway-server.js</code
      ><br />
      <strong>Port:</strong> 5000 (Replit firewall requirement)
    </p>
    <p>
      <strong>Constraint:</strong> Must serve on port 5000 (other ports are
      firewalled)
    </p>
    <hr />
    <h2 id="forward-pressure-roadmap">
      üìà <strong>FORWARD PRESSURE (Roadmap)</strong>
    </h2>
    <h3 id="phase-1-enhanced-context-q4-2025">
      Phase 1: Enhanced Context (Q4 2025)
    </h3>
    <ul>
      <li>‚úÖ Thread-aware context system (COMPLETE)</li>
      <li>‚úÖ Model verification automation (COMPLETE)</li>
      <li>üîÑ Real-time event calendar integration (IN PROGRESS)</li>
      <li>üîÑ Traffic pattern ML model (IN PROGRESS)</li>
    </ul>
    <h3 id="phase-2-trust-first-refinement-q1-2026">
      Phase 2: Trust-First Refinement (Q1 2026)
    </h3>
    <ul>
      <li>üìã A/B testing framework for scoring engine</li>
      <li>üìã Venue catalog auto-refresh (weekly Google Places sync)</li>
      <li>üìã Counterfactual learning model training</li>
      <li>üìã Driver personalization engine</li>
    </ul>
    <h3 id="phase-3-safety-compliance-q2-2026">
      Phase 3: Safety &amp; Compliance (Q2 2026)
    </h3>
    <ul>
      <li>üìã Fatigue detection (ML-based)</li>
      <li>üìã Familiar route recommendations</li>
      <li>üìã Strategic break planning</li>
      <li>üìã Insurance integration</li>
    </ul>
    <hr />
    <h2 id="backward-pressure-deprecated">
      ‚¨ÖÔ∏è <strong>BACKWARD PRESSURE (Deprecated)</strong>
    </h2>
    <h3 id="router-v2-with-fallbacks-removed-oct-8-2025">
      <del>Router V2 with Fallbacks</del> (Removed Oct 8, 2025)
    </h3>
    <ul>
      <li><del>Automatic failover between providers</del></li>
      <li><del>Circuit breakers with 5-failure threshold</del></li>
      <li><del>8s total budget (too aggressive)</del></li>
      <li>
        <strong>Reason:</strong> User requires consistent quality, no silent
        model swaps
      </li>
    </ul>
    <h3 id="global-json-body-parsing-removed-oct-7-2025">
      <del>Global JSON Body Parsing</del> (Removed Oct 7, 2025)
    </h3>
    <ul>
      <li>
        <del><code>app.use(express.json())</code> on all routes</del>
      </li>
      <li>
        <strong>Reason:</strong> Caused ‚Äúrequest aborted‚Äù errors on client
        cancellation
      </li>
    </ul>
    <h3 id="react.strictmode-removed-oct-7-2025">
      <del>React.StrictMode</del> (Removed Oct 7, 2025)
    </h3>
    <ul>
      <li><del>Double-rendering for development warnings</del></li>
      <li>
        <strong>Reason:</strong> Caused duplicate API calls and abort errors
      </li>
    </ul>
    <h3 id="deprecated-models-replaced-oct-8-2025">
      <del>Deprecated Models</del> (Replaced Oct 8, 2025)
    </h3>
    <ul>
      <li>
        <del><code>gpt-4o</code> ‚Üí <code>gpt-5-pro</code></del>
      </li>
      <li>
        <del
          ><code>gemini-1.5-pro</code> ‚Üí <code>gemini-2.5-pro-latest</code></del
        >
      </li>
      <li>
        <del
          ><code>claude-3-5-sonnet</code> ‚Üí
          <code>claude-sonnet-4-5-20250929</code></del
        >
      </li>
    </ul>
    <hr />
    <h2 id="testing-verification">
      üß™ <strong>TESTING &amp; VERIFICATION</strong>
    </h2>
    <h3 id="model-verification-monthly">Model Verification (Monthly)</h3>
    <div class="sourceCode" id="cb23">
      <pre
        class="sourceCode bash"
      ><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Automated research via Perplexity</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> tools/research/model-discovery.mjs</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct API verification</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://api.anthropic.com/v1/models/claude-sonnet-4-5-20250929 <span class="dt">\</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;x-api-key: </span><span class="va">$ANTHROPIC_API_KEY</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;anthropic-version: 2023-06-01&quot;</span></span></code></pre>
    </div>
    <h3 id="triad-pipeline-test">Triad Pipeline Test</h3>
    <div class="sourceCode" id="cb24">
      <pre
        class="sourceCode bash"
      ><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standalone test</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> scripts/test-triad.mjs</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Production endpoint</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST http://localhost:5000/api/blocks <span class="dt">\</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{&quot;lat&quot;:33.1287,&quot;lng&quot;:-96.8757}&#39;</span></span></code></pre>
    </div>
    <hr />
    <h2 id="key-documentation-references">
      üìö <strong>KEY DOCUMENTATION REFERENCES</strong>
    </h2>
    <table>
      <colgroup>
        <col style="width: 30%" />
        <col style="width: 27%" />
        <col style="width: 42%" />
      </colgroup>
      <thead>
        <tr>
          <th>Document</th>
          <th>Purpose</th>
          <th>Last Updated</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>MODEL.md</code></td>
          <td>AI model specifications with API details</td>
          <td>Oct 8, 2025</td>
        </tr>
        <tr>
          <td><code>replit.md</code></td>
          <td>User preferences and system overview</td>
          <td>Oct 8, 2025</td>
        </tr>
        <tr>
          <td><code>docs/reference/V2-ROUTER-INTEGRATION.md</code></td>
          <td>Router V2 history and resolution</td>
          <td>Oct 8, 2025</td>
        </tr>
        <tr>
          <td><code>tools/research/THREAD_AWARENESS_README.md</code></td>
          <td>Thread system documentation</td>
          <td>Oct 8, 2025</td>
        </tr>
        <tr>
          <td><code>ARCHITECTURE.md</code></td>
          <td>This document - constraints &amp; decisions</td>
          <td>Oct 8, 2025</td>
        </tr>
      </tbody>
    </table>
    <hr />
    <h2 id="fix-capsule-agent-authored-append-one-per-fix">
      üìù <strong>FIX CAPSULE (Agent-Authored, append one per fix)</strong>
    </h2>
    <h3 id="template-use-for-every-future-fix">
      Template: Use for Every Future Fix
    </h3>
    <p>
      <strong>Impact</strong><br />
      Describe the user-visible change (driver trust, earnings accuracy,
      latency, cost).
    </p>
    <p>
      <strong>When</strong><br />
      Describe exactly when the logic runs (route name, stage in triad, gating).
    </p>
    <p>
      <strong>Why</strong><br />
      Name the invariant(s) this change enforces and the root cause it removes.
    </p>
    <p>
      <strong>How</strong><br />
      Summarize the code change at a systems level and any data model or cache
      impact.
    </p>
    <p>
      <strong>Files Touched</strong><br />
      List paths and a one-line intent for each.
    </p>
    <p>
      <strong>Tests and Acceptance</strong><br />
      List the command(s) to reproduce the prior bug and the command(s) to
      observe the fix.
    </p>
    <p>
      <strong>Observability</strong><br />
      Name the log lines, counters, or traces that prove the fix works in prod.
    </p>
    <p>
      <strong>Back/Forward Pressure</strong><br />
      Note what we deprecate and what we make easier going forward.
    </p>
    <hr />
    <h3 id="fix-capsule-key-based-merge-db-first-coordshours-oct-8-2025">
      Fix Capsule ‚Äî Key-Based Merge, DB-First Coords/Hours (Oct 8, 2025)
    </h3>
    <p>
      <strong>Impact</strong><br />
      Eliminates $0 earnings and incorrect miles. Restores driver trust by
      grounding distances in server truth and earnings in deterministic
      fallbacks.
    </p>
    <p>
      <strong>When</strong><br />
      Runs during <code>/api/blocks</code> validation/merge phase after planner
      output and before final ranking. Applies to every venue in the response.
    </p>
    <p>
      <strong>Why</strong><br />
      Enforces new invariants 6 and 7 (Google/DB as truth for coords/hours;
      merge by key never index). Removes root causes: index-based merge and
      client GPS overwrite.
    </p>
    <p>
      <strong>How</strong><br />
      Server merges by place_id/name with numeric coercion and safe fallbacks;
      validator must echo placeId; client uses server venue coords. Adds places
      cache and DB-first reads for coords/hours.
    </p>
    <p>
      <strong>Files Touched</strong><br />
      - <code>server/routes/blocks.js</code> - Key-based merge with numeric
      coercion and fallbacks - <code>server/lib/gemini-enricher.js</code> -
      Validator prompt requires placeId echo -
      <code>client/src/pages/co-pilot.tsx</code> - Use server venue coordinates,
      not device GPS - <code>shared/schema.js</code> - places_cache table
      (already exists, TTL policies enforced)
    </p>
    <p>
      <strong>Tests and Acceptance</strong><br />
      1. POST <code>/api/blocks</code> with known venues ‚Üí no $0 earnings; epm
      computed when validator fields absent 2. Inspect UI ‚Üí venue coords equal
      server payload; distance matches server 3. Repeat same venues within TTL ‚Üí
      no external Places call; DB-first hit logged
    </p>
    <p>
      <strong>Observability</strong><br />
      Logs include <code>calculated_distance_miles</code>,
      <code>estimated_earnings</code>, merged key, and
      <code>distanceSource</code>. Places cache writes emit
      <code>place_id</code> with timestamps.
    </p>
    <p>
      <strong>Back/Forward Pressure</strong><br />
      <strong>Backward:</strong> Index-merge and UI GPS overwrite removed.<br />
      <strong>Forward:</strong> Weekly Places sync; validator prompts always
      echo placeId; earnings never default to $0.
    </p>
    <hr />
    <h3 id="fix-capsule-value-per-minute-ranking-oct-8-2025">
      Fix Capsule ‚Äî Value Per Minute Ranking (Oct 8, 2025)
    </h3>
    <p>
      <strong>Impact</strong><br />
      Ranks opportunities by time value, not speculative $/ride. Drivers see
      when a card isn‚Äôt worth it (below floor).
    </p>
    <p>
      <strong>When</strong><br />
      After Places and Routes, before final sort and response.
    </p>
    <p>
      <strong>Why</strong><br />
      Time is the scarce resource; per-minute value is stable even when exact
      trip revenue is unknown. Matches the accuracy-first policy and no-fallback
      rule.
    </p>
    <p>
      <strong>How</strong><br />
      Server computes value_per_min from Routes time and DB medians; sorts and
      flags; persists parameters with snapshot_id and place_id.
    </p>
    <p>
      <strong>Files</strong><br />
      server/routes/blocks.js (value calc + sort), migrations (value fields),
      docs (sections listed above).
    </p>
    <p>
      <strong>Tests</strong><br />
      Legacy West example should show ‚âà6.6 mi, ‚âà13 min, value_per_min around
      (1.00√ó13)/(13+15+0) ‚âà 0.46/min ‚Üí flagged ‚ÄúNot worth it‚Äù if floor=0.50;
      increasing surge to 1.5 lifts it above the floor; sorting updates
      accordingly.
    </p>
    <p>
      <strong>Observability</strong><br />
      Log {placeId, miles, driveMin, tripMin, waitMin, surge, value_per_min,
      grade, not_worth} per venue; persist same in the candidates table.
    </p>
    <hr />
    <h3 id="fix-capsule-geocoding-vs-places-split-oct-8-2025">
      Fix Capsule ‚Äî Geocoding vs Places Split (Oct 8, 2025)
    </h3>
    <p>
      <strong>Impact</strong><br />
      Eliminates coordinate drift, removes zero-mile artifacts, and enforces the
      architectural rule: Google/DB only for location data. Places API is
      strictly for business metadata, not coordinates.
    </p>
    <p>
      <strong>When</strong><br />
      Venue resolution step before Routes API and Gemini validation. Runs during
      <code>/api/blocks</code> TRIAD Step 3/3 (venue enrichment).
    </p>
    <p>
      <strong>Why</strong><br />
      Enforces Invariant 6: Models never provide coords or hours; only Google
      (Geocoding/Places) and DB are sources of truth. Places was being misused
      to ‚Äúresolve‚Äù coordinates, causing drift and violating the architectural
      split of duties.
    </p>
    <p>
      <strong>How</strong><br />
      1. Created <code>geocoding.js</code> module with
      <code>reverseGeocode</code> (coords ‚Üí address + place_id) and
      <code>forwardGeocode</code> (address ‚Üí coords + place_id) 2. Updated
      <code>places-hours.js</code> to remove coordinates from
      <code>getFormattedHours</code> (hours/status ONLY) 3. Added
      <code>findPlaceIdByText</code> for name ‚Üí place_id resolution 4. Updated
      <code>blocks.js</code> resolution flow: - If venue has name:
      <code>findPlaceIdByText</code> ‚Üí place_id + coords + address - If venue
      has coords: <code>reverseGeocode</code> ‚Üí place_id + address - Then
      <code>getBusinessHoursOnly</code> for hours (no coords) - Then Routes API
      with validated coords 5. Added workflow gating: - No GPT until
      snapshot.lat/lng non-null - No GPT-5 until Claude strategy exists - No
      Gemini until all venues have place_id, lat, lng resolved
    </p>
    <p>
      <strong>Files Touched</strong><br />
      - <code>server/lib/geocoding.js</code> - NEW: Geocoding API wrapper
      (reverse/forward) - <code>server/lib/places-hours.js</code> - Updated:
      Remove coords from hours, add findPlaceIdByText -
      <code>server/routes/blocks.js</code> - Updated: DB-first ‚Üí
      Geocoding/Places ‚Üí Routes flow + workflow gating -
      <code>ARCHITECTURE.md</code> - Updated: Distance &amp; ETA section with
      split-of-duties documentation
    </p>
    <p>
      <strong>Tests and Acceptance</strong><br />
      1. Log shows ‚ÄúGeocode resolved ‚Ä¶ place_id=‚Ä¶‚Äù when GPT provided coords 2.
      Followed by ‚ÄúRoutes API ‚Ä¶ mi, ‚Ä¶ min‚Äù with validated coords 3. UI distance
      matches server (no 0.0 mi artifacts) 4. No venue has missing
      place_id/coords before Gemini call
    </p>
    <p>
      <strong>Observability</strong><br />
      Logs show: -
      <code>üó∫Ô∏è [Geocoding] Reverse geocoded (lat, lng) ‚Üí place_id: ...</code>
      - <code>üîç [Places API] Found place_id for "name": ...</code> -
      <code>‚úÖ Enriched ${name}: ${status}, ${hours}, address: ${address}</code>
      - Workflow gating logs: <code>‚ö†Ô∏è Origin coordinates not ready</code> or
      <code>‚ö†Ô∏è Strategy required for tactical planning</code>
    </p>
    <p>
      <strong>Back/Forward Pressure</strong><br />
      <strong>Backward:</strong> Places API no longer returns coordinates;
      getFormattedHours removed lat/lng fields.<br />
      <strong>Forward:</strong> All venue resolution uses Geocoding for coords,
      Places for hours only, DB for caching. Workflow gating prevents incomplete
      data propagation.
    </p>
    <hr />
    <h3 id="fix-capsule-atomic-database-persistence-oct-9-2025">
      Fix Capsule ‚Äî Atomic Database Persistence (Oct 9, 2025)
    </h3>
    <p>
      <strong>Impact</strong><br />
      Ensures ML training data integrity through atomic transactions. All
      rankings and candidates are now persisted together or not at all,
      eliminating partial writes that corrupt training datasets.
    </p>
    <p>
      <strong>What Changed</strong><br />
      - ‚úÖ <strong>PostgreSQL ACID Transactions</strong>: Implemented
      BEGIN/COMMIT/ROLLBACK pattern using pg.Client for atomic writes - ‚úÖ
      <strong>Fail-Hard Error Handling</strong>: Database persistence failures
      now return 502 instead of silent success - ‚úÖ
      <strong>Database Constraints</strong>: Added unique indexes on rank, check
      constraints for non-negative values, foreign key cascades - ‚úÖ
      <strong>Places Caching Architecture</strong>: Separated stable data
      (coords/address in <code>places</code>) from volatile data (hours in
      <code>places_cache</code>) - ‚úÖ <strong>Comprehensive Logging</strong>:
      Field-level visibility throughout workflow showing API calls, data
      transformations, and DB operations - ‚úÖ
      <strong>Correct Data Structure</strong>: persist-ranking.js now uses exact
      schema (no correlation_id in INSERT, uses fullyEnrichedVenues not old
      enriched array)
    </p>
    <p>
      <strong>When Applied</strong><br />
      Oct 9, 2025 - Database persistence layer refactored for production
      reliability
    </p>
    <p>
      <strong>Root Cause</strong><br />
      Non-atomic writes allowed partial data corruption: 672 rankings but only
      1,402 candidates (instead of 4,032), with all candidates having NULL
      distance/time/place_id values. Old code used separate INSERT statements
      without transaction boundaries.
    </p>
    <p>
      <strong>How Fixed</strong><br />
      1. <strong>Created <code>server/lib/persist-ranking.js</code></strong
      >: Single-transaction function using PostgreSQL client pool
      <code
        >javascript await client.query("BEGIN"); // Insert ranking // Insert all
        candidates in one batch await client.query("COMMIT");</code
      >
    </p>
    <ol start="2" type="1">
      <li>
        <p>
          <strong>Updated <code>server/routes/blocks.js</code></strong
          >: Fail-hard persistence with 502 on error
        </p>
        <div class="sourceCode" id="cb25">
          <pre
            class="sourceCode javascript"
          ><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  ranking_id <span class="op">=</span> <span class="cf">await</span> <span class="fu">persistRankingTx</span>({<span class="op">...</span>})<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (e) {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">502</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">ok</span><span class="op">:</span><span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span><span class="st">&quot;persist_failed&quot;</span> })<span class="op">;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
        </div>
      </li>
      <li>
        <p><strong>Added Database Constraints</strong> via migrations:</p>
        <ul>
          <li>
            <code>UNIQUE INDEX idx_rankings_snapshot_model</code> on
            (snapshot_id, model_name)
          </li>
          <li>
            <code>UNIQUE INDEX idx_ranking_candidates_rank</code> on
            (ranking_id, rank)
          </li>
          <li>
            <code>CHECK (distance_miles &gt;= 0)</code> and
            <code>CHECK (drive_time_minutes &gt;= 0)</code>
          </li>
          <li><code>ON DELETE CASCADE</code> for ranking_id foreign key</li>
        </ul>
      </li>
      <li>
        <p>
          <strong>Implemented Places Caching</strong>
          (<code>server/lib/places-cache.js</code>):
        </p>
        <ul>
          <li>
            <code>upsertPlace()</code>: Caches place_id, coords, address in
            <code>places</code> table
          </li>
          <li>
            <code>upsertPlaceHours()</code>: Caches business hours separately in
            <code>places_cache</code>
          </li>
          <li>Called after every Geocoding/Places API resolution</li>
        </ul>
      </li>
      <li>
        <p><strong>Added Comprehensive Logging</strong>:</p>
        <ul>
          <li>Every API call shows inputs/outputs with correlation_id</li>
          <li>Database operations log field values being written</li>
          <li>Transaction boundaries clearly marked (BEGIN/COMMIT/ROLLBACK)</li>
        </ul>
      </li>
    </ol>
    <p><strong>Verification SQL</strong></p>
    <div class="sourceCode" id="cb26">
      <pre
        class="sourceCode sql"
      ><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Check transaction integrity</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> r.ranking_id, <span class="fu">COUNT</span>(c.<span class="kw">id</span>) <span class="kw">as</span> candidates</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> rankings r</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> ranking_candidates c <span class="kw">ON</span> c.ranking_id <span class="op">=</span> r.ranking_id</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> r.ranking_id</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span> <span class="fu">COUNT</span>(c.<span class="kw">id</span>) <span class="op">!=</span> <span class="dv">6</span>;  <span class="co">-- Should return 0 rows</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Check data quality</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> ranking_candidates</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> distance_miles <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">OR</span> drive_time_minutes <span class="kw">IS</span> <span class="kw">NULL</span>;</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should return 0 for new data</span></span></code></pre>
    </div>
    <p>
      <strong>Files Changed</strong><br />
      - <code>server/lib/persist-ranking.js</code> - Atomic transaction
      implementation - <code>server/lib/places-cache.js</code> - NEW: Coordinate
      and hours caching - <code>server/routes/blocks.js</code> - Fail-hard
      persistence, uses fullyEnrichedVenues - <code>shared/schema.ts</code> -
      Added places and places_cache tables - Migration SQL - Constraints and
      indexes
    </p>
    <p>
      <strong>Observability</strong><br />
      Every transaction now logs: - üîê BEGIN/COMMIT/ROLLBACK status - üìù Exact
      SQL with field values - üìä Per-candidate details (name, place_id,
      distance, time, value_per_min, grade) - ‚úÖ/‚ùå Success/failure with
      correlation_id tracing
    </p>
    <p>
      <strong>Backward Pressure</strong><br />
      Deprecated: Non-atomic INSERT statements, silent persistence failures,
      partial data writes
    </p>
    <p>
      <strong>Forward Pressure</strong><br />
      Enforced: PostgreSQL transactions for all multi-row writes, fail-hard on
      DB errors, places caching for all venue resolutions
    </p>
    <hr />
    <h3 id="fix-capsule-ui-mapper-for-distanceeta-oct-8-2025">
      Fix Capsule ‚Äî UI Mapper for Distance/ETA (Oct 8, 2025)
    </h3>
    <p>
      <strong>Impact</strong><br />
      Eliminates 0.0 mi and 0 min artifacts in UI. Client now displays exact
      server-calculated distance and drive time from Routes API, never
      recalculating or dropping fields.
    </p>
    <p>
      <strong>When</strong><br />
      Frontend transformation of <code>/api/blocks</code> response in
      <code>client/src/pages/co-pilot.tsx</code> (lines 284-320).
    </p>
    <p>
      <strong>Why</strong><br />
      UI mapper was dropping critical fields
      (<code>estimated_distance_miles</code>, <code>driveTimeMinutes</code>,
      <code>distanceSource</code>, <code>value_per_min</code>,
      <code>value_grade</code>, <code>not_worth</code>, <code>surge</code>,
      <code>earnings_per_mile</code>) that server was sending. Raw API response
      had correct data but transformed blocks lost it, causing 0‚Äôs in UI.
    </p>
    <p>
      <strong>How</strong><br />
      Updated mapper to copy all server fields verbatim:
    </p>
    <div class="sourceCode" id="cb27">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// OLD (dropped distance/time fields):</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>blocks<span class="op">:</span> data<span class="op">.</span><span class="at">blocks</span><span class="op">?.</span><span class="fu">map</span>((block) <span class="kw">=&gt;</span> ({</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> block<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">estimatedWaitTime</span><span class="op">:</span> block<span class="op">.</span><span class="at">estimatedWaitTime</span><span class="op">,</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... missing distance, driveTime, value metrics</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">// NEW (preserves all fields):</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>blocks<span class="op">:</span> data<span class="op">.</span><span class="at">blocks</span><span class="op">?.</span><span class="fu">map</span>((v) <span class="kw">=&gt;</span> ({</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> v<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">placeId</span><span class="op">:</span> v<span class="op">.</span><span class="at">placeId</span><span class="op">,</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">coordinates</span><span class="op">:</span> { <span class="dt">lat</span><span class="op">:</span> v<span class="op">.</span><span class="at">coordinates</span><span class="op">?.</span><span class="at">lat</span> <span class="op">??</span> v<span class="op">.</span><span class="at">lat</span><span class="op">,</span> lng<span class="op">:</span> v<span class="op">.</span><span class="at">coordinates</span><span class="op">?.</span><span class="at">lng</span> <span class="op">??</span> v<span class="op">.</span><span class="at">lng</span> }<span class="op">,</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">estimated_distance_miles</span><span class="op">:</span> <span class="bu">Number</span>(v<span class="op">.</span><span class="at">estimated_distance_miles</span> <span class="op">??</span> v<span class="op">.</span><span class="at">distance</span> <span class="op">??</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">driveTimeMinutes</span><span class="op">:</span> <span class="bu">Number</span>(v<span class="op">.</span><span class="at">driveTimeMinutes</span> <span class="op">??</span> v<span class="op">.</span><span class="at">drive_time</span> <span class="op">??</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">distanceSource</span><span class="op">:</span> v<span class="op">.</span><span class="at">distanceSource</span> <span class="op">??</span> <span class="st">&quot;routes_api&quot;</span><span class="op">,</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">estimatedEarningsPerRide</span><span class="op">:</span> v<span class="op">.</span><span class="at">estimated_earnings</span> <span class="op">??</span> v<span class="op">.</span><span class="at">estimatedEarningsPerRide</span> <span class="op">??</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">earnings_per_mile</span><span class="op">:</span> v<span class="op">.</span><span class="at">earnings_per_mile</span> <span class="op">??</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value_per_min</span><span class="op">:</span> v<span class="op">.</span><span class="at">value_per_min</span> <span class="op">??</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value_grade</span><span class="op">:</span> v<span class="op">.</span><span class="at">value_grade</span> <span class="op">??</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">not_worth</span><span class="op">:</span> <span class="op">!!</span>v<span class="op">.</span><span class="at">not_worth</span><span class="op">,</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">surge</span><span class="op">:</span> v<span class="op">.</span><span class="at">surge</span> <span class="op">??</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... plus all other fields</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>}))</span></code></pre>
    </div>
    <p>
      <strong>Files Touched</strong><br />
      - <code>client/src/pages/co-pilot.tsx</code> - Fixed mapper to preserve
      distance/time/value fields
    </p>
    <p><strong>Tests and Acceptance</strong></p>
    <div class="sourceCode" id="cb28">
      <pre
        class="sourceCode bash"
      ><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run complete workflow analysis with validation:</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> scripts/full-workflow-analysis.mjs</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected validation output:</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># üî∑ STEP 4: VALIDATE FIRST VENUE (Routes API data)</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">#    üìç Name: &quot;...&quot;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">#    üÜî Place ID: ChIJ...</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">#    üìè Distance: 4.33 mi        # ‚Üê non-zero</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">#    ‚è±Ô∏è  Drive Time: 11 min       # ‚Üê non-zero</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">#    üì° Source: routes_api        # ‚Üê from Routes API</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">#    ‚úÖ VALIDATION PASSED: Distance and time are non-zero</span></span></code></pre>
    </div>
    <p>
      <strong>Observability</strong><br />
      Browser console logs now show: - <code>üîç Raw API response:</code> -
      server data (should have miles/minutes) -
      <code>üîÑ Transforming block:</code> - per-venue showing
      <code>estimated_distance_miles</code>, <code>driveTimeMinutes</code>,
      <code>distanceSource</code>, <code>value_per_min</code>,
      <code>value_grade</code> - <code>‚úÖ Transformed blocks:</code> - final
      data (should match raw)
    </p>
    <p>
      <strong>Back/Forward Pressure</strong><br />
      <strong>Backward:</strong> Removed field-dropping mapper logic.<br />
      <strong>Forward:</strong> All server distance/time/value fields flow
      through to UI; client never synthesizes or recalculates server metrics.
    </p>
    <hr />
    <h2 id="fix-capsule-coordinate-persistence-oct-9-2025">
      üîß <strong>FIX CAPSULE: Coordinate Persistence (Oct 9, 2025)</strong>
    </h2>
    <p>
      <strong>Issue:</strong> Venue coordinates were persisting as lat=0, lng=0
      in database instead of actual values.
    </p>
    <p>
      <strong>Symptoms:</strong> - Rankings and candidates tables showed 0,0
      coordinates for all venues - ML training data corrupted with invalid
      geospatial information - Workflow analysis showed correct coordinates in
      API responses but 0,0 in DB
    </p>
    <p>
      <strong>Root Cause:</strong> Database mapping in
      <code>server/routes/blocks.js</code> (lines 697-711) was missing lat/lng
      field extraction:
    </p>
    <div class="sourceCode" id="cb29">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// BEFORE (missing lat/lng):</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> venueForDB <span class="op">=</span> {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">place_id</span><span class="op">:</span> venue<span class="op">.</span><span class="at">placeId</span><span class="op">,</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> venue<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">address</span><span class="op">:</span> venue<span class="op">.</span><span class="at">address</span><span class="op">,</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">category</span><span class="op">:</span> venue<span class="op">.</span><span class="at">category</span><span class="op">,</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... lat/lng missing</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">estimated_distance_miles</span><span class="op">:</span> <span class="bu">Number</span>(venue<span class="op">.</span><span class="at">estimated_distance_miles</span> <span class="op">??</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">drive_time_minutes</span><span class="op">:</span> <span class="bu">Number</span>(venue<span class="op">.</span><span class="at">driveTimeMinutes</span> <span class="op">??</span> <span class="dv">0</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">// AFTER (includes coordinates):</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> venueForDB <span class="op">=</span> {</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">place_id</span><span class="op">:</span> venue<span class="op">.</span><span class="at">placeId</span><span class="op">,</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> venue<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">address</span><span class="op">:</span> venue<span class="op">.</span><span class="at">address</span><span class="op">,</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">category</span><span class="op">:</span> venue<span class="op">.</span><span class="at">category</span><span class="op">,</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">lat</span><span class="op">:</span> venue<span class="op">.</span><span class="at">lat</span><span class="op">,</span>                    <span class="co">// ‚Üê Added</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">lng</span><span class="op">:</span> venue<span class="op">.</span><span class="at">lng</span><span class="op">,</span>                    <span class="co">// ‚Üê Added</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">estimated_distance_miles</span><span class="op">:</span> <span class="bu">Number</span>(venue<span class="op">.</span><span class="at">estimated_distance_miles</span> <span class="op">??</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">drive_time_minutes</span><span class="op">:</span> <span class="bu">Number</span>(venue<span class="op">.</span><span class="at">driveTimeMinutes</span> <span class="op">??</span> <span class="dv">0</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre>
    </div>
    <p>
      <strong>Fix Strategy:</strong> 1. Added <code>lat: venue.lat</code> and
      <code>lng: venue.lng</code> to venue mapper 2. Removed complex fallback
      chain from persist-ranking.js (simplified to direct access) 3. Verified
      coordinates are already properly set in venue objects from enrichment
      stage
    </p>
    <p><strong>Verification:</strong></p>
    <div class="sourceCode" id="cb30">
      <pre
        class="sourceCode bash"
      ><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Database query confirms fix:</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">SELECT</span> place_id, name, lat, lng FROM ranking_candidates WHERE ranking_id = <span class="st">&#39;...&#39;</span><span class="kw">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Before: lat=0, lng=0</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># After:  lat=33.1106, lng=-96.8283 (actual coordinates)</span></span></code></pre>
    </div>
    <p>
      <strong>Files Changed:</strong> - <code>server/routes/blocks.js</code> -
      Added lat/lng to venue mapping (lines 705-706) -
      <code>server/lib/persist-ranking.js</code> - Simplified coordinate
      extraction
    </p>
    <p>
      <strong>Architectural Insight:</strong> - Coordinates are already correct
      in venue objects from enrichment stage - Issue was purely in DB mapping
      layer, not data flow - Demonstrates importance of field-level logging to
      catch silent data loss
    </p>
    <p><strong>Testing Protocol:</strong></p>
    <div class="sourceCode" id="cb31">
      <pre
        class="sourceCode bash"
      ><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> scripts/full-workflow-analysis.mjs</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Validates coordinates persist correctly end-to-end</span></span></code></pre>
    </div>
    <hr />
    <h3 id="fix-capsule-per-ranking-feedback-system-oct-9-2025">
      Fix Capsule ‚Äî Per-Ranking Feedback System (Oct 9, 2025)
    </h3>
    <p>
      <strong>Impact</strong><br />
      Drivers can now provide thumbs up/down feedback on both individual venues
      and the overall strategy, creating a continuous learning loop to improve
      future recommendations.
    </p>
    <p>
      <strong>Problem</strong><br />
      No mechanism existed for drivers to quickly signal which venues were
      successful or unsuccessful, making it impossible to incorporate real-world
      driver feedback into ML training data and venue reliability scores.
    </p>
    <p>
      <strong>Solution Architecture</strong><br />
      1. <strong>Database Schema (PostgreSQL)</strong> -
      <code>venue_feedback</code> table: user_id, snapshot_id, ranking_id,
      place_id, venue_name, sentiment (‚Äòup‚Äô/‚Äòdown‚Äô), comment -
      <code>strategy_feedback</code> table: Same structure minus
      place_id/venue_name - Unique constraints: One vote per user per venue per
      ranking (upserts allowed) - Indexes: ranking_id, place_id for fast
      aggregation
    </p>
    <ol start="2" type="1">
      <li>
        <strong>API Endpoints</strong>
        <ul>
          <li>
            <code>POST /api/feedback/venue</code> - Record/update venue feedback
            with rate limiting (10/min/user)
          </li>
          <li>
            <code>GET /api/feedback/venue/summary?ranking_id=&lt;UUID&gt;</code>
            - Get aggregated counts per venue
          </li>
          <li>
            <code>POST /api/feedback/strategy</code> - Record/update
            strategy-level feedback
          </li>
        </ul>
      </li>
      <li>
        <strong>Blocks Enrichment (Non-Blocking)</strong>
        <ul>
          <li>Query feedback counts after ranking persistence</li>
          <li>Left join with feedback aggregates grouped by place_id</li>
          <li>
            Attach <code>up_count</code> and <code>down_count</code> to each
            block
          </li>
          <li>
            Graceful degradation: If feedback query fails, blocks still return
            with counts=0
          </li>
        </ul>
      </li>
      <li>
        <strong>UI Components</strong>
        <ul>
          <li>Replaced Like/Hide buttons with üëç/üëé buttons showing counts</li>
          <li>
            <code>FeedbackModal</code> component: sentiment selection + optional
            comment (max 1000 chars)
          </li>
          <li>
            Strategy header: ‚ÄúGive feedback‚Äù button opens strategy feedback
            modal
          </li>
          <li>
            Optimistic UI updates: Increment counts locally on successful
            submission
          </li>
        </ul>
      </li>
    </ol>
    <p>
      <strong>Security &amp; Safety</strong><br />
      - Rate limiting: 10 requests per minute per user_id (429 on exceed) -
      Comment sanitization: Strip HTML, max 1000 characters - Validate
      sentiment: Only ‚Äòup‚Äô or ‚Äòdown‚Äô accepted - Actions logging: Optional
      instrumentation for analytics
    </p>
    <p><strong>Observability</strong></p>
    <pre><code>[feedback] upsert ok {corr:&lt;id&gt;, user:&lt;uuid&gt;, ranking:&lt;uuid&gt;, place:&lt;id|null&gt;, sent:&#39;up&#39;}
[feedback] summary {ranking:&lt;uuid&gt;, rows:&lt;n&gt;}
üìä [correlationId] Feedback enrichment: 3 venues with feedback</code></pre>
    <p>
      <strong>No Regressions</strong><br />
      - Origin gating: Unchanged (device GPS ‚Üí snapshot) -
      Geocoding/Places/Routes: Duties unchanged - Distance/time/earnings: Blocks
      payload unchanged except added counts - ACID persistence: Rankings +
      candidates transaction still atomic - Triad pipeline: Zero changes to
      model routing or prompt flow
    </p>
    <p>
      <strong>Files Changed</strong><br />
      - <code>shared/schema.js</code> - Added venue_feedback &amp;
      strategy_feedback tables - <code>server/routes/feedback.js</code> - New
      endpoints with rate limiting &amp; sanitization -
      <code>server/routes/blocks.js</code> - Added feedback enrichment query
      (non-blocking) - <code>client/src/components/FeedbackModal.tsx</code> -
      Reusable feedback modal component -
      <code>client/src/pages/co-pilot.tsx</code> - Thumbs up/down buttons +
      modals
    </p>
    <p>
      <strong>Exit Criteria (All Passed)</strong><br />
      ‚úÖ DB migration: Tables + indexes created<br />
      ‚úÖ POST endpoints: Return 200 {ok:true}, upsert behavior verified<br />
      ‚úÖ GET summary: Returns counts per venue for ranking_id<br />
      ‚úÖ Blocks enrichment: up_count/down_count present on cards (‚â•0)<br />
      ‚úÖ UI: Thumbs buttons functional, modal submits, counts update<br />
      ‚úÖ Strategy feedback: ‚ÄúGive feedback‚Äù link works, POSTs successfully<br />
      ‚úÖ No regressions: Snapshot gating, ACID persistence, triad flow intact
    </p>
    <hr />
    <h2 id="decision-log">üéØ <strong>DECISION LOG</strong></h2>
    <h3 id="october-9-2025">October 9, 2025</h3>
    <ul>
      <li>
        ‚úÖ <strong>Implemented:</strong> Per-ranking feedback system for venues
        and strategy
        <ul>
          <li>
            Database: venue_feedback &amp; strategy_feedback tables with unique
            constraints
          </li>
          <li>
            API: POST /api/feedback/venue, POST /api/feedback/strategy with rate
            limiting (10/min/user)
          </li>
          <li>
            Enrichment: Non-blocking feedback counts query in /api/blocks
            (up_count, down_count)
          </li>
          <li>
            UI: Thumbs up/down buttons with modal, strategy feedback link,
            optimistic updates
          </li>
          <li>
            Security: Rate limiting, HTML sanitization, comment length
            validation
          </li>
          <li>
            Impact: Creates learning loop for ML training and venue reliability
            scoring
          </li>
        </ul>
      </li>
      <li>
        ‚úÖ <strong>Fixed:</strong> Coordinate persistence in database (rankings
        + candidates atomic writes)
        <ul>
          <li>
            Root cause: Venue mapping for DB persistence was missing lat/lng
            fields
          </li>
          <li>
            Solution: Added <code>lat: venue.lat</code> and
            <code>lng: venue.lng</code> to venue mapper in blocks.js
          </li>
          <li>
            Impact: All venue coordinates now correctly persisted (no more 0,0
            values)
          </li>
          <li>
            Verification: Database query shows actual coordinates (e.g.,
            33.1106, -96.8283)
          </li>
        </ul>
      </li>
      <li>
        ‚úÖ <strong>Configured:</strong> Replit Autoscale deployment for
        production
        <ul>
          <li>
            Port binding: Uses <code>process.env.PORT</code> for Autoscale
            compatibility
          </li>
          <li>Build command: <code>npm run build</code> (clean Vite build)</li>
          <li>Run command: <code>npm start</code> (NODE_ENV=production)</li>
          <li>
            Error handling: Try-catch around server.listen() with detailed
            logging
          </li>
          <li>Startup logs: Shows mode, port config, and health status</li>
        </ul>
      </li>
      <li>
        ‚úÖ <strong>Cleaned:</strong> Removed stale TODO comments (places cache
        already implemented)
      </li>
      <li>
        ‚úÖ <strong>Removed:</strong> Stale ‚Äúorigin fallback‚Äù comment per
        architectural requirements
      </li>
    </ul>
    <h3 id="october-8-2025">October 8, 2025</h3>
    <ul>
      <li>
        ‚úÖ <strong>Verified:</strong> Claude Sonnet 4.5 model works correctly
        (no silent swaps)
      </li>
      <li>
        ‚úÖ <strong>Added:</strong> Model assertion in adapter to prevent future
        mismatches
      </li>
      <li>
        ‚úÖ <strong>Implemented:</strong> Thread-aware context system for
        Agent/Assistant/Eidolon
      </li>
      <li>
        ‚úÖ <strong>Updated:</strong> All documentation to reflect verified model
        state
      </li>
      <li>
        ‚úÖ <strong>Set:</strong>
        <code>ANTHROPIC_API_VERSION=2023-06-01</code> in environment
      </li>
    </ul>
    <h3 id="october-7-2025">October 7, 2025</h3>
    <ul>
      <li>
        ‚úÖ <strong>Removed:</strong> React.StrictMode (double-rendering causing
        abort errors)
      </li>
      <li>
        ‚úÖ <strong>Removed:</strong> Global JSON body parsing (causing abort on
        client cancellation)
      </li>
      <li>‚úÖ <strong>Added:</strong> Per-route JSON parsing with 1MB limit</li>
      <li>‚úÖ <strong>Added:</strong> Client abort error gate (499 status)</li>
      <li>‚úÖ <strong>Added:</strong> Health check logging filter</li>
    </ul>
    <h3 id="october-3-2025">October 3, 2025</h3>
    <ul>
      <li>
        ‚úÖ <strong>Implemented:</strong> Router V2 with proper cancellation
      </li>
      <li>
        ‚úÖ <strong>Fixed:</strong> Circuit breaker poisoning from aborted
        requests
      </li>
      <li>
        ‚úÖ <strong>Increased:</strong> Budget from 8s to 90s (production needs)
      </li>
      <li>
        ‚ö†Ô∏è <strong>Discovered:</strong> Anthropic model 404 issue (resolved Oct
        8)
      </li>
    </ul>
    <hr />
    <h2 id="critical-constraints-summary">
      üö® <strong>CRITICAL CONSTRAINTS SUMMARY</strong>
    </h2>
    <ol type="1">
      <li>
        <strong>Single-Path Triad</strong> - No fallbacks, fail properly instead
        of degrading
      </li>
      <li><strong>Zero Hardcoding</strong> - All data from DB or env vars</li>
      <li>
        <strong>Never Suppress Errors</strong> - Surface failures with full
        context
      </li>
      <li>
        <strong>Complete Snapshots Only</strong> - Never send partial data to
        LLMs
      </li>
      <li>
        <strong>Model ID Stability</strong> - Pin exact IDs, verify monthly
      </li>
      <li>
        <strong>Partner Namespace Separation</strong> - Don‚Äôt mix Vertex/Bedrock
        IDs with native APIs
      </li>
      <li>
        <strong>Database Schema Immutability</strong> - Never change PK types
      </li>
      <li>
        <strong>Trust-First Stack</strong> - Curated catalog + deterministic
        scoring (no hallucinations)
      </li>
      <li>
        <strong>Port 5000 Requirement</strong> - Replit firewall constraint
      </li>
      <li><strong>Per-Route JSON Parsing</strong> - No global body parser</li>
    </ol>
    <hr />
    <p>
      <strong
        >This document is the authoritative reference for all architectural
        decisions. When in doubt, refer to these constraints to prevent rework
        and maintain alignment in fast-moving AI-driven development.</strong
      >
    </p>
  </body>
</html>
<style media="print">
  @page {
    margin: 1in;
  }
  body {
    max-width: 100%;
  }
  h1,
  h2,
  h3 {
    page-break-after: avoid;
  }
  pre,
  table {
    page-break-inside: avoid;
  }
  .toc {
    page-break-after: always;
  }
</style>
