# Vecto Pilotâ„¢ - Rideshare Intelligence Platform

## Overview
Vecto Pilot is an AI-powered rideshare intelligence platform designed to maximize rideshare driver earnings. It provides real-time, data-driven strategic briefings by integrating diverse data sources (location, events, traffic, weather, air quality) and leveraging advanced AI and data analytics to generate actionable strategies for drivers. The platform aims to help rideshare drivers earn more in less time with transparent guidance, with ambitions for continuous expansion to new markets and improved quality of life for individuals.

## User Preferences
Preferred communication style: Simple, everyday language. Do not say "done" until features are actually verified working.

## System Architecture
Vecto Pilot is a full-stack Node.js application with a multi-service architecture (Gateway, SDK, Agent servers), supporting both monolithic and split deployments.

**UI/UX Decisions**:
The frontend is a React + TypeScript Single Page Application (SPA), built with Vite, utilizing Radix UI, TailwindCSS, and React Query. Key features include a Strategy Section, Smart Blocks for venue recommendations, an AI Strategy Coach with hands-free voice chat, and a Rideshare Briefing Tab with immutable strategy history. A new ML-focused bars and premium venues table has been added to the Venues tab for structured data capture.

**Technical Implementations**:
- **Briefing Generation**: All AI calls now use `gemini-3-pro-preview` with Google tools for consistent web search reliability. Briefing data sources populate with real Gemini API data using **split cache strategy**:
  - **Daily Briefing** (news, events, closures, construction): 24-hour cache (runs once/day)
  - **Traffic**: Always refreshes on app open or manual refresh (0 cache TTL)
  - This allows comprehensive daily research for news/events while keeping traffic conditions live throughout the day
- **Strategy Split Architecture (NEW)**: Consolidated Gemini strategy now splits into two tab-specific strategies:
  - **Daily Strategy** (Briefing Tab): Full consolidated daily briefing from Gemini 3 Pro Preview with traffic, events, closures, and strategic context. Displays under "Daily Strategy Overview" section.
  - **Right Now Strategy** (Strategy Tab): Immediate tactical guidance generated by GPT-5.2 using consolidated output + location. Focused on "next 1 hour" actions for maximum earnings. Uses `reasoning.effort: "medium"` per MODEL.md specs.
  - Both stored in `strategies` table: `consolidated_strategy` (daily) and `strategy_for_now` (immediate)
- **SmartBlocks**: SmartBlocks race condition (limbo state) fixed with Just-In-Time generation in GET endpoint Gate 2. System now detects "strategy complete but rankings missing" and auto-triggers block generation during polling.
- **Strategy Loader**: Dynamic progress bar with real-time strategy steps. Shows Phase 1 (Strategy Analysis: 0-30%) and Phase 2 (Venue Discovery: 30-100%) with granular sub-steps during block generation (fetching, calculating distance/drive time, finalizing).
- **AI Coach**: The AI Strategy Coach uses `gemini-3-pro-preview` for conversational assistance with rideshare strategy, venue interpretation, and file analysis. Note: Web search tool was attempted but causes API timeouts - coach uses Vecto Pilot's data sources (briefing, events, traffic) for instant responses instead. Coach timeout increased to 90 seconds for any future web search attempts.
- **Data Flow Consistency**: All data flows follow a three-phase pattern: Fetch, Resolve, and Return, ensuring data consistency, validation, and proper formatting.
- **GPS Location Behavior**: Location refresh is manual only, requesting fresh permissions (`maximumAge: 0`) upon opening or manual trigger.
- **localStorage Behavior**: Strategy data clears on app mount to show fresh loading states for both consolidated and immediate strategies. Both states reset on new snapshot detection.
- **Coords Cache (NEW)**: Global lookup table (`coords_cache`) caches geocode/timezone data by coordinate hash to eliminate duplicate API calls:
  - Cache key: 4 decimal places (~11m precision) for matching similar locations
  - Storage: 6 decimal places (~11cm precision) for accurate data
  - On cache hit: Skip Google Geocode/Timezone APIs, use cached city/state/timezone/formatted_address
  - On cache miss: Call APIs, store complete result for future lookups
  - Tracks hit_count for cache utilization analytics

**Feature Specifications**:
- **Briefing Data**: Includes real-time traffic analysis, AI-curated local rideshare news, local events with venues/times, concerts, and school closures.
- **Smart Blocks**: Provide 5 venue recommendations per strategy, displaying venue name, address, distance, drive time, value per minute, grade, and pro tips.
- **Bars & Premium Venues Table**: Displays filtered SmartBlocks for bars, including business hours for ML training.

**System Design Choices**:
- **Core Services**: Gateway Server, SDK Server, Agent Server.
- **Memory Systems & Data Isolation**: Assistant (user preferences), Eidolon (project/session state with snapshots), Agent Memory (agent service state). All are scoped by `user_id` and secured with JWT.
- **AI Configuration**: Role-based architecture using configurable AI models for event-driven strategy generation:
  - **Strategist**: Claude Sonnet 4.5 for strategic overview (minstrategy)
  - **Briefer**: Gemini 3 Pro Preview for Type A briefing data (news, events, traffic, weather, closures)
  - **Consolidator**: Gemini 3 Pro Preview as "Tactical Dispatcher" - receives RAW JSON from briefings table (traffic_conditions, events, news, weather_current, school_closures) + full snapshot + minstrategy. Passes labeled JSON sections directly to Gemini (CURRENT_TRAFFIC_DATA, CURRENT_EVENTS_DATA, etc.) so strategy can reference specific details like "Eastbound Main St closed". Also calls GPT-5.2 post-consolidation for immediate strategy.
  - **Immediate Strategy Generator**: GPT-5.2 generates "right now" tactical guidance (next 1 hour) using consolidated strategy output + formatted location + timestamp. Uses `reasoning: {effort: "medium"}` and `max_completion_tokens: 500`.
  - **Holiday Checker**: Perplexity for holiday detection
- **Data Storage**: PostgreSQL Database (Replit managed) with Drizzle ORM stores snapshots, strategies, venue events, and ML training data using unique indexes and JSONB.
- **Architecture Pattern - Snapshots as Central Connector for ML**: Snapshots act as the authoritative connector across all data sources, enabling machine learning and analytics by linking all enrichments (strategies, briefings, rankings, actions, venue feedback) to a `snapshot_id`.
- **Authentication & Security**: JWT with RS256 Asymmetric Keys and security middleware for rate limiting, CORS, Helmet.js, path traversal protection, and file size limits.
- **Deployment & Reliability**: Supports Mono Mode and Split Mode, featuring health-gated entry points, unified port binding, proxy gating, WebSocket protection, and process discipline.
- **Data Architecture - Precise Location Denormalization Pattern**: Every table referencing `snapshot_id` also stores resolved precise location data (formatted_address, city, state) for fast queries, relational consistency, and ML training without joins.

## External Dependencies

### Third-Party APIs
-   **AI & Research**: Anthropic (Claude Sonnet 4.5), OpenAI (GPT-5.2 for immediate strategy generation, Realtime API for voice), Google (Gemini 3.0 Pro Preview with Web Search for briefing + consolidation), Perplexity (holiday detection).
-   **DEPRECATED**: GPT-5.2 consolidation removed - replaced by Gemini 3 Pro Preview Tactical Dispatcher. GPT-5.2 now used only for immediate "right now" strategy generation.
-   **Voice Chat**: OpenAI Realtime API.
-   **Location & Mapping**: Google Places API, Google Routes API, Google Geocoding API, Google Timezone API.
-   **Weather**: Google Weather API.
-   **Air Quality**: Google Air Quality API.

### Database
-   **PostgreSQL (Replit Built-in)**: Primary data store, managed by Drizzle ORM.

### Infrastructure
-   **Replit Platform**: Deployment and Nix environment.

### Frontend Libraries
-   **UI Components**: Radix UI, Chart.js.
-   **State Management**: React Query, React Context API.
-   **Development Tools**: Vite, ESLint, TypeScript, PostCSS, TailwindCSS.